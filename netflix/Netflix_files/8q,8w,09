C.r("aS",function(t,e,i){"use strict";var n=t("bo"),a=n(t("bk")),o=t("aW"),s=t("aU"),r=t("b6"),l=t("aV"),c=t("aY"),d=t("aX"),p=t("pZ"),u=t("e-"),m=t("kb"),h=t("pi"),g=t("iz"),E=t("eV"),f=t("7f"),T=t("wA"),b=t("yr"),x=t("yO"),y=t("y-"),S=t("z9"),C=t("zd"),P=t("zr"),A=t("z6"),v=t("AR"),k=t("zx"),N=t("yy"),I=t("zz"),D=t("BP"),_=t("C0"),V=t("4_"),M=t("Dj"),L=t("1u"),w=t("90"),R=t("wt"),U=t("Cs"),O=t("Bt"),K=t("iy"),X={MDX_POSTPLAY_STATE:"mdx-postplay-state",MDX_PLAY_STATE:"mdx-play-state",MDX_CONNECTED_STATE:"mdx-connected-state",MDX_DISCONNECTED_STATE:"mdx-disconnected-state",MDX_PLAYBACK_UNAVAILABLE:"mdx-playback-unavailable"},B="discovery/akira/Mdx",Y=K("player/player","button.audio.subtitles"),z=K(B,"mdx-postplay-status"),q=K(B,"mdx2-description-loading"),j=K(B,"mdx2-description-paused"),H=K(B,"mdx2-description-playing"),W=K(B,"mdx-loading-show-title"),F=K(B,"mdx-device-connected"),G=K(B,"mdx-device-connected-instruction"),Z=K(B,"mdx-playback-unavailable-branching-watch-here"),J=K(B,"mdx-playback-unavailable-branching-cancel"),Q=K(B,"mdx-playback-unavailable-branching-title"),$=K(B,"mdx-playback-unavailable-branching-message"),tt=u({displayName:"MdxControls",getInitialState:function(){return{staticConfiguration:D({geo:this.context.getModelData("geo"),browserInfo:this.context.getModelData("browserInfo"),loggingPlayerType:"mdx",playbackSupport:this.context.getModelData("playerModel","playbackSupport")})}},childContextTypes:{staticConfiguration:O},getChildContext:function(){return{staticConfiguration:this.state.staticConfiguration}},shouldComponentUpdate:M.pureRender,contextTypes:{playerApp:m.object.isRequired,getModelData:m.func.isRequired,history:m.object.isRequired,isKidsPage:m.bool,models:m.object.isRequired,routeHandler:m.object.isRequired,formatString:m.func.isRequired},componentWillReceiveProps:function(t){var e=this.context.playerApp,i=this.props,n=i.mdxTarget,a=i.initParams,o=g.get(a,"pinConfig.isAdultVerified",!0),s=g.get(a,"pinConfig.isEnabled",!0),r=!e.getAPI().playerApp.isPinSessionExpired();o&&!s||t.adultVerification||"boolean"!=typeof t.adultVerification||(r||!t.isPinProtected&&"boolean"==typeof t.isPinProtected)&&(t.isPinProtected&&!r&&t.adultVerification||n.resumeCast())},onClick:function(t){"INPUT"!==t.target.nodeName&&h.findDOMNode(this).focus()},onPlayClick:function(t){this.props.paused?this.props.mdxTarget.play():this.props.mdxTarget.pause()},getTargetId:function(){return g.get(this,"props.ancestorSummary.id",g.get(this,"props.videoSummary.id"))},onStatusClick:function(){var t=this.getTargetId();t&&(this.context.history.pushState(f.getTitleRoute(this.context.models,this.context.isKidsPage).makePath({id:t})),window.scrollTo(0,0))},onEpisodesClick:function(){var t=this.getTargetId(),e=this.props,i=e.mdxTarget,n=e.mdxManager,a=this.context.routeHandler,o=a.route===U.title,s=o&&a.params&&a.params.id?parseInt(a.params.id,10):void 0,r=o&&t&&s&&!isNaN(s)&&s!==t;!o||r?(window.scrollTo(0,0),this.context.history.pushState(f.getTitleRoute(this.context.models,this.context.isKidsPage).makePath({id:t},{tab:"episodes"}))):i&&n&&(window.scrollTo(0,0),n.emit(n.EVENTS.SHOW_EPISODES))},onStopClick:function(){this.props.mdxTarget.stop()},onPostplayClick:function(){this.props.mdxTarget.cast(this.props.nextVideoId,this.props.trackId,!1,{})},setAudioTrack:function(t){this.props.mdxTarget.setAudioTrack(t)},setSubtitleTrack:function(t){this.props.mdxTarget.setTimedTextTrack(t)},componentDidMount:function(){h.findDOMNode(this).focus()},getStatusString:function(){var t,e=this.props.mdxTarget;if(g.isNumber(this.props.nextVideoId))t=this.context.formatString(z,{DEVICE_NAME:this.props.deviceName});else switch(this.props.currentState){case e.DEVICE_STATES.PLAY:case e.DEVICE_STATES.PROGRESS:t=this.context.formatString(q,{DEVICE_NAME:this.props.deviceName});break;case e.DEVICE_STATES.PAUSE:t=this.context.formatString(j,{DEVICE_NAME:this.props.deviceName});break;case e.DEVICE_STATES.PLAYING:default:t=this.context.formatString(H,{DEVICE_NAME:this.props.deviceName})}return t+" "},isEpisodic:function(){var t=this.props.videoSummary;return t&&"episode"===t.type},getTitleString:function(t){var e=this.props,i=e.videoSummary,n=e.videoTitle,a=e.nextVideoTitle,o=e.nextVideoSummary,s=e.ancestorTitle,r=this.isEpisodic(),l=null;if(r&&s){var c,d,p;o?(c=o.episode,d=o.season,p=a):i&&(c=i.episode,d=i.season,p=n);l=s+" "+this.context.formatString(W,{SEASON:d,EPISODE:c,TITLE:p})}else(a||n)&&(l=a||n);return l},getNFPlayerNode:function(){return h.findDOMNode(this)},onValidPin:function(){this.props.mdxTarget.validPin()},onPinCancel:function(){this.props.mdxTarget.cancelPin()},onAgeVerifyCancel:function(){this.props.mdxTarget.resetCurrentContentId()},handleWatchLocal:function(){var t=this.props,e=t.mdxTarget,i=t.unavailableVideoId,n=t.unavailableTrackId;e&&i&&e.disconnect(function(t){t||(window.location=U.watchNow.makePath({id:i},{trkid:n||0}))})},handleCancelUnavailablePlayback:function(){this.props.mdxTarget&&this.props.mdxTarget.clearUnavailablePlayback()},renderAudioSubtitleButton:function(t){return this.props.audioList.length>0||this.props.subtitleList>0?p.createElement(C,(0,a.default)({},t,{ariaLabel:this.context.formatString(Y),iconName:"nfplayerSubtitles",focusName:N.AUDIO_SUBTITLE,popupHasStaticPosition:!0,positionedAtTop:!0}),p.createElement(x,(0,a.default)({},t,{setAudioTrack:this.setAudioTrack,setSubtitleTrack:this.setSubtitleTrack,audioList:this.props.audioList,subtitleList:this.props.subtitleList}))):null},renderStatus:function(){var t=this.getTitleString();return t?p.createElement(o,{onClick:this.onStatusClick,status:this.getStatusString(),title:t}):null},renderPrompts:function(){var t=this.context.playerApp,e=this.props,i=e.initParams,n=e.adultVerification,a=e.showPinEntry,o=e.isPinProtected,s=g.get(i,"pinConfig.isAdultVerified",!0),r=g.get(i,"pinConfig.isEnabled",!0),l=!t.getAPI().playerApp.isPinSessionExpired();return!s&&n?p.createElement(w,null,p.createElement(R,{isRTL:this.state.staticConfiguration.isRTL,videoId:this.props.contentId,adultVerificationURL:g.get(this,"props.initParams.pinConfig.adultVerificationUrl",U.verifyAge.makePath()),onCancel:this.onAgeVerifyCancel})):a||r&&o&&!l?p.createElement(w,null,p.createElement(T,{onValidPinEntry:this.onValidPin,onCancel:this.onPinCancel,apiEndpoint:this.props.initParams.pinConfig.apiEndpoint,resetURL:this.props.initParams.pinConfig.resetUrl})):null},renderControls:function(t){var e=this.isEpisodic();return p.createElement("div",{key:"mdx-controls",className:"controls"},p.createElement("div",{ref:"controlsContainer",className:E({"main-controls":!0,active:this.props.isActive,inactive:!this.props.isActive})},this.renderStatus(),p.createElement(s,{inPostplay:this.props.inPostplay,onClick:this.onPostplayClick}),p.createElement("div",{className:E("controls-container","bottom-controls")},p.createElement(S,(0,a.default)({},t,{onClick:this.onPlayClick})),p.createElement(c,t),p.createElement(P,(0,a.default)({},t,{onClick:this.onStopClick})),p.createElement(l,(0,a.default)({},t,{buffered:this.props.runtime,duration:this.props.runtime})),p.createElement(d,(0,a.default)({},t,{duration:this.props.runtime})),e&&p.createElement(y,(0,a.default)({},t,{onClick:this.onEpisodesClick})),this.renderAudioSubtitleButton(t),p.createElement(A,(0,a.default)({},t,{connected:!0,videoId:this.props.contentId}))),this.renderPrompts()))},renderDefaultStatus:function(){var t=this.context.formatString(F,{DEVICE_NAME:this.props.deviceName}),e=this.context.formatString(G);return p.createElement("div",{key:"mdx-connected-status",className:"controls connected-status"},p.createElement("h3",null,t),p.createElement("h4",null,e))},renderPlaybackUnavailableStatus:function(){var t=this.context.formatString(Z),e=this.context.formatString(J);return p.createElement("div",{key:"mdx-playback-unavailabe",className:"controls connected-status"},p.createElement("h3",{className:"mdx-playback-unavailable-title"},this.context.formatString(Q)),p.createElement("h4",{className:"mdx-playback-unavailable-message"},this.context.formatString($)),p.createElement("div",{className:"mdx-controls-actions-container"},p.createElement("button",{"aria-label":t,type:"button",tabIndex:0,className:"MdxControls__button MdxControls__button--primary",onClick:this.handleWatchLocal},t),p.createElement("button",{"aria-label":e,type:"button",tabIndex:0,className:"MdxControls__button",onClick:this.handleCancelUnavailablePlayback},e)))},onKeyDown:function(t){_(t,{allowManualLogging:this.props.allowManualLogging,currentScrubTime:-1,disableKeyHandler:{},ended:this.props.ended,logKeyDownEvent:this.props.logKeyDownEvent,playbackTimedOut:!1,playerElement:this.getNFPlayerNode(),playerInstance:this.props.mdxTarget,scrubbing:this.props.scrubbing,setKeepActive:g.noop,started:this.props.started})},render:function(){var t,e,i=g.assign({onClick:g.noop,player:this.props.mdxTarget,setKeepActive:g.noop,uiState:b.ACTIVE},this.props);return this.props.connected?i.playbackUnavailableReason?(t=this.renderPlaybackUnavailableStatus(),e=X.MDX_PLAYBACK_UNAVAILABLE):this.props.contentId||this.props.showPinEntry?(t=this.renderControls(i),e=this.props.inPostplay?X.MDX_POSTPLAY_STATE:X.MDX_PLAY_STATE):(t=this.renderDefaultStatus(),e=X.MDX_CONNECTED_STATE):(t=null,e=X.MDX_DISCONNECTED_STATE),p.createElement("div",{className:E("mdx-controls-bar-container",e),tabIndex:-1,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onClick:this.onClick},v(this.context.models),p.createElement(V,{component:"div",transitionName:"mdx-controls-trans",transitionAppear:!0,enterTimeout:r.TRANSITION_DURATION,leaveTimeout:r.TRANSITION_DURATION},t))}});e.exports=I(L(k(tt)))});C.r("aU",function(t,e,n){"use strict";var o=t("pZ"),r=t("e-"),a=t("kb"),s=t("eV"),p=t("iy"),i=t("dq"),l=i.SVGIcon,c=t("Dj"),d=p("discovery/akira/Mdx","mdx-postplay-prompt"),m=r({displayName:"MdxPostplay",contextTypes:{formatString:a.func.isRequired},shouldComponentUpdate:c.pureRender,render:function(){var t=this.props.inPostplay?o.createElement("button",{className:"MdxControls__button MdxControls__button--primary",onClick:this.props.onClick},o.createElement(l,{name:"nfplayerPlay"}),this.context.formatString(d)):null;return o.createElement("div",{className:s("mdx-postplay-container",{"mdx-postplay-showing":this.props.inPostplay})},t)}});e.exports=m});C.r("aV",function(r,e,t){"use strict";var o=r("pZ"),n=r("e-"),s=r("kb"),i=r("pi"),a=(r("iz"),r("eV")),c=r("z4"),u=r("8B"),p=r("C7"),l=r("Dj"),d=r("yr"),h=r("yy"),S=(s.bool,s.func,s.number,s.object,s.oneOf,n({displayName:"ProgressBar",statics:{CONTROL_NAME:h.PROGRESS_BAR},shouldComponentUpdate:l.partialProps(["controlFocusState","duration","currentTime","buffered","player","playerDimensions","uiState"]),handleMouseEnter:function(r){var e=this.props,t=e.controlFocusActions,o=e.onPointerEnter;t.startHover(h.PROGRESS_BAR),t.grabFocus(h.PROGRESS_BAR),o&&o(r)},handleMouseLeave:function(r){var e=this.props,t=e.controlFocusActions,o=e.onPointerLeave;t.releaseFocus(h.PROGRESS_BAR),t.stopHover(h.PROGRESS_BAR),o&&o(r)},handleScrubStart:function(r){this.props.onScrubStart&&this.props.onScrubStart(r);var e=this.props,t=e.controlFocusActions,o=e.setKeepActive,n=e.player;t.grabAndHoldFocus(h.PROGRESS_BAR),o(!0),n.scrubStart(this.props.duration*r)},handleScrubEnd:function(r){var e=this.props,t=e.controlFocusActions,o=e.duration,n=e.onScrubEnd,s=e.player,i=e.setKeepActive;n&&n(r),t.releaseFocusHold(h.PROGRESS_BAR),i(!1),r?s.scrubEnd(o*r):s.scrubEnd(void 0)},handleScrub:function(r){var e=this.props,t=e.duration;e.player.scrub(t*r)},handleKeyDown:function(r){var e=r.keyCode;i.findDOMNode(this.refs.scrubber)!==document.activeElement||e!==u.ENTER&&e!==u.SPACE||(r.preventDefault(),this.props.player.togglePlay())},trickplayGenerator:function(r){if(!this.props.player)return{};var e=this.props.player.getTrickPlayURL(this.props.duration*r);return e?{image:e,text:p.convert(this.props.duration*r)}:{text:p.convert(this.props.duration*r)}},render:function(){return o.createElement("div",{className:a("PlayerControls--control-element","progress-control",{"PlayerControls--control-element-hidden":this.props.uiState!==d.ACTIVE,"PlayerControls--control-element-blurred":this.props.controlFocusState.focused&&h.PROGRESS_BAR!==this.props.controlFocusState.focused}),onMouseEnter:this.handleMouseEnter,onMouseLeave:this.handleMouseLeave},o.createElement(c,{ref:"scrubber",isScrubbing:this.props.scrubbing,onScrub:this.handleScrub,onScrubStart:this.handleScrubStart,onScrubEnd:this.handleScrubEnd,onKeyDown:this.handleKeyDown,duration:this.props.duration,currentPlayerTime:this.props.currentTime,buffered:this.props.buffered,playerDimensions:this.props.playerDimensions,trickplayGenerator:this.trickplayGenerator}))}}));e.exports=S});C.r("aW",function(t,e,n){"use strict";var i=t("b6"),a=t("pZ"),s=t("e-"),r=t("iz"),o=t("4_"),u=s({displayName:"MdxStatus",getInitialState:function(){return{transitioning:!1}},componentDidUpdate:function(){this.updateTransitionState(!0)},updateTransitionState:function(t){this.setState({transitioning:t})},shouldComponentUpdate:function(t,e){return!e.transitioning&&(t.status!==this.props.status||t.title!==this.props.title)},afterTransitionLeave:function(){this.updateTransitionState(!1)},render:function(){return a.createElement(o,{component:"div",transitionAppear:!0,transitionName:"mdx-status",afterTransitionLeave:this.afterTransitionLeave,enterTimeout:i.TRANSITION_DURATION,leaveTimeout:i.TRANSITION_DURATION},a.createElement("div",{key:r.uniqueId("mdx-status-"),className:"title-name-container"},a.createElement("strong",null,this.props.status),a.createElement("a",{onClick:this.props.onClick},this.props.title)))}});e.exports=u});C.r("aX",function(t,e,r){"use strict";var o=t("pZ"),n=t("e-"),s=(t("iz"),t("C7")),i=t("eV"),a=t("Dj"),l=t("yr"),c=t("yy"),p=n({displayName:"TimeRemaining",statics:{CONTROL_NAME:c.TIME_REMAINING},shouldComponentUpdate:a.partialProps(["controlFocusState","duration","currentTime","uiState"]),render:function(){var t;return t=this.props.duration?s.convert(this.props.duration-this.props.currentTime):"0:00",o.createElement("div",{className:i("PlayerControls--control-element","time-remaining","text-control",{"PlayerControls--control-element-hidden":this.props.uiState!==l.ACTIVE,"PlayerControls--control-element-blurred":this.props.controlFocusState.focused&&c.PROGRESS_BAR!==this.props.controlFocusState.focused})},o.createElement("time",{className:"time"},t))}});e.exports=p});C.r("aY",function(t,e,o){"use strict";var n=t("iy"),i=t("yQ"),r=t("Dj"),s=t("yy"),u=t("zd"),l=t("pZ"),c=t("e-"),a=t("kb"),p=t("zv"),d=t("zz"),m=t("BT"),h=d(u),b=n("player/player","button.volume"),y=n("player/player","button.volume.muted"),S=(a.bool,a.func,a.node,a.number,a.object,a.string,c({displayName:"MdxVolumeButton",contextTypes:{formatString:a.func.isRequired,getModelData:a.func.isRequired},statics:{CONTROL_NAME:s.VOLUME},oldVolume:null,shouldComponentUpdate:r.partialProps(["controlFocusState","isHidden","muted","player","volume"]),getDefaultProps:function(){return{isHidden:!1}},handleScrubStart:function(t){var e=this.props.onScrubStart;this.props.controlFocusActions.grabAndHoldFocus(s.VOLUME),this.props.setKeepActive(!0),this.oldVolume=this.props.volume,this.setVolume(t),e&&e(t)},handleScrubEnd:function(t){var e=this.props,o=e.controlFocusActions,n=e.setKeepActive,i=e.onScrubEnd;o.releaseFocusHold(s.VOLUME),n(!1),t&&this.setVolume(t),i&&i(t)},handleScrub:function(t){var e=this.props.onScrub;this.setVolume(t),e&&e(t)},setVolume:function(t){0===t?(this.props.player.setMuted(!0),this.props.player.setVolume(this.oldVolume?this.oldVolume:0)):(this.props.player.setMuted(!1),this.props.player.setVolume(t))},toggleMute:function(){this.props.player.toggleMute()},render:function(){var t=this.props,e=t.caretPosition,o=t.controlFocusActions,n=t.controlFocusState,r=t.isHidden,u=t.muted,c=t.onClick,a=t.onClickCapture,S=t.onDoubleClickCapture,g=t.onKeyDownCapture,f=t.onKeyUp,C=t.setKeepActive,V=t.tooltipAlignment,v=t.tooltipPosition,M=t.volume,E=m(M,u),A=u?this.context.formatString(y):this.context.formatString(b);return l.createElement(h,{ariaLabel:A,buttonType:"default",commandLoggingName:d.VOLUME,controlFocusState:n,controlFocusActions:o,focusName:s.VOLUME,positionedAtTop:!0,iconName:E,isHidden:r,onButtonClick:this.toggleMute,onClick:c,onClickCapture:a,onDoubleClickCapture:S,onKeyDownCapture:g,onKeyUp:f,popupContentCentered:!0,setKeepActive:C,tabIndex:0,tooltip:A,tooltipAlignment:V,tooltipPosition:v},n.focused===s.VOLUME&&l.createElement(p,{caretPosition:e,muted:u,onScrub:this.handleScrub,onScrubEnd:this.handleScrubEnd,onScrubStart:this.handleScrubStart,volume:M},l.createElement(i,{ariaLabel:A,iconName:E,isHidden:!1,onClick:this.toggleMute,tabIndex:0,type:"default"})))}}));e.exports=S});C.r("a-",function(t,e,n){"use strict";function i(t){t.getPaths=t.getPaths?t.getPaths:function(){return[]};var e=d(t,{autoFetch:!0,usePqls:!0});return o({displayName:"MdxTargetData("+t.displayName+")",shouldComponentUpdate:l.pureRender,getInitialState:function(){return u.assign({runtime:0,currentTime:0,paused:!1,connected:!1,statusTransitioning:!1,player:this.props.mdxTarget},this.props.mdxTarget.state)},componentDidMount:function(){this.props.mdxTarget.on(this.props.mdxTarget.EVENTS.STATE_CHANGED,this.onStateChange)},componentWillUnmount:function(){this.props.mdxTarget.removeListener(this.props.mdxTarget.EVENTS.STATE_CHANGED,this.onStateChange)},getVideoId:function(){return this.state.contentId||this.state.nextVideoId},getPqls:function(){var t=this.state.contentId,e=this.state.nextVideoId;if(!t)return null;var n={videoSummary:["videos",t,"current","summary"],videoTitle:["videos",t,"current","title"],ancestorSummary:["videos",t,"ancestor","summary"],ancestorTitle:["videos",t,"ancestor","title"],isPinProtected:["videos",t,"current","pinProtected"],adultVerification:["videos",t,"current","adultVerification"]};return e&&(n.nextVideoSummary=["videos",e,"summary"],n.nextVideoTitle=["videos",e,"title"]),n},onStateChange:function(t){this.setState(t)},render:function(){var t=this.getPqls(),n=this.getVideoId(),i=u.values(t),r=n?{}:{ancestorSummary:null,videoSummary:null,ancestorTitle:null,videoTitle:null,nextVideoSummary:null,nextVideoTitle:null,isPinProtected:null,adultVerification:null};return a.createElement(e,(0,s.default)({},this.state,this.props,r,{mappedPqls:t,paths:i}))}})}var r=t("bo"),s=r(t("bk")),a=t("pZ"),o=t("e-"),u=t("iz"),d=t("7m"),l=t("Dj");e.exports=i});C.r("b0",function(e,t,n){"use strict";var i=e("b6"),o=e("b7"),r=e("b9"),c=function(e,t,n,i,o){this.playerApp=e,this.RxObservable=o,this.mdxManager=t,this.initParams=n,r.setMdxVersion(i),this.mdxManager.on(this.mdxManager.EVENTS.NEW_DEVICE_AVAILABLE,this.onNewDeviceAvailable.bind(this))};c.prototype.logConnectEvent=function(){var e=this,t={startTime:Date.now()};this.connectToDeviceSubscription&&this.connectToDeviceSubscription.error({errorcode:i.ERROR_CODES.CONNECTION_CANCELED}),this.connectToDeviceSubscription=this.RxObservable.of({}).flatMap(function(){return e.RxObservable.create(function(n){return e.mdxManager.once(e.mdxManager.EVENTS.NEW_DEVICE_AVAILABLE,function(e){t.sdkConnected=Date.now(),t.deviceId=e.id,t.deviceName=e.friendlyName,n.next(),n.complete()}),function(){}}).timeoutWith(e.initParams.castSdkConnectTimeout,e.RxObservable.throw({errorcode:i.ERROR_CODES.SDK_CONNECTION_TIMEOUT,timeout:e.initParams.castSdkConnectTimeout}))}).flatMap(this.createObservableFromMdxConnectToAppEvent.bind(this)).do(function(n){t.mdxConnected=Date.now(),t.launchSource=e.mdxManager.launchSource(),t.usermismatch=n.usermismatch}).timeoutWith(this.initParams.mdxConnectionTimeout,this.RxObservable.throw({errorcode:i.ERROR_CODES.MDX_CONNECTION_TIMEOUT,timeout:this.initParams.mdxConnectionTimeout,castsdkdelay:t.sdkConnected?t.sdkConnected-t.startTime:void 0,deviceid:t.deviceId,devicename:t.deviceName})).subscribe(function(){},function(n){var c;if(n.errorcode)c=n;else{var a=n;c={errorcode:i.ERROR_CODES.UNHANDLED_EXCEPTION,errordetails:o.exceptionToString(a)}}c.uilaunchorigin=t.launchSource,r.queue(e.playerApp,"connect","error",c),r.flush(e.playerApp),e.connectToDeviceSubscription=void 0},function(){r.queue(e.playerApp,"connect","info",{castsdkdelay:t.sdkConnected?t.sdkConnected-t.startTime:void 0,mdxdelay:t.mdxConnected&&t.sdkConnected?t.mdxConnected-t.sdkConnected:void 0,delay:t.mdxConnected?t.mdxConnected-t.startTime:void 0,deviceid:t.deviceId,devicename:t.deviceName,uilaunchorigin:t.launchSource,usermismatch:t.usermismatch}),e.connectToDeviceSubscription=void 0})},c.prototype.onNewDeviceAvailable=function(e){this.connectToDeviceSubscription||this.logReconnectEvent(e)},c.prototype.logReconnectEvent=function(e){var t=this;this.reconnectToDeviceSubscription&&this.reconnectToDeviceSubscription.error({errorcode:i.ERROR_CODES.CONNECTION_CANCELED});var n={startTime:Date.now(),deviceId:e.id,deviceName:e.friendlyName};this.reconnectToDeviceSubscription=this.RxObservable.of({}).flatMap(this.createObservableFromMdxConnectToAppEvent.bind(this)).do(function(e){n.mdxConnected=Date.now(),n.usermismatch=e.usermismatch}).timeoutWith(this.initParams.mdxConnectionTimeout,this.RxObservable.throw({errorcode:i.ERROR_CODES.MDX_CONNECTION_TIMEOUT,timeout:this.initParams.mdxConnectionTimeout,deviceid:n.deviceId,devicename:n.deviceName})).subscribe(function(){},function(e){var c;if(e.errorcode)c=e;else{var a=e;c={errorcode:i.ERROR_CODES.UNHANDLED_EXCEPTION,errordetails:o.exceptionToString(a)}}c.delay=Date.now()-n.startTime,r.queue(t.playerApp,"reconnect","error",c),r.flush(t.playerApp)},function(){r.queue(t.playerApp,"reconnect","info",{delay:n.mdxConnected?n.mdxConnected-n.startTime:void 0,deviceid:n.deviceId,devicename:n.deviceName,usermismatch:n.usermismatch})})},c.prototype.logDisconnectEvent=function(){var e=this;this.disconnectDeviceSubscription&&this.disconnectDeviceSubscription.error({errorcode:i.ERROR_CODES.CONNECTION_CANCELED});var t={startTime:Date.now()};this.disconnectDeviceSubscription=this.RxObservable.of({}).flatMap(function(){return e.RxObservable.create(function(n){return e.mdxManager.once(e.mdxManager.EVENTS.TARGET_CONNECTION_CHANGED,function(e,i){e||(t.disconnected=Date.now(),i&&i.device&&(t.deviceId=i.device.id,t.deviceName=i.device.friendlyName),n.next(),n.complete())}),function(){}}).timeoutWith(e.initParams.castSdkDisconnectTimeout,e.RxObservable.throw({errorcode:i.ERROR_CODES.DISCONNECT_TIMEOUT,timeout:e.initParams.castSdkDisconnectTimeout}))}).subscribe(function(){},function(t){var n;if(t.errorcode)n=t;else{var c=t;n={errorcode:i.ERROR_CODES.UNHANDLED_EXCEPTION,errordetails:o.exceptionToString(c)}}r.queue(e.playerApp,"disconnect","error",n),r.flush(e.playerApp)},function(){r.queue(e.playerApp,"disconnect","info",{delay:t.disconnected?t.disconnected-t.startTime:void 0,deviceid:t.deviceId,devicename:t.deviceName})})},c.prototype.createObservableFromMdxConnectToAppEvent=function(){var e=this;return this.RxObservable.create(function(t){var n=function(e,n){e&&(t.next(n),t.complete())},r=function(e){t.error({errorcode:i.ERROR_CODES.MDX_CONNECT_FAILED,errordetails:o.exceptionToString(e)})};return e.mdxManager.once(e.mdxManager.EVENTS.TARGET_CONNECTION_CHANGED,n),e.mdxManager.once(e.mdxManager.EVENTS.TARGET_CONNECTION_FAILED,r),function(){e.mdxManager.removeListener(e.mdxManager.EVENTS.TARGET_CONNECTION_CHANGED,n),e.mdxManager.removeListener(e.mdxManager.EVENTS.TARGET_CONNECTION_FAILED,r)}})},t.exports=c});C.r("b2",function(t,e,i){"use strict";function s(t){return r.assign({},f,t)}var a=t("bo"),n=a(t("bC")),o=a(t("tc")),u=t("b8"),r=t("iz"),d=t("CH"),l=t("CR"),c=t("Do"),E=o.default.get("netflix.ui.akira.mdx.catalog.prefix"),h={PLAYER_CURRENT_STATE:"PLAYER_CURRENT_STATE",PLAYER_STATE_CHANGED:"PLAYER_STATE_CHANGED",AUDIO_SUBTITLES_SETTINGS:"AUDIO_SUBTITLES_SETTINGS",AUDIO_SUBTITLES_CHANGED:"AUDIO_SUBTITLES_CHANGED",PIN_VERIFICATION_SHOW:"PIN_VERIFICATION_SHOW",PIN_VERIFICATION_NOT_REQUIRED:"PIN_VERIFICATION_NOT_REQUIRED",PIN_VERIFICATION_CANCEL:"PIN_VERIFICATION_CANCEL",PIN_VERIFICATION_RESPONSE:"PIN_VERIFICATION_RESPONSE"},T={PLAY:"PLAY",PROGRESS:"PROGRESS",PLAYING:"PLAYING",PAUSE:"PAUSE",STOP:"STOP",STALLED:"STALLED",AUTO_ADVANCE:"AUTO_ADVANCE",END_PLAYBACK:"END_PLAYBACK"},S={ENDED:"ENDED"},f={connected:!1,currentState:null,contentId:null,catalogId:null,episodeId:null,currentTime:0,runtime:0,muted:!1,volume:1,paused:!0,started:!1,ended:!0,audioList:[],subtitleList:[],playbackUnavailableReason:void 0,unavailableTrackId:void 0,unavailableVideoId:void 0},I={BRANCHING_TITLE:"BRANCHING_TITLE"},A=function(t){if(!t||"object"!==(0,n.default)(t))throw new Error("Video summary not provided to MDX cast() call.");if(c.isBranchingTitle(t))return I.BRANCHING_TITLE},m=function(t){var e=t.device,i=t.initParams,a=t.playerApp,n=t.profileGuid;this.target=e,this.initParams=i,this.playerApp=a,this.profileGuid=n,this.boundUpdateState=this.updateState.bind(this),this.target.addEventListener(this.target.EVENTS.NEW_APP_MESSAGE,this.boundUpdateState),this.state=s({deviceName:l.unescapeHtmlCharacters(e.friendlyName)})},p=function(t){return r.get(t,"payload.currentState","")},g=function(t){var e=r.last(r.get(t,"payload.episodeId","").split("/"));return e=r.isEmpty(e)?null:parseFloat(e)},_=function(t){var e=r.last(r.get(t,"payload.catalogId","").split("/"));return e=r.isEmpty(e)?null:parseFloat(e)},N=function(t){return parseFloat(r.first(r.get(t,"payload.duration","").split(".")))},C=function(t){return parseFloat(r.first(r.get(t,"payload.time","").split(".")))},P=function(t){return r.get(t,"payload.volume","")/100},V=function(t){return r.get(t,"payload.postplayState",null)},v=function(t){return r.get(t,"payload.targetState",null)},D=function(t){return t.selected="true"===t.selected,t},L=function(t,e){var i=r.get(t,"payload."+e,[]);return r.map(i,function(t){D(t)}),i},R=r.debounce(function(t,e,i){t.setVolume(e,100*i).done(function(){u("setVolume message delivered!")},function(){u("setVolume message failed!")})},100,{leading:!0,trailing:!0,maxWait:100});m.prototype={waiting:!1,messageFulfilled:function(){this._defaultAckFunc()},_defaultAckFunc:function(){return!0},shouldUpdateState:function(t){return this.waiting&&this.messageFulfilled(t)&&(u("message fulfilled!"),this.waiting=!1,this.messageFulfilled=this._defaultAckFunc),p(t)===this.DEVICE_STATES.STOP||!this.waiting},fakeUpdateState:function(t){r.assign(this.state,t),this.emit(this.EVENTS.STATE_CHANGED,r.clone(this.state))},localTimerId:null,startLocalTimer:function(){if(null===this.localTimerId){var t=this;this.localTimerId=setInterval(function(){t.fakeUpdateState({currentTime:parseFloat(t.state.currentTime)+1})},1e3)}},stopLocalTimer:function(){null!==this.localTimerId&&(clearTimeout(this.localTimerId),this.localTimerId=null)},updateState:function(t){var e=p(t),i=r.get(t,"device.discoveryState")===r.get(t,"device.DISCOVERY_STATES.AVAILABLE");if(this.DEVICE_AUDIO_EVENTS.indexOf(t.name)>=0)this.state.audioList=L(t,"audio_tracks"),this.state.subtitleList=L(t,"timed_text_track"),this.emit(this.EVENTS.STATE_CHANGED,r.clone(this.state));else if(t.name!==this.DEVICE_EVENTS.PLAYER_STATE_CHANGED||v(t)!==S.ENDED||V(t))if(this.DEVICE_PLAYER_EVENTS.indexOf(t.name)>=0){if(this.shouldUpdateState(t)){if(this.state.xid=t.transactionId||this.state.xid,this.state.connected=i,this.state.currentState=e||this.state.currentState,this.state.paused=this.state.currentState===this.DEVICE_STATES.PAUSE,this.state.currentState!==T.END_PLAYBACK){var s=_(t),a=g(t);this.state.catalogId=s,this.state.episodeId=a,this.state.contentId=a||s}var n=N(t);r.isNaN(n)||(this.state.runtime=n);var o=C(t);r.isNaN(o)||(this.state.currentTime=Math.min(o,this.state.runtime)),e===this.DEVICE_STATES.PLAYING?this.startLocalTimer():this.stopLocalTimer(),e===this.DEVICE_EVENTS.STOP&&(this.state.contentId=null,this.state.catalogId=null,this.state.episodeId=null,this.state.runtime=0,this.currentTime=0);var u=parseFloat(P(t));0===u?this.state.muted=!0:(this.state.muted=!1,this.state.volume=u);var d=V(t);d?(this.state.inPostplay=!0,this.state.nextVideoId=parseFloat(r.get(d,"title.id"))):(this.state.inPostplay=!1,this.state.nextVideoId=null),r.includes(this.DEVICE_PLAY_STATES,e)?(this.state.started=!0,this.state.ended=!1):(this.state.started=!1,this.state.ended=!0),this.emit(this.EVENTS.STATE_CHANGED,r.clone(this.state))}}else t.name===h.PIN_VERIFICATION_SHOW?this.showPinEntry():t.name===h.PIN_VERIFICATION_NOT_REQUIRED&&this.hidePinEntry();else this.state.connected=i,this.state.contentId=null,this.state.catalogId=null,this.state.episodeId=null,this.emit(this.EVENTS.STATE_CHANGED,r.clone(this.state))},showPinEntry:function(){this.state.showPinEntry=!0,this.emit(this.EVENTS.STATE_CHANGED,r.clone(this.state))},hidePinEntry:function(){this.state.showPinEntry=!1,this.emit(this.EVENTS.STATE_CHANGED,r.clone(this.state))},clearUnavailablePlayback:function(){this.fakeUpdateState({playbackUnavailableReason:void 0})},cast:function(t,e,i,s){var a=r.get(this,"initParams.pinConfig.isEnabled",!1),n=r.get(this,"initParams.pinConfig.isAdultVerified",!0),o=!this.playerApp.getAPI().playerApp.isPinSessionExpired();if(t!==this.state.contentId){var u=A(s);if(u)return void this.fakeUpdateState({playbackUnavailableReason:u,unavailableVideoId:t,unavailableTrackId:e});var d={currentState:this.DEVICE_STATES.PROGRESS,contentId:t,trackId:e,paused:!1,runtime:0,currentTime:0,inPostplay:!1,nextVideoId:null,playbackUnavailableReason:void 0,unavailableVideoId:void 0,unavailableTrackId:void 0};if(!i&&(a&&!o||!n))return this.currentVideoId=this.state.contentId,this.currentTrackId=this.state.trackId,this.fakeUpdateState({contentId:t,trackId:e}),void(this._castAttempted=!0);this._castAttempted=!1,this.stopLocalTimer(),this.fakeUpdateState(d),this._connect({isPinVerified:!0})}},resetCurrentContentId:function(){this.fakeUpdateState({contentId:this.currentVideoId||null,trackId:this.currentTrackId||-1})},_connect:function(t){var e=this,i=this.state.contentId,s={enablePostPlay:!0};this.waiting=!0,this.messageFulfilled=function(t){return!(p(t)!==this.DEVICE_STATES.PLAYING&&p(t)!==this.DEVICE_STATES.PLAY||_(t)!==i&&g(t)!==i)},this.target.connectToApp(this.target.CONNECT_INTENTS.LAUNCH_AND_CONTROL).done(function(){e.state.contentId&&e.target.play(E+e.state.contentId,e.state.trackId,r.assign(s,t)).done(function(){u("cast message delivered!")},function(){u("cast message failed!")})},function(){u("cast connectToApp message failed!")})},disconnect:function(t){this.target.disconnectFromApp(!0).done(function(){u("disconnect message delivered!"),t&&"function"==typeof t&&t()},function(){u("disconnect message failed!"),t&&"function"==typeof t&&t(new Error("MDX Disconnect Failed"))})},stop:function(){this.waiting=!0,this.messageFulfilled=function(t){return p(t)===this.DEVICE_STATES.STOP};var t={currentState:this.DEVICE_STATES.STOP,contentId:null,paused:!1,runtime:0,currentTime:0};this.stopLocalTimer(),this.fakeUpdateState(t),this.target.stop().done(function(){u("stop message delivered!")},function(){u("stop message failed!")})},pause:function(t){this.waiting=!0,this.messageFulfilled=t?function(){return!1}:function(t){return p(t)===this.DEVICE_STATES.PAUSE};var e={scrubbing:!!t,currentState:this.DEVICE_STATES.PAUSE,paused:!0};this.stopLocalTimer(),this.fakeUpdateState(e),this.target.pause(this.xid).done(function(){u("pause message delivered!")},function(){u("pause message failed!")})},getCatalogId:function(){return this.state.catalogId},getContentId:function(){return this.state.contentId},getPaused:function(){return this.state.paused},play:function(){this.waiting=!0,this.messageFulfilled=function(t){return p(t)===this.DEVICE_STATES.PLAYING};var t={currentState:this.DEVICE_STATES.PLAYING,paused:!1};this.fakeUpdateState(t),this.target.resume(this.xid).done(function(){u("resume message delivered!")},function(){u("resume message failed!")})},seek:function(t){this.waiting=!0,t=Math.floor(t),this.messageFulfilled=function(e){return p(e)===this.DEVICE_STATES.PLAYING&&r.inRange(C(e),.95*t,1.05*t)};var e={scrubbing:!1,currentState:this.DEVICE_STATES.PROGRESS,currentTime:t,paused:!1};this.fakeUpdateState(e),this.target.setTime(this.xid,t).done(function(){u("seek/setTime message delivered!")},function(){u("seek/setTime message failed!")})},setVolume:function(t){var e={volume:t};this.fakeUpdateState(e),this.state.muted||(this.waiting=!0,this.messageFulfilled=function(t){return P(t)===this.state.volume},R(this.target,this.xid,t))},setMuted:function(t){this.state.muted!==t&&this.toggleMute()},toggleMute:function(){var t=this.state.muted?this.state.volume:0;this.state.muted=!this.state.muted;var e={muted:this.state.muted};this.fakeUpdateState(e),this.target.setVolume(this.xid,100*t).done(function(){u("setVolume for toggleVolume message delivered!")},function(){u("setVolume for toggleVolume message failed!")})},setAudioTrack:function(t){this.target.setAudioSubtitles(t.id,null).done(function(){u("setAudioSubtitles message delivered!")},function(){u("setVolume message failed!")})},setTimedTextTrack:function(t){this.target.setAudioSubtitles(null,t.id).done(function(){u("setAudioSubtitles message delivered!")},function(){u("setVolume message failed!")})},scrubStart:function(){this.state.paused||this.pause(!0)},getTrickPlayURL:function(t){},lastScrubTime:0,scrub:function(t){this.fakeUpdateState({currentTime:t}),this.lastScrubTime=t},getCurrentTime:function(){return this.state.currentTime},getDuration:function(){return this.state.runtime},getVolume:function(){return this.state.volume},toggleFullscreen:r.noop,togglePlay:function(){this.state.paused?this.play():this.pause()},scrubEnd:function(t){var e=t||this.lastScrubTime;this.seek(e)},resumeCast:function(){this._castAttempted&&(this._castAttempted=!1,this._connect({pinVerified:!0}))},validPin:function(){var t=this;this.playerApp.getActionCreators().receivePinTimestamp({ts:Date.now(),profileGuid:this.profileGuid}),this.waiting=!1,this.messageFulfilled=this._defaultAckFunc,this.target.sendAppMessage(this.DEVICE_EVENTS.PIN_VERIFICATION_RESPONSE).done(function(){u("validPin message delivered!"),t._connect({isPinVerified:!0})},function(){u("validPin message failed!"),t._connect({isPinVerified:!0})})},cancelPin:function(){var t=this;this.waiting=!1,this.messageFulfilled=this._defaultAckFunc,this.target.sendAppMessage(this.DEVICE_EVENTS.PIN_VERIFICATION_CANCEL).done(function(){u("cancelPin message delivered!"),t.resetCurrentContentId()},function(){u("cancelPin message failed!"),t.resetCurrentContentId()})},destroy:function(){this.target.removeEventListener(this.target.EVENTS.NEW_APP_MESSAGE,this.boundUpdateState),this.stopLocalTimer()},TARGET_STATES:S,DEVICE_STATES:T,DEVICE_EVENTS:h,DEVICE_PLAYER_EVENTS:[h.PLAYER_CURRENT_STATE,h.PLAYER_STATE_CHANGED],DEVICE_AUDIO_EVENTS:[h.AUDIO_SUBTITLES_CHANGED,h.AUDIO_SUBTITLES_SETTINGS],DEVICE_PLAY_STATES:[T.PLAY,T.PROGRESS,T.PLAYING,T.PAUSE],EVENTS:{STATE_CHANGED:"STATE_CHANGED"}},r.assign(m.prototype,d),e.exports=m});C.r("b8",function(o,n,c){"use strict";var t=o("b6"),e=document.location.search.indexOf(t.DEBUG_PARAM)>=0,i=function(o){var n=window.console;e&&n.log(o)};n.exports=i});C.r("iS",function(e,t,n){t.exports=function(){var t;return function t(n,r,i){function o(c,a){if(!r[c]){if(!n[c]){var u="function"==typeof e&&e;if(!a&&u)return u(c,!0);if(s)return s(c,!0);var d=new Error("Cannot find module '"+c+"'");throw d.code="MODULE_NOT_FOUND",d}var l=r[c]={exports:{}};n[c][0].call(l.exports,function(e){return o(n[c][1][e]||e)},l,l.exports,t,n,r,i)}return r[c].exports}for(var s="function"==typeof e&&e,c=0;c<i.length;c++)o(i[c]);return o}({1:[function(e,t,n){(function(e){(function(){function r(e,t){if(e!==t){var n=null===e,r=e===ut,i=e===e,o=null===t,s=t===ut,c=t===t;if(e>t&&!o||!i||n&&!s&&c||r&&c)return 1;if(e<t&&!n||!c||o&&!r&&i||s&&i)return-1}return 0}function i(e,t,n){for(var r=e.length,i=n?r:-1;n?i--:++i<r;)if(t(e[i],i,e))return i;return-1}function o(e,t,n){if(t!==t)return a(e,n);for(var r=n-1,i=e.length;++r<i;)if(e[r]===t)return r;return-1}function s(e){return null==e?"":e+""}function c(e,t){return r(e.criteria,t.criteria)||e.index-t.index}function a(e,t,n){for(var r=e.length,i=t+(n?0:-1);n?i--:++i<r;){var o=e[i];if(o!==o)return i}return-1}function u(e){return!!e&&"object"==typeof e}function d(e){if(u(e)&&!wn(e)&&!(e instanceof p)){if(e instanceof f)return e;if(nn.call(e,"__chain__")&&nn.call(e,"__wrapped__"))return Oe(e)}return new f(e)}function l(){}function f(e,t,n){this.__wrapped__=e,this.__actions__=n||[],this.__chain__=!!t}function p(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=mn,this.__views__=[]}function v(e){var t=e?e.length:0;for(this.data={hash:fn(null),set:new un};t--;)this.push(e[t])}function g(e,t){var n=e.data;return("string"==typeof t||qe(t)?n.set.has(t):n.hash[t])?0:-1}function h(e){var t=this.data;"string"==typeof e||qe(e)?t.set.add(e):t.hash[e]=!0}function E(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}function m(e,t){for(var n=-1,r=e.length;++n<r&&!1!==t(e[n],n,e););return e}function y(e,t){for(var n=-1,r=e.length,i=-1,o=[];++n<r;){var s=e[n];t(s,n,e)&&(o[++i]=s)}return o}function R(e,t){for(var n=-1,r=e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i}function S(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}function I(e,t,n,r){var i=-1,o=e.length;for(r&&o&&(n=e[++i]);++i<o;)n=t(n,e[i],i,e);return n}function T(e,t){for(var n=-1,r=e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}function A(e,t){return null==t?e:N(t,Ln(t),e)}function O(e,t){for(var n=-1,r=null==e,i=!r&&ve(e),o=i?e.length:0,s=t.length,c=Array(s);++n<s;){var a=t[n];c[n]=i?ge(a,o)?e[a]:ut:r?ut:e[a]}return c}function N(e,t,n){n||(n={});for(var r=-1,i=t.length;++r<i;){var o=t[r];n[o]=e[o]}return n}function C(e,t,n){var r=typeof e;return"function"==r?t===ut?e:te(e,t,n):null==e?it:"object"==r?F(e):t===ut?ct(e):B(e,t)}function b(e,t,n,r,i,o,s){var c;if(n&&(c=i?n(e,r,i):n(e)),c!==ut)return c;if(!qe(e))return e;var a=wn(e);if(a){if(c=le(e),!t)return E(e,c)}else{var u=on.call(e),d=u==Et;if(u!=yt&&u!=ft&&(!d||i))return Ft[u]?pe(e,u,t):i?e:{};if(zt(e))return i?e:{};if(c=fe(d?{}:e),!t)return A(c,e)}o||(o=[]),s||(s=[]);for(var l=o.length;l--;)if(o[l]==e)return s[l];return o.push(e),s.push(c),(a?m:M)(e,function(r,i){c[i]=b(r,t,n,i,e,o,s)}),c}function j(e,t){var n=e?e.length:0,r=[];if(!n)return r;var i=-1,s=ae(),c=s===o,a=c&&t.length>=dt?re(t):null,u=t.length;a&&(s=g,c=!1,t=a);e:for(;++i<n;){var d=e[i];if(c&&d===d){for(var l=u;l--;)if(t[l]===d)continue e;r.push(d)}else s(t,d,0)<0&&r.push(d)}return r}function D(e,t){var n=[];return Nn(e,function(e,r,i){t(e,r,i)&&n.push(e)}),n}function _(e,t,n,r){var i;return n(e,function(e,n,o){if(t(e,n,o))return i=r?n:e,!1}),i}function x(e,t,n,r){r||(r=[]);for(var i=-1,o=e.length;++i<o;){var s=e[i];u(s)&&ve(s)&&(n||wn(s)||Ge(s))?t?x(s,t,n,r):S(r,s):n||(r[r.length]=s)}return r}function w(e,t){return Cn(e,t,et)}function M(e,t){return Cn(e,t,Ln)}function P(e,t){for(var n=-1,r=t.length,i=-1,o=[];++n<r;){var s=t[n];He(e[s])&&(o[++i]=s)}return o}function L(e,t,n){if(null!=e){e=Te(e),n!==ut&&n in e&&(t=[n]);for(var r=0,i=t.length;null!=e&&r<i;)e=Te(e)[t[r++]];return r&&r==i?e:ut}}function U(e,t,n,r,i,o){return e===t||(null==e||null==t||!qe(e)&&!u(t)?e!==e&&t!==t:V(e,t,U,n,r,i,o))}function V(e,t,n,r,i,o,s){var c=wn(e),a=wn(t),u=pt,d=pt;c||(u=on.call(e),u==ft?u=yt:u!=yt&&(c=Qe(e))),a||(d=on.call(t),d==ft?d=yt:d!=yt&&(a=Qe(t)));var l=u==yt&&!zt(e),f=d==yt&&!zt(t),p=u==d;if(p&&!c&&!l)return oe(e,t,u);if(!i){var v=l&&nn.call(e,"__wrapped__"),g=f&&nn.call(t,"__wrapped__");if(v||g)return n(v?e.value():e,g?t.value():t,r,i,o,s)}if(!p)return!1;o||(o=[]),s||(s=[]);for(var h=o.length;h--;)if(o[h]==e)return s[h]==t;o.push(e),s.push(t);var E=(c?ie:se)(e,t,n,r,i,o,s);return o.pop(),s.pop(),E}function k(e,t,n){var r=t.length,i=r,o=!n;if(null==e)return!i;for(e=Te(e);r--;){var s=t[r];if(o&&s[2]?s[1]!==e[s[0]]:!(s[0]in e))return!1}for(;++r<i;){s=t[r];var c=s[0],a=e[c],u=s[1];if(o&&s[2]){if(a===ut&&!(c in e))return!1}else{var d=n?n(a,u,c):ut;if(!(d===ut?U(u,a,n,!0):d))return!1}}return!0}function G(e,t){var n=-1,r=ve(e)?Array(e.length):[];return Nn(e,function(e,i,o){r[++n]=t(e,i,o)}),r}function F(e){var t=ue(e);if(1==t.length&&t[0][2]){var n=t[0][0],r=t[0][1];return function(e){return null!=e&&(e=Te(e),e[n]===r&&(r!==ut||n in e))}}return function(e){return k(e,t)}}function B(e,t){var n=wn(e),r=Ee(e)&&ye(t),i=e+"";return e=Ae(e),function(o){if(null==o)return!1;var s=i;if(o=Te(o),(n||!r)&&!(s in o)){if(null==(o=1==e.length?o:L(o,J(e,0,-1))))return!1;s=je(e),o=Te(o)}return o[s]===t?t!==ut||s in o:U(t,o[s],ut,!0)}}function H(e,t,n,r,i){if(!qe(e))return e;var o=ve(t)&&(wn(t)||Qe(t)),s=o?ut:Ln(t);return m(s||t,function(c,a){if(s&&(a=c,c=t[a]),u(c))r||(r=[]),i||(i=[]),q(e,t,a,H,n,r,i);else{var d=e[a],l=n?n(d,c,a,e,t):ut,f=l===ut;f&&(l=c),l===ut&&(!o||a in e)||!f&&(l===l?l===d:d!==d)||(e[a]=l)}}),e}function q(e,t,n,r,i,o,s){for(var c=o.length,a=t[n];c--;)if(o[c]==a)return void(e[n]=s[c]);var u=e[n],d=i?i(u,a,n,e,t):ut,l=d===ut;l&&(d=a,ve(a)&&(wn(a)||Qe(a))?d=wn(u)?u:ve(u)?E(u):[]:Je(a)||Ge(a)?d=Ge(u)?Ze(u):Je(u)?u:{}:l=!1),o.push(a),s.push(d),l?e[n]=r(d,a,i,o,s):(d===d?d!==u:u===u)&&(e[n]=d)}function W(e){return function(t){return null==t?ut:Te(t)[e]}}function Y(e){var t=e+"";return e=Ae(e),function(n){return L(n,e,t)}}function K(e,t){for(var n=e?t.length:0;n--;){var r=t[n];if(r!=i&&ge(r)){var i=r;dn.call(e,r,1)}}return e}function X(e,t,n,r,i){return i(e,function(e,i,o){n=r?(r=!1,e):t(n,e,i,o)}),n}function J(e,t,n){var r=-1,i=e.length;t=null==t?0:+t||0,t<0&&(t=-t>i?0:i+t),n=n===ut||n>i?i:+n||0,n<0&&(n+=i),i=t>n?0:n-t>>>0,t>>>=0;for(var o=Array(i);++r<i;)o[r]=e[r+t];return o}function z(e,t){var n;return Nn(e,function(e,r,i){return!(n=t(e,r,i))}),!!n}function Q(e,t){var n=e.length;for(e.sort(t);n--;)e[n]=e[n].value;return e}function $(e,t){for(var n=-1,r=t.length,i=Array(r);++n<r;)i[n]=e[t[n]];return i}function Z(e,t,n){var r=0,i=e?e.length:r;if("number"==typeof t&&t===t&&i<=Rn){for(;r<i;){var o=r+i>>>1,s=e[o];(n?s<=t:s<t)&&null!==s?r=o+1:i=o}return i}return ee(e,t,it,n)}function ee(e,t,n,r){t=n(t);for(var i=0,o=e?e.length:0,s=t!==t,c=null===t,a=t===ut;i<o;){var u=pn((i+o)/2),d=n(e[u]),l=d!==ut,f=d===d;if(s)var p=f||r;else p=c?f&&l&&(r||null!=d):a?f&&(r||l):null!=d&&(r?d<=t:d<t);p?i=u+1:o=u}return En(o,yn)}function te(e,t,n){if("function"!=typeof e)return it;if(t===ut)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,o){return e.call(t,n,r,i,o)};case 5:return function(n,r,i,o,s){return e.call(t,n,r,i,o,s)}}return function(){return e.apply(t,arguments)}}function ne(e){var t=new cn(e.byteLength);return new ln(t).set(new ln(e)),t}function re(e){return fn&&un?new v(e):null}function ie(e,t,n,r,i,o,s){var c=-1,a=e.length,u=t.length;if(a!=u&&!(i&&u>a))return!1;for(;++c<a;){var d=e[c],l=t[c],f=r?r(i?l:d,i?d:l,c):ut;if(f!==ut){if(f)continue;return!1}if(i){if(!T(t,function(e){return d===e||n(d,e,r,i,o,s)}))return!1}else if(d!==l&&!n(d,l,r,i,o,s))return!1}return!0}function oe(e,t,n){switch(n){case vt:case gt:return+e==+t;case ht:return e.name==t.name&&e.message==t.message;case mt:return e!=+e?t!=+t:e==+t;case Rt:case St:return e==t+""}return!1}function se(e,t,n,r,i,o,s){var c=Ln(e),a=c.length;if(a!=Ln(t).length&&!i)return!1;for(var u=a;u--;){var d=c[u];if(!(i?d in t:nn.call(t,d)))return!1}for(var l=i;++u<a;){d=c[u];var f=e[d],p=t[d],v=r?r(i?p:f,i?f:p,d):ut;if(!(v===ut?n(f,p,r,i,o,s):v))return!1;l||(l="constructor"==d)}if(!l){var g=e.constructor,h=t.constructor;if(g!=h&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof h&&h instanceof h))return!1}return!0}function ce(e,t,n){var r=d.callback||rt;return r=r===rt?C:r,n?r(e,t,n):r}function ae(e,t,n){var r=d.indexOf||be;return r=r===be?o:r,e?r(e,t,n):r}function ue(e){for(var t=tt(e),n=t.length;n--;)t[n][2]=ye(t[n][1]);return t}function de(e,t){var n=null==e?ut:e[t];return Ye(n)?n:ut}function le(e){var t=e.length,n=new e.constructor(t);return t&&"string"==typeof e[0]&&nn.call(e,"index")&&(n.index=e.index,n.input=e.input),n}function fe(e){var t=e.constructor;return"function"==typeof t&&t instanceof t||(t=Object),new t}function pe(e,t,n){var r=e.constructor;switch(t){case It:return ne(e);case vt:case gt:return new r(+e);case Tt:case At:case Ot:case Nt:case Ct:case bt:case jt:case Dt:case _t:r instanceof r&&(r=In[t]);var i=e.buffer;return new r(n?ne(i):i,e.byteOffset,e.length);case mt:case St:return new r(e);case Rt:var o=new r(e.source,Lt.exec(e));o.lastIndex=e.lastIndex}return o}function ve(e){return null!=e&&me(bn(e))}function ge(e,t){return e="number"==typeof e||Vt.test(e)?+e:-1,t=null==t?Sn:t,e>-1&&e%1==0&&e<t}function he(e,t,n){if(!qe(n))return!1;var r=typeof t;if("number"==r?ve(n)&&ge(t,n.length):"string"==r&&t in n){var i=n[t];return e===e?e===i:i!==i}return!1}function Ee(e,t){var n=typeof e;return!!("string"==n&&wt.test(e)||"number"==n)||!wn(e)&&(!xt.test(e)||null!=t&&e in Te(t))}function me(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=Sn}function ye(e){return e===e&&!qe(e)}function Re(e,t){e=Te(e);for(var n=-1,r=t.length,i={};++n<r;){var o=t[n];o in e&&(i[o]=e[o])}return i}function Se(e,t){var n={};return w(e,function(e,r,i){t(e,r,i)&&(n[r]=e)}),n}function Ie(e){for(var t=et(e),n=t.length,r=n&&e.length,i=!!r&&me(r)&&(wn(e)||Ge(e)||ze(e)),o=-1,s=[];++o<n;){var c=t[o];(i&&ge(c,r)||nn.call(e,c))&&s.push(c)}return s}function Te(e){if(d.support.unindexedChars&&ze(e)){for(var t=-1,n=e.length,r=Object(e);++t<n;)r[t]=e.charAt(t);return r}return qe(e)?e:Object(e)}function Ae(e){if(wn(e))return e;var t=[];return s(e).replace(Mt,function(e,n,r,i){t.push(r?i.replace(Pt,"$1"):n||e)}),t}function Oe(e){return e instanceof p?e.clone():new f(e.__wrapped__,e.__chain__,E(e.__actions__))}function Ne(e,t,n){return(e?e.length:0)?((n?he(e,t,n):null==t)&&(t=1),J(e,t<0?0:t)):[]}function Ce(e,t,n){var r=e?e.length:0;return n&&he(e,t,n)&&(t=!1),r?x(e,t):[]}function be(e,t,n){var r=e?e.length:0;if(!r)return-1;if("number"==typeof n)n=n<0?hn(r+n,0):n;else if(n){var i=Z(e,t);return i<r&&(t===t?t===e[i]:e[i]!==e[i])?i:-1}return o(e,t,n||0)}function je(e){var t=e?e.length:0;return t?e[t-1]:ut}function De(){var e=arguments,t=e[0];if(!t||!t.length)return t;for(var n=0,r=ae(),i=e.length;++n<i;)for(var o=0,s=e[n];(o=r(t,s,o))>-1;)dn.call(t,o,1);return t}function _e(e,t,n){return(e?e.length:0)?((n?he(e,t,n):null==t)&&(t=1),J(e,0,t<0?0:t)):[]}function xe(e,t){var n=-1,r=e?e.length:0,i={};for(!r||t||wn(e[0])||(t=[]);++n<r;){var o=e[n];t?i[o]=t[n]:o&&(i[o[0]]=o[1])}return i}function we(e,t,n){var r=wn(e)?y:D;return t=ce(t,n,3),r(e,t)}function Me(e,t,n,r){var i=e?bn(e):0;return me(i)||(e=nt(e),i=e.length),n="number"!=typeof n||r&&he(t,n,r)?0:n<0?hn(i+n,0):n||0,"string"==typeof e||!wn(e)&&ze(e)?n<=i&&e.indexOf(t,n)>-1:!!i&&ae(e,t,n)>-1}function Pe(e,t,n){var r=wn(e)?R:G;return t=ce(t,n,3),r(e,t)}function Le(e,t,n){var r=wn(e)?T:z;return n&&he(e,t,n)&&(t=ut),"function"==typeof t&&n===ut||(t=ce(t,n,3)),r(e,t)}function Ue(e,t,n){if(null==e)return[];n&&he(e,t,n)&&(t=ut);var r=-1;return t=ce(t,n,3),Q(G(e,function(e,n,i){return{criteria:t(e,n,i),index:++r,value:e}}),c)}function Ve(e,t){if("function"!=typeof e)throw new TypeError(lt);return t=hn(t===ut?e.length-1:+t||0,0),function(){for(var n=arguments,r=-1,i=hn(n.length-t,0),o=Array(i);++r<i;)o[r]=n[t+r];switch(t){case 0:return e.call(this,o);case 1:return e.call(this,n[0],o);case 2:return e.call(this,n[0],n[1],o)}var s=Array(t+1);for(r=-1;++r<t;)s[r]=n[r];return s[t]=o,e.apply(this,s)}}function ke(e,t,n,r){return t&&"boolean"!=typeof t&&he(e,t,n)?t=!1:"function"==typeof t&&(r=n,n=t,t=!1),"function"==typeof n?b(e,t,te(n,r,3)):b(e,t)}function Ge(e){return u(e)&&ve(e)&&nn.call(e,"callee")&&!an.call(e,"callee")}function Fe(e,t,n,r){n="function"==typeof n?te(n,r,3):ut;var i=n?n(e,t):ut;return i===ut?U(e,t,n):!!i}function Be(e){return u(e)&&"string"==typeof e.message&&on.call(e)==ht}function He(e){return qe(e)&&on.call(e)==Et}function qe(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function We(e){return Xe(e)&&e!=+e}function Ye(e){return null!=e&&(He(e)?sn.test(tn.call(e)):u(e)&&(zt(e)?sn:Ut).test(e))}function Ke(e){return null===e}function Xe(e){return"number"==typeof e||u(e)&&on.call(e)==mt}function Je(e){var t;if(!u(e)||on.call(e)!=yt||zt(e)||Ge(e)||!nn.call(e,"constructor")&&"function"==typeof(t=e.constructor)&&!(t instanceof t))return!1;var n;return d.support.ownLast?(w(e,function(e,t,r){return n=nn.call(r,t),!1}),!1!==n):(w(e,function(e,t){n=t}),n===ut||nn.call(e,n))}function ze(e){return"string"==typeof e||u(e)&&on.call(e)==St}function Qe(e){return u(e)&&me(e.length)&&!!Gt[on.call(e)]}function $e(e){return e===ut}function Ze(e){return N(e,et(e))}function et(e){if(null==e)return[];qe(e)||(e=Object(e));var t=e.length,n=d.support;t=t&&me(t)&&(wn(e)||Ge(e)||ze(e))&&t||0;for(var r=e.constructor,i=-1,o=He(r)&&r.prototype||Zt,s=o===e,c=Array(t),a=t>0,u=n.enumErrorProps&&(e===$t||e instanceof Error),l=n.enumPrototypes&&He(e);++i<t;)c[i]=i+"";for(var f in e)l&&"prototype"==f||u&&("message"==f||"name"==f)||a&&ge(f,t)||"constructor"==f&&(s||!nn.call(e,f))||c.push(f);if(n.nonEnumShadows&&e!==Zt){var p=e===en?St:e===$t?ht:on.call(e),v=Tn[p]||Tn[yt];for(p==yt&&(o=Zt),t=kt.length;t--;){f=kt[t];var g=v[f];s&&g||(g?!nn.call(e,f):e[f]===o[f])||c.push(f)}}return c}function tt(e){e=Te(e);for(var t=-1,n=Ln(e),r=n.length,i=Array(r);++t<r;){var o=n[t];i[t]=[o,e[o]]}return i}function nt(e){return $(e,Ln(e))}function rt(e,t,n){return n&&he(e,t,n)&&(t=ut),u(e)?ot(e):C(e,t)}function it(e){return e}function ot(e){return F(b(e,!0))}function st(e,t,n){if(null==n){var r=qe(t),i=r?Ln(t):ut,o=i&&i.length?P(t,i):ut;(o?o.length:r)||(o=!1,n=t,t=e,e=this)}o||(o=P(t,Ln(t)));var s=!0,c=-1,a=He(e),u=o.length;!1===n?s=!1:qe(n)&&"chain"in n&&(s=n.chain);for(;++c<u;){var d=o[c],l=t[d];e[d]=l,a&&(e.prototype[d]=function(t){return function(){var n=this.__chain__;if(s||n){var r=e(this.__wrapped__);return(r.__actions__=E(this.__actions__)).push({func:t,args:arguments,thisArg:e}),r.__chain__=n,r}return t.apply(e,S([this.value()],arguments))}}(l))}return e}function ct(e){return Ee(e)?W(e):Y(e)}function at(e){var t=++rn;return s(e)+t}var ut,dt=200,lt="Expected a function",ft="[object Arguments]",pt="[object Array]",vt="[object Boolean]",gt="[object Date]",ht="[object Error]",Et="[object Function]",mt="[object Number]",yt="[object Object]",Rt="[object RegExp]",St="[object String]",It="[object ArrayBuffer]",Tt="[object Float32Array]",At="[object Float64Array]",Ot="[object Int8Array]",Nt="[object Int16Array]",Ct="[object Int32Array]",bt="[object Uint8Array]",jt="[object Uint8ClampedArray]",Dt="[object Uint16Array]",_t="[object Uint32Array]",xt=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\n\\]|\\.)*?\1)\]/,wt=/^\w*$/,Mt=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\n\\]|\\.)*?)\2)\]/g,Pt=/\\(\\)?/g,Lt=/\w*$/,Ut=/^\[object .+?Constructor\]$/,Vt=/^\d+$/,kt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Gt={};Gt[Tt]=Gt[At]=Gt[Ot]=Gt[Nt]=Gt[Ct]=Gt[bt]=Gt[jt]=Gt[Dt]=Gt[_t]=!0,Gt[ft]=Gt[pt]=Gt[It]=Gt[vt]=Gt[gt]=Gt[ht]=Gt[Et]=Gt["[object Map]"]=Gt[mt]=Gt[yt]=Gt[Rt]=Gt["[object Set]"]=Gt[St]=Gt["[object WeakMap]"]=!1;var Ft={};Ft[ft]=Ft[pt]=Ft[It]=Ft[vt]=Ft[gt]=Ft[Tt]=Ft[At]=Ft[Ot]=Ft[Nt]=Ft[Ct]=Ft[mt]=Ft[yt]=Ft[Rt]=Ft[St]=Ft[bt]=Ft[jt]=Ft[Dt]=Ft[_t]=!0,Ft[ht]=Ft[Et]=Ft["[object Map]"]=Ft["[object Set]"]=Ft["[object WeakMap]"]=!1;var Bt={function:!0,object:!0},Ht=Bt[typeof n]&&n&&!n.nodeType&&n,qt=Bt[typeof t]&&t&&!t.nodeType&&t,Wt=Ht&&qt&&"object"==typeof e&&e&&e.Object&&e,Yt=Bt[typeof self]&&self&&self.Object&&self,Kt=Bt[typeof window]&&window&&window.Object&&window,Xt=qt&&qt.exports===Ht&&Ht,Jt=Wt||Kt!==(this&&this.window)&&Kt||Yt||this,zt=function(){try{Object({toString:0}+"")}catch(e){return function(){return!1}}return function(e){return"function"!=typeof e.toString&&"string"==typeof(e+"")}}(),Qt=Array.prototype,$t=Error.prototype,Zt=Object.prototype,en=String.prototype,tn=Function.prototype.toString,nn=Zt.hasOwnProperty,rn=0,on=Zt.toString,sn=RegExp("^"+tn.call(nn).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),cn=Jt.ArrayBuffer,an=Zt.propertyIsEnumerable,un=de(Jt,"Set"),dn=Qt.splice,ln=Jt.Uint8Array,fn=de(Object,"create"),pn=Math.floor,vn=de(Array,"isArray"),gn=de(Object,"keys"),hn=Math.max,En=Math.min,mn=Number.POSITIVE_INFINITY,yn=4294967294,Rn=2147483647,Sn=9007199254740991,In={};In[Tt]=Jt.Float32Array,In[At]=Jt.Float64Array,In[Ot]=Jt.Int8Array,In[Nt]=Jt.Int16Array,In[Ct]=Jt.Int32Array,In[bt]=ln,In[jt]=Jt.Uint8ClampedArray,In[Dt]=Jt.Uint16Array,In[_t]=Jt.Uint32Array;var Tn={};Tn[pt]=Tn[gt]=Tn[mt]={constructor:!0,toLocaleString:!0,toString:!0,valueOf:!0},Tn[vt]=Tn[St]={constructor:!0,toString:!0,valueOf:!0},Tn[ht]=Tn[Et]=Tn[Rt]={constructor:!0,toString:!0},Tn[yt]={constructor:!0},m(kt,function(e){for(var t in Tn)if(nn.call(Tn,t)){var n=Tn[t];n[e]=nn.call(n,e)}});var An=d.support={};!function(e){var t=function(){this.x=1},n={0:1,length:1},r=[];t.prototype={valueOf:1,y:1};for(var i in new t)r.push(i);An.enumErrorProps=an.call($t,"message")||an.call($t,"name"),An.enumPrototypes=an.call(t,"prototype"),An.nonEnumShadows=!/valueOf/.test(r),An.ownLast="x"!=r[0],An.spliceObjects=(dn.call(n,0,1),!n[0]),An.unindexedChars="x"[0]+Object("x")[0]!="xx"}();var On=function(){function e(){}return function(t){if(qe(t)){e.prototype=t;var n=new e;e.prototype=ut}return n||{}}}(),Nn=function(e,t){return function(n,r){var i=n?bn(n):0;if(!me(i))return e(n,r);for(var o=t?i:-1,s=Te(n);(t?o--:++o<i)&&!1!==r(s[o],o,s););return n}}(M),Cn=function(e){return function(t,n,r){for(var i=Te(t),o=r(t),s=o.length,c=e?s:-1;e?c--:++c<s;){var a=o[c];if(!1===n(i[a],a,i))break}return t}}(),bn=W("length"),jn=Ve(function(e,t){t=x(t);var n=O(e,t);return K(e,t.sort(r)),n}),Dn=function(e,t){return function(n,r,o){if(r=ce(r,o,3),wn(n)){var s=i(n,r,t);return s>-1?n[s]:ut}return _(n,r,e)}}(Nn),_n=function(e,t){return function(n,r,i){return"function"==typeof r&&i===ut&&wn(n)?e(n,r):t(n,te(r,i,3))}}(m,Nn),xn=function(e,t){return function(n,r,i,o){var s=arguments.length<3;return"function"==typeof r&&o===ut&&wn(n)?e(n,r,i,s):X(n,ce(r,o,4),i,s,t)}}(I,Nn),wn=vn||function(e){return u(e)&&me(e.length)&&on.call(e)==pt},Mn=function(e){return Ve(function(t,n){var r=-1,i=null==t?0:n.length,o=i>2?n[i-2]:ut,s=i>2?n[2]:ut,c=i>1?n[i-1]:ut;for("function"==typeof o?(o=te(o,c,5),i-=2):(o="function"==typeof c?c:ut,i-=o?1:0),s&&he(n[0],n[1],s)&&(o=i<3?ut:o,i=1);++r<i;){var a=n[r];a&&e(t,a,o)}return t})}(H),Pn=function(e){return function(t,n,r){return n=ce(n,r,3),_(t,n,e,!0)}}(M),Ln=gn?function(e){var t=null==e?ut:e.constructor;return"function"==typeof t&&t.prototype===e||("function"==typeof e?d.support.enumPrototypes:ve(e))?Ie(e):qe(e)?gn(e):[]}:Ie,Un=Ve(function(e,t){if(null==e)return{};if("function"!=typeof t[0]){var t=R(x(t),String);return Re(e,j(et(e),t))}var n=te(t[0],t[1],3);return Se(e,function(e,t,r){return!n(e,t,r)})});d.prototype=l.prototype,f.prototype=On(l.prototype),f.prototype.constructor=f,p.prototype=On(l.prototype),p.prototype.constructor=p,v.prototype.push=h,d.callback=rt,d.drop=Ne,d.filter=we,d.flatten=Ce,d.forEach=_n,d.keys=Ln,d.keysIn=et,d.map=Pe,d.matches=ot,d.merge=Mn,d.mixin=st,d.omit=Un,d.pairs=tt,d.property=ct,d.pull=De,d.pullAt=jn,d.restParam=Ve,d.sortBy=Ue,d.take=_e,d.toPlainObject=Ze,d.values=nt,d.zipObject=xe,d.collect=Pe,d.each=_n,d.iteratee=rt,d.object=xe,d.select=we,d.clone=ke,d.find=Dn,d.findKey=Pn,d.identity=it,d.includes=Me,d.indexOf=be,d.isArguments=Ge,d.isArray=wn,d.isEqual=Fe,d.isError=Be,d.isFunction=He,d.isNaN=We,d.isNative=Ye,d.isNull=Ke,d.isNumber=Xe,d.isObject=qe,d.isPlainObject=Je,d.isString=ze,d.isTypedArray=Qe,d.isUndefined=$e,d.last=je,d.reduce=xn,d.some=Le,d.uniqueId=at,d.any=Le,d.contains=Me,d.eq=Fe,d.detect=Dn,d.foldl=xn,d.include=Me,d.inject=xn,d.VERSION="3.10.1",Ht&&qt&&Xt&&((qt.exports=d)._=d)}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,n){function r(e,t,n){for(var r,i="",o=0,s=e.length,c=s-2;o<c;){if(!((r=(e[o++]<<16)+(e[o++]<<8)+e[o++])>=0&&r<=16777215))throw new Error("not bytes");i+=t[r>>>18]+t[r>>>12&63]+t[r>>>6&63]+t[63&r]}if(o==c){if(!((r=(e[o++]<<8)+e[o++])>=0&&r<=65535))throw new Error("not bytes");i+=t[r>>>10]+t[r>>>4&63]+t[r<<2&63]+n}else if(o==s-1){if(!((r=e[o++])>=0&&r<=255))throw new Error("not bytes");i+=t[r>>>2]+t[r<<4&63]+n+n}return i}function i(e){e=e.replace(f,"");var t,n=e.length;t=e.charAt(n-1),"="!==t&&"."!==t||n--,"="!==(t=e.charAt(n-1))&&"."!==t||n--;var r=3*(n>>2),i=0;switch(n%4){case 2:i=1;break;case 3:i=2;break;case 1:throw new Error("bad base64")}for(var o,s=new Uint8Array(r+i),c=0,p=0;p<r;){if(!((o=a[e[c++]]+u[e[c++]]+d[e[c++]]+l[e[c++]])>=0&&o<=16777215))throw new Error("bad base64");s[p++]=o>>>16,s[p++]=o>>>8&255,s[p++]=255&o}if(i>0&&(o=a[e[c++]]+u[e[c++]],s[p++]=o>>>16,i>1&&(o+=d[e[c++]],s[p++]=o>>>8&255),!(o>=0&&o<=16776960&&0==(o&(i>1?255:65535)))))throw new Error("bad base64");return s}var o=Array.prototype.slice,s=o.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),c=o.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),a={},u={},d={},l={},f=/\s+/g;[s,c].forEach(function(e){for(var t,n=e.length;n--;)t=e[n],a[t]=n<<18,u[t]=n<<12,d[t]=n<<6,l[t]=n}),t.exports={encode:function(e){return r(e,s,"=")},encodeUrlSafe:function(e){return r(e,c,"")},decode:i}},{}],3:[function(e,t,n){"use strict";var r=e("./init"),i=e("./versionInfo");t.exports={init:r(nrdp,[e("./widget")]),versionInfo:i}},{"./init":4,"./versionInfo":10,"./widget":22}],4:[function(e,t,n){"use strict";t.exports=function(e,t){function n(t){for(var n=a,r=n.length,i=0;i<r;i++)a[i](t,e);a=[]}function r(){e.removeEventListener("init",i),e.removeEventListener("fatalerror",o)}function i(){r(),s=!0;var i=void 0;try{for(var o=t.length,c=0;c<o;c++)t[c](e)}catch(e){i=new Error("An exception occured while executing init tasks")}finally{n(i)}}function o(){r(),n(new Error("NRDP FatalError"))}var s=!1,c=!1,a=[];return function(t){if(s&&(a=[t],n()),a.push(t),!c){c=!0;try{e.isReady?i():(e.addEventListener("init",i),e.addEventListener("fatalerror",o),"function"==typeof e.hookInit&&e.hookInit(null),e.init())}catch(e){n(e),s=!0}}}}},{}],5:[function(e,t,n){"use strict";function r(e){var t=e.split("-");e=t.shift();var n=void 0;return n=0===e.indexOf("P")?-1/e.substr(1):"."+e,{value:parseFloat(n,10),additionalSegments:t}}t.exports=function(e){return function(t){var n=e.device.SDKVersion;if(n){var i=n.version,o=t.split("."),s=void 0;if(o[0]>2e3)s=i;else{if(!(o[0]>11))throw new Error("4.x version comparison is not available right now");s=i.slice(2)}for(var c=s.split("."),a=0;a<Math.max(c.length,o.length)&&!(c.length<=a||o.length<=a);a++){var u=r(c[a]);c=c.concat(u.additionalSegments);var d=r(o[a]);if(o=o.concat(d.additionalSegments),u.value>d.value)return 1;if(u.value<d.value)return-1}return 0}}}},{}],6:[function(e,t,n){"use strict";var r=e("./compare");t.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r(e);return function(e){return 0===t(e)}}},{"./compare":5}],7:[function(e,t,n){"use strict";var r=e("./compare");t.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r(e);return function(e){return t(e)>0}}},{"./compare":5}],8:[function(e,t,n){"use strict";var r=e("./compare");t.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r(e);return function(e){return t(e)<0}}},{"./compare":5}],9:[function(e,t,n){"use strict";t.exports=function(t){var n="",r=t.device.SDKVersion;if(r){var i=r.components,o=i.platform,s=e("./isGreaterThan");if(o&&s("14.2")){var c=["platformType","platformVersion","platformBuildNum"],a=[];for(var u in c){var d=c[u];o[d]&&a.push(o[d])}var l=[a.join(":")];for(var f in o)-1===c.indexOf(f)&&l.push(f+" "+o[f]);n=l.join(" / ")}else n=i.sdk;return n}}},{"./isGreaterThan":7}],10:[function(e,t,n){"use strict";t.exports=e("./versionInfo")(nrdp)},{"./versionInfo":11}],11:[function(e,t,n){"use strict";t.exports=function(t){return{versionString:e("./helpers/versionString")(t),isGreaterThan:e("./helpers/isGreaterThan")(t),isLessThan:e("./helpers/isLessThan")(t),isEqual:e("./helpers/isEqual")(t)}}},{"./helpers/isEqual":6,"./helpers/isGreaterThan":7,"./helpers/isLessThan":8,"./helpers/versionString":9}],12:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget,i=n.Widget.prototype,o=r._default||r._defaults;t.isLessThan("2016.2")&&i._pull&&(i._pull=function(e){return void 0!==this._syncData[e]?this._syncData[e]:o[e]})}t.exports=r},{}],13:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget,i=n.Widget.prototype;t.isLessThan("2016.2")&&i._push&&(i._push=function(t,i){return this._syncData[t]=i,!this._created||n._needPendingSync()?(this.__push||(n._addPendingSync(this),this.__push={}),this.__push[t]=i,!1):(this._pushed[t]=i,"parent"!==t&&"clone"!==t||(i=i._id),r.push_warnedPendingSync||(r.push_warnedPendingSync=!0,console.warn("gibbon widget property set without pending sync")),e._setProperty(this,t,i),!0)})}t.exports=r},{}],14:[function(e,t,n){"use strict";function r(e,t){if(t.isLessThan("2016.2")){var n=t.isLessThan("2015.1");e._setProperty&&(e._setProperty=function(t,r,i,o){e._backchannel||console.info("unhandled _setProperty "+t+" "+r,"NRDP_SCRIPT");var s=void 0,c=void 0;if(t instanceof Object&&t&&t._path)s=t,c=t._path;else{var a=t?"nrdp."+t:"nrdp";if(!(s=e._findObject(a)))return void e.log.error("could not find object "+a+" to set property "+r+" on","NRDP_SCRIPT");c=t}var u=s,d=u._setProperty_current,l=u._setProperty_pending;if(!o&&d&&d[r])return l||(s._setProperty_pending=l={}),void(l[r]={object:s._path?s:t,property:r,value:i});var f=e._backchannel.setProperty(c,r,i);!o&&(f||n&&!d)&&(d=s._setProperty_current={},d[r]=!0)})}}t.exports=r},{}],15:[function(e,t,n){"use strict";function r(e){var t=e.gibbon,n=t.Widget.prototype;void 0===n.addBackgroundImage&&(n.addBackgroundImage=function(e){for(var t in e)this.backgroundImage[t]=e[t]})}t.exports=r},{}],16:[function(e,t,n){"use strict";function r(e){var t=e.gibbon,n=t.Widget.prototype;void 0===n.addForegroundImage&&(n.addForegroundImage=function(e){for(var t in e)this.image[t]=e[t]})}t.exports=r},{}],17:[function(e,t,n){"use strict";function r(e,t){function n(){var e=r._queuedAnimations,t=e.length;if(t){for(var n=0;n<t;n++){var o=i(e[n],8),s=o[0],a=o[1],u=o[2],d=o[3],l=o[4],f=o[5],p=o[6],v=o[7];c.call(s,a,u,d,l,f,p,v)}r._queuedAnimations=[]}}var r=e.gibbon,o=r.Widget.prototype,s=t.isEqual("2013.2"),c=o.startAnimation;s&&(r.startBatching=function(){r._batchCreates=!0,r._deferredCreates=r._deferredCreates||[],r._queuedAnimations=r._queuedAnimations||[]},r.endBatching=function(){var e=r._queuedAnimations,t=r._deferredCreates;e&&e.length&&r.setTimeout(n,0,!0);var i=t&&t.length;if(i){for(var o=0;o<i;o++){var s=t[o];s&&s._createWidget&&s._createWidget()}r._deferredCreates=[]}r._batchCreates=!1})}var i=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,c=e[Symbol.iterator]();!(r=(s=c.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&c.return&&c.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.exports=r},{}],18:[function(e,t,n){"use strict";function r(e){var t=e.gibbon,n=t.Widget.prototype,r=Object.getOwnPropertyDescriptor(n,"children");void 0===(r&&r.get)&&Object.defineProperty(n,"children",{get:function(){return this._children}})}t.exports=r},{}],19:[function(e,t,n){"use strict";var r={zh:!0,ja:!0,ko:!0};t.exports=function(e){if(!e||!e.device)return!1;var t=e.device.UILanguages,n=void 0===t?["en-US","en"]:t,i=n&&n[0]&&n[0].substring(0,2);return!!r[i]}},{}],20:[function(e,t,n){"use strict";t.exports=function(){return{weight:"normal",padding:[-1,0]}}},{}],21:[function(e,t,n){"use strict";function r(e){var t=e.gibbon,n=t.Widget.prototype;if(void 0===n.id){var r=Object.getOwnPropertyDescriptor(n,i);r&&r.get||Object.defineProperty(n,i,{get:function(){return this._id}})}}var i="id";t.exports=r},{}],22:[function(e,t,n){"use strict";var r=e("../versionInfo");t.exports=function(t){e("./parent")(t,r),e("./batching")(t,r),e("./startAnimation")(t,r),e("./removeImage")(t,r),e("./addForegroundImage")(t,r),e("./addBackgroundImage")(t,r),e("./text")(t,r),e("./textStyle")(t,r),e("./layout")(t,r),e("./id")(t,r),e("./name")(t,r),e("./children")(t,r),e("./mirror")(t,r),e("./makeWidget")(t,r),e("./_push")(t,r),e("./_pull")(t,r),e("./_setProperty")(t,r),e("./propertyGetters")(t,r)}},{"../versionInfo":10,"./_pull":12,"./_push":13,"./_setProperty":14,"./addBackgroundImage":15,"./addForegroundImage":16,"./batching":17,"./children":18,"./id":21,"./layout":23,"./makeWidget":24,"./mirror":25,"./name":26,"./parent":27,"./propertyGetters":28,"./removeImage":29,"./startAnimation":30,"./text":31,"./textStyle":32}],23:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget.prototype,o=t.isLessThan("2014.2"),s=t.isLessThan("2014.1");if(o){var c=function(e){if(e instanceof Object){if(this.layout instanceof Object&&e.align===this.layout.align&&e.layout===this.layout.layout)return;e={layout:e.layout,align:e.align},e.align instanceof Array&&(e.align=e.align.slice(0))}else if(e===this.layout)return;this._push("layout",e)},a=function(t){if(t instanceof Object){if(this.layout instanceof Object&&i(t.align)===i(this.layout.align)&&t.layout===this.layout.layout){if(t.align instanceof Array&&t.align.join(" ")===this.layout.align.join(" "))return;if(t.align===this.layout.align)return}t={layout:t.layout,align:t.align},t.align instanceof Array&&(t.align=t.align.slice(0))}else if(t===this.layout)return;this._push("layout",t),void 0!==e.gibbon._breaks&&this._maybeBreak(n.DEBUGGER_ATTRIBUTE_MODIFIED)};Object.defineProperty(r,"layout",{set:s?c:a})}}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.exports=r},{}],24:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget,i=r._default||r._defaults;if(t.isLessThan("2016.2")){var o=n.makeWidget;n.makeWidget=function(e){var t=void 0;if(e)t=o(e);else{var s=n._nextWidgetId++;s>n.INT_MAX&&(s=1,n._nextWidgetId=2),t=new r(s)}return t._syncData.__proto__=i,t}}}t.exports=r},{}],25:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget.prototype,o=t.isLessThan("2015.2"),s=t.isLessThan("2017");if(!o){var c=Object.getOwnPropertyDescriptor(r,i);Object.defineProperty(r,"explicitIsMirrored",{set:function(e){var t=this.mirror;s?(this._syncData.mirror=e,
this._object.setSyncProperty(this._properties.mirror,e)):c.set.call(this,e),this._explicitIsMirrored=e,this._handleIsMirroredChange(this.mirror,t)}}),Object.defineProperty(r,"implicitIsMirrored",{set:function(e){var t=this.mirror;this._implicitIsMirrored=e,this._handleIsMirroredChange(this.mirror,t)}}),Object.defineProperty(r,i,{get:function(){return!!(void 0!==this._explicitIsMirrored?this._explicitIsMirrored:this._implicitIsMirrored)},set:function(e){this.explicitIsMirrored=e}}),r._handleIsMirroredChange=function(e,t){e!==t&&this._children.forEach(function(t){t.implicitIsMirrored=e})}}}var i="mirror";t.exports=r},{}],26:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget.prototype,a=t.isLessThan("2014.2"),u=Object.getOwnPropertyDescriptor(r,"name"),d=u.get;a&&Object.defineProperty(r,o,{get:function(){return String(d.call(this))},set:function(e){(void 0===e?"undefined":i(e))!==s&&(e=c+e),this._push(o,e)}})}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o="name",s="string",c="";t.exports=r},{}],27:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget.prototype,o=t.isEqual("2013.2"),s=Object.getOwnPropertyDescriptor(r,i),c=s.get;if(o)nrdp.log.info("apply parent polyfill"),Object.defineProperty(r,i,{get:function(){return this._parent||c.call(this)},set:function(t){(t||this.parent)&&(t&&this.parent&&t._id===this.parent._id||(this.parent&&this.parent._removeChild(this),t?(t._addChild(this),!this._push(i,t)&&this.parent._created&&(nrdp.log.info("parent setter "+n._batchCreates),n._batchCreates?n._deferredCreates.push(this):this._createWidget()),this.implicitIsMirrored=t.mirror):(this._syncData.parent=void 0,this._created&&(e._setProperty(this._path,i,0),this._destroyWidget())),this._parent=t))}});else{var a=s.set;Object.defineProperty(r,i,{get:function(){return this._parent||c.call(this)},set:function(e){a.apply(this,arguments),this._parent=e,e&&(this.implicitIsMirrored=e.mirror)}})}}var i="parent";t.exports=r},{}],28:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget,i=n.Widget.prototype,o=r._default||r._defaults;if(t.isLessThan("2016.2")){var s=Object.getOwnPropertyDescriptor(i,"x");Object.defineProperty(i,"x",{get:function(){var e=this._syncData.x;return e&&e instanceof Object?e.value:e},set:s.set});var c=Object.getOwnPropertyDescriptor(i,"y");Object.defineProperty(i,"y",{get:function(){var e=this._syncData.y;return e&&e instanceof Object?e.value:e},set:c.set});var a=Object.getOwnPropertyDescriptor(i,"scrollX");a&&Object.defineProperty(i,"scrollX",{get:function(){var e=this._syncData.scrollX;return e&&e instanceof Object?e.value:e},set:a.set});var u=Object.getOwnPropertyDescriptor(i,"scrollY");u&&Object.defineProperty(i,"scrollY",{get:function(){var e=this._syncData.scrollY;return e&&e instanceof Object?e.value:e},set:u.set});var d=Object.getOwnPropertyDescriptor(i,"width");Object.defineProperty(i,"width",{get:function(){var e=this._syncData.width;return e&&e instanceof Object?e.value:e},set:d.set});var l=Object.getOwnPropertyDescriptor(i,"height");Object.defineProperty(i,"height",{get:function(){var e=this._syncData.height;return e&&e instanceof Object?e.value:e},set:l.set});var f=Object.getOwnPropertyDescriptor(i,"opacity");Object.defineProperty(i,"opacity",{get:function(){var e=this._syncData.opacity;return e&&e instanceof Object?e.value:e},set:f.set});var p=Object.getOwnPropertyDescriptor(i,"scale");Object.defineProperty(i,"scale",{get:function(){var e=this._syncData.scale;if(void 0!==e)return e instanceof Object?e.value:e;var t=this.scaleX;return t===this.scaleY?t:void 0},set:p.set});var v=Object.getOwnPropertyDescriptor(i,"maxWidth");Object.defineProperty(i,"maxWidth",{get:function(){return this._syncData.maxWidth},set:v.set});var g=Object.getOwnPropertyDescriptor(i,"maxHeight");Object.defineProperty(i,"maxHeight",{get:function(){return this._syncData.maxHeight},set:g.set});var h=Object.getOwnPropertyDescriptor(i,"minWidth");Object.defineProperty(i,"minWidth",{get:function(){return this._syncData.minWidth},set:h.set});var E=Object.getOwnPropertyDescriptor(i,"minHeight");Object.defineProperty(i,"minHeight",{get:function(){return this._syncData.minHeight},set:E.set});var m=Object.getOwnPropertyDescriptor(i,"drawOrder");Object.defineProperty(i,"drawOrder",{get:function(){return this._syncData.drawOrder},set:m.set});var y=Object.getOwnPropertyDescriptor(i,"backgroundColor");y||(y=Object.getOwnPropertyDescriptor(i,"color")),Object.defineProperty(i,"color",{get:function(){return this._syncData.backgroundColor||o.backgroundColor},set:y.set});var R=Object.getOwnPropertyDescriptor(i,"padding");Object.defineProperty(i,"padding",{get:function(){return this._syncData.padding},set:R.set});var S=Object.getOwnPropertyDescriptor(i,"visible");Object.defineProperty(i,"visible",{get:function(){return this._syncData.visible},set:S.set})}}t.exports=r},{}],29:[function(e,t,n){"use strict";function r(e){var t=e.gibbon,n=t.Widget.prototype;void 0===n.removeImage&&(n.removeImage=function(e){e===this.backgroundImage?this.backgroundImage.url=void 0:e===this.image&&(this.image.url=void 0)})}t.exports=r},{}],30:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget.prototype;if(t.isEqual("2013.2")){var i=r.startAnimation;r.startAnimation=function(e,t,r,o,s,c,a){var u=this._created,d=n._batchCreates;if(u||!d)i.call(this,e,t,r,o,s,c,a);else{var l=n._queuedAnimations;l[l.length]=[this,e,t,r,o,s,c,a]}}}}t.exports=r},{}],31:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget.prototype;if(t.isLessThan("2014.2")){var s=Object.getOwnPropertyDescriptor(r,i);Object.defineProperty(r,i,{get:function(){var e=this;return{contents:s.get.call(this),toString:function(){return s.get.call(e)}}},set:function(e){null!==e&&void 0!==e||(e=o),e!=this.text.contents&&(this._push(i,e),void 0!==n._breaks&&this._maybeBreak(n.DEBUGGER_ATTRIBUTE_MODIFIED))}})}}var i="text",o="";t.exports=r},{}],32:[function(e,t,n){"use strict";function r(e,t){var n=e.gibbon,r=n.Widget.prototype,c=t.isEqual("2014.1"),a=t.isEqual("2014.2"),u=Object.getOwnPropertyDescriptor(r,"textStyle"),d=u&&u.set,l=u&&u.get;Object.defineProperty(r,"textStyle",{get:l,set:function(t){var n=i();for(var r in t)n[r]=t[r];(c||a)&&n.truncation&&n.truncation.position===s&&o(e)&&(n.wrap=!0),d.call(this,n)}})}var i=e("./helpers/textStyleDefaults"),o=e("./helpers/isLogoGraphic"),s="end";t.exports=r},{"./helpers/isLogoGraphic":19,"./helpers/textStyleDefaults":20}],33:[function(e,t,n){t.exports={encode:function(e){var t,n,r,i,o,s,c,a,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=0,l=0,f="",p=[];if(!e)return e;do{t=e.charCodeAt(d++),n=e.charCodeAt(d++),r=e.charCodeAt(d++),a=t<<16|n<<8|r,i=a>>18&63,o=a>>12&63,s=a>>6&63,c=63&a,p[l++]=u.charAt(i)+u.charAt(o)+u.charAt(s)+u.charAt(c)}while(d<e.length);f=p.join("");var v=e.length%3;return(v?f.slice(0,v-3):f)+"===".slice(v||3)},decode:function(e){var t,n,r,i,o,s,c,a,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=0,l=0,f=[];if(!e)return e;e+="";do{i=u.indexOf(e.charAt(d++)),o=u.indexOf(e.charAt(d++)),s=u.indexOf(e.charAt(d++)),c=u.indexOf(e.charAt(d++)),a=i<<18|o<<12|s<<6|c,t=a>>16&255,n=a>>8&255,r=255&a,f[l++]=64===s?String.fromCharCode(t):64===c?String.fromCharCode(t,n):String.fromCharCode(t,n,r)}while(d<e.length);return f.join("")}}},{}],34:[function(e,t,n){t.exports={encode:function(e){if(null===e||void 0===e)return"";var t,n,r=e+"",i="",o=0;t=n=0,o=r.length;for(var s=0;s<o;s++){var c=r.charCodeAt(s),a=null;if(c<128)n++;else if(c>127&&c<2048)a=String.fromCharCode(c>>6|192,63&c|128);else if(!0&c)a=String.fromCharCode(c>>12|224,c>>6&63|128,63&c|128);else{if(!0&c)throw new RangeError("Unmatched trail surrogate at "+s);var u=r.charCodeAt(++s);if(!0&u)throw new RangeError("Unmatched lead surrogate at "+(s-1));c=((1023&c)<<10)+(1023&u)+65536,a=String.fromCharCode(c>>18|240,c>>12&63|128,c>>6&63|128,63&c|128)}null!==a&&(n>t&&(i+=r.slice(t,n)),i+=a,t=n=s+1)}return n>t&&(i+=r.slice(t,o)),i},decode:function(e){var t=[],n=0,r=0,i=0,o=0,s=0;for(e+="";n<e.length;)i=e.charCodeAt(n),i<128?(t[r++]=String.fromCharCode(i),n++):i>191&&i<224?(o=e.charCodeAt(n+1),t[r++]=String.fromCharCode((31&i)<<6|63&o),n+=2):(o=e.charCodeAt(n+1),s=e.charCodeAt(n+2),t[r++]=String.fromCharCode((15&i)<<12|(63&o)<<6|63&s),n+=3);return t.join("")}}},{}],35:[function(e,t,n){function r(e){for(var t,n=0,r=e.length,i="";n<r;){if(!((t=e[n++])>=0&&t<=255))throw new Error("bad utf8");if(128&t)if(192==(224&t))t=((31&t)<<6)+(63&e[n++]);else{if(224!=(240&t))throw new Error("unsupported utf8 character");t=((15&t)<<12)+((63&e[n++])<<6)+(63&e[n++])}i+=String.fromCharCode(t)}return i}function i(e){var t,n,r,i=e.length,o=0,s=0;if(!(i>=0))throw new Error("bad string");for(n=i;n--;)r=e.charCodeAt(n),r<128?o++:o+=r<2048?2:3;for(t=new Uint8Array(o),n=0;n<i;n++)r=e.charCodeAt(n),r<128?t[s++]=r:r<2048?(t[s++]=192|r>>>6,t[s++]=128|63&r):(t[s++]=224|r>>>12,t[s++]=128|r>>>6&63,t[s++]=128|63&r);return t}t.exports={encode:i,decode:r}},{}],36:[function(e,t,n){function r(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(l===setTimeout)return setTimeout(e,0);if((l===r||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function s(e){if(f===clearTimeout)return clearTimeout(e);if((f===i||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{return f(e)}catch(t){try{return f.call(null,e)}catch(t){return f.call(this,e)}}}function c(){h&&v&&(h=!1,v.length?g=v.concat(g):E=-1,g.length&&a())}function a(){if(!h){var e=o(c);h=!0;for(var t=g.length;t;){for(v=g,g=[];++E<t;)v&&v[E].run();E=-1,t=g.length}v=null,h=!1,s(e)}}function u(e,t){this.fun=e,this.array=t}function d(){}var l,f,p=t.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:r}catch(e){l=r}try{f="function"==typeof clearTimeout?clearTimeout:i}catch(e){f=i}}();var v,g=[],h=!1,E=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];g.push(new u(e,t)),1!==g.length||h||o(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=d,p.addListener=d,p.once=d,p.off=d,p.removeListener=d,p.removeAllListeners=d,p.emit=d,p.prependListener=d,p.prependOnceListener=d,p.listeners=function(e){return[]},p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},{}],37:[function(e,t,n){(function(e){!function(e){"use strict";if("function"==typeof bootstrap)bootstrap("promise",e);else if("object"==typeof n&&"object"==typeof t)t.exports=e();else if("function"==typeof define&&define.amd)define(e);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=e}else{if("undefined"==typeof window&&"undefined"==typeof self)throw new Error("This environment was not anticipated by Q. Please file a bug.");var r="undefined"!=typeof window?window:self,i=r.Q;r.Q=e(),r.Q.noConflict=function(){return r.Q=i,this}}}(function(){"use strict";function t(e){return function(){return K.apply(e,arguments)}}function n(e){return e===Object(e)}function r(e){return"[object StopIteration]"===ne(e)||e instanceof H}function i(e,t){if(F&&t.stack&&"object"==typeof e&&null!==e&&e.stack){for(var n=[],r=t;r;r=r.source)r.stack&&(!e.__minimumStackCounter__||e.__minimumStackCounter__>r.stackCounter)&&(Z(e,"__minimumStackCounter__",{value:r.stackCounter,configurable:!0}),n.unshift(r.stack));n.unshift(e.stack);var i=n.join("\n"+re+"\n"),s=o(i);Z(e,"stack",{value:s,configurable:!0})}}function o(e){for(var t=e.split("\n"),n=[],r=0;r<t.length;++r){var i=t[r];a(i)||s(i)||!i||n.push(i)}return n.join("\n")}function s(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function c(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(t)return[t[1],Number(t[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(n)return[n[1],Number(n[2])];var r=/.*@(.+):(\d+)$/.exec(e);return r?[r[1],Number(r[2])]:void 0}function a(e){var t=c(e);if(!t)return!1;var n=t[0],r=t[1];return n===B&&r>=q&&r<=ue}function u(){if(F)try{throw new Error}catch(r){var e=r.stack.split("\n"),t=e[0].indexOf("@")>0?e[1]:e[2],n=c(t);if(!n)return;return B=n[0],n[1]}}function d(e){return e instanceof v?e:m(e)?C(e):N(e)}function l(){function e(e){t=e,d.longStackSupport&&F&&(o.source=e),J(n,function(t,n){d.nextTick(function(){e.promiseDispatch.apply(e,n)})},void 0),n=void 0,r=void 0}var t,n=[],r=[],i=$(l.prototype),o=$(v.prototype);if(o.promiseDispatch=function(e,i,o){var s=X(arguments);n?(n.push(s),"when"===i&&o[1]&&r.push(o[1])):d.nextTick(function(){t.promiseDispatch.apply(t,s)})},o.valueOf=function(){if(n)return o;var e=h(t);return E(e)&&(t=e),e},o.inspect=function(){return t?t.inspect():{state:"pending"}},d.longStackSupport&&F)try{throw new Error}catch(e){o.stack=e.stack.substring(e.stack.indexOf("\n")+1),o.stackCounter=ie++}return i.promise=o,i.resolve=function(n){t||e(d(n))},i.fulfill=function(n){t||e(N(n))},i.reject=function(n){t||e(O(n))},i.notify=function(e){t||J(r,function(t,n){d.nextTick(function(){n(e)})},void 0)},i}function f(e){if("function"!=typeof e)throw new TypeError("resolver must be a function.");var t=l();try{e(t.resolve,t.reject,t.notify)}catch(e){t.reject(e)}return t.promise}function p(e){return f(function(t,n){for(var r=0,i=e.length;r<i;r++)d(e[r]).then(t,n)})}function v(e,t,n){void 0===t&&(t=function(e){return O(new Error("Promise does not support operation: "+e))}),void 0===n&&(n=function(){return{state:"unknown"}});var r=$(v.prototype);if(r.promiseDispatch=function(n,i,o){var s;try{s=e[i]?e[i].apply(r,o):t.call(r,i,o)}catch(e){s=O(e)}n&&n(s)},r.inspect=n,n){var i=n();"rejected"===i.state&&(r.exception=i.reason),r.valueOf=function(){var e=n();return"pending"===e.state||"rejected"===e.state?r:e.value}}return r}function g(e,t,n,r){return d(e).then(t,n,r)}function h(e){if(E(e)){var t=e.inspect();if("fulfilled"===t.state)return t.value}return e}function E(e){return e instanceof v}function m(e){return n(e)&&"function"==typeof e.then}function y(e){return E(e)&&"pending"===e.inspect().state}function R(e){return!E(e)||"fulfilled"===e.inspect().state}function S(e){return E(e)&&"rejected"===e.inspect().state}function I(){oe.length=0,se.length=0,ae||(ae=!0)}function T(t,n){ae&&("object"==typeof e&&"function"==typeof e.emit&&d.nextTick.runAfter(function(){-1!==z(se,t)&&(e.emit("unhandledRejection",n,t),ce.push(t))}),se.push(t),n&&void 0!==n.stack?oe.push(n.stack):oe.push("(no stack) "+n))}function A(t){if(ae){var n=z(se,t);-1!==n&&("object"==typeof e&&"function"==typeof e.emit&&d.nextTick.runAfter(function(){var r=z(ce,t);-1!==r&&(e.emit("rejectionHandled",oe[n],t),ce.splice(r,1))}),se.splice(n,1),oe.splice(n,1))}}function O(e){var t=v({when:function(t){return t&&A(this),t?t(e):this}},function(){return this},function(){return{state:"rejected",reason:e}});return T(t,e),t}function N(e){return v({when:function(){return e},get:function(t){return e[t]},set:function(t,n){e[t]=n},delete:function(t){delete e[t]},post:function(t,n){return null===t||void 0===t?e.apply(void 0,n):e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},keys:function(){return te(e)}},void 0,function(){return{state:"fulfilled",value:e}})}function C(e){var t=l();return d.nextTick(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(e){t.reject(e)}}),t.promise}function b(e){return v({isDef:function(){}},function(t,n){return M(e,t,n)},function(){return d(e).inspect()})}function j(e,t,n){return d(e).spread(t,n)}function D(e){return function(){function t(e,t){var s;if("undefined"==typeof StopIteration){try{s=n[e](t)}catch(e){return O(e)}return s.done?d(s.value):g(s.value,i,o)}try{s=n[e](t)}catch(e){return r(e)?d(e.value):O(e)}return g(s,i,o)}var n=e.apply(this,arguments),i=t.bind(t,"next"),o=t.bind(t,"throw");return i()}}function _(e){d.done(d.async(e)())}function x(e){throw new H(e)}function w(e){return function(){return j([this,P(arguments)],function(t,n){return e.apply(t,n)})}}function M(e,t,n){return d(e).dispatch(t,n)}function P(e){return g(e,function(e){var t=0,n=l();return J(e,function(r,i,o){var s;E(i)&&"fulfilled"===(s=i.inspect()).state?e[o]=s.value:(++t,g(i,function(r){e[o]=r,0==--t&&n.resolve(e)},n.reject,function(e){n.notify({index:o,value:e})}))},void 0),0===t&&n.resolve(e),n.promise})}function L(e){if(0===e.length)return d.resolve();var t=d.defer(),n=0;return J(e,function(r,i,o){function s(e){t.resolve(e)}function c(e){if(0===--n){var r=e||new Error(""+e);r.message="Q can't get fulfillment value from any promise, all promises were rejected. Last error message: "+r.message,t.reject(r)}}function a(e){t.notify({index:o,value:e})}var u=e[o];n++,g(u,s,c,a)},void 0),t.promise}function U(e){return g(e,function(e){return e=Q(e,d),g(P(Q(e,function(e){return g(e,W,W)})),function(){return e})})}function V(e){return d(e).allSettled()}function k(e,t){return d(e).then(void 0,void 0,t)}function G(e,t){return d(e).nodeify(t)}var F=!1;try{throw new Error}catch(e){F=!!e.stack}var B,H,q=u(),W=function(){},Y=function(){function t(){for(var e,t;r.next;)r=r.next,e=r.task,r.task=void 0,t=r.domain,t&&(r.domain=void 0,t.enter()),n(e,t);for(;a.length;)e=a.pop(),n(e);o=!1}function n(e,n){try{e()}catch(e){if(c)throw n&&n.exit(),setTimeout(t,0),n&&n.enter(),e;setTimeout(function(){throw e},0)}n&&n.exit()}var r={task:void 0,next:null},i=r,o=!1,s=void 0,c=!1,a=[];if(Y=function(t){i=i.next={task:t,domain:c&&e.domain,next:null},o||(o=!0,s())},"object"==typeof e&&"[object process]"===e.toString()&&e.nextTick)c=!0,s=function(){e.nextTick(t)};else if("function"==typeof setImmediate)s="undefined"!=typeof window?setImmediate.bind(window,t):function(){setImmediate(t)};else if("undefined"!=typeof MessageChannel){var u=new MessageChannel;u.port1.onmessage=function(){s=d,u.port1.onmessage=t,t()};var d=function(){u.port2.postMessage(0)};s=function(){setTimeout(t,0),d()}}else s=function(){setTimeout(t,0)};return Y.runAfter=function(e){a.push(e),o||(o=!0,s())},Y}(),K=Function.call,X=t(Array.prototype.slice),J=t(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(1===arguments.length)for(;;){if(n in this){t=this[n++];break}if(++n>=r)throw new TypeError}for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),z=t(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),Q=t(Array.prototype.map||function(e,t){var n=this,r=[];return J(n,function(i,o,s){r.push(e.call(t,o,s,n))},void 0),r}),$=Object.create||function(e){function t(){}return t.prototype=e,new t},Z=Object.defineProperty||function(e,t,n){return e[t]=n.value,e},ee=t(Object.prototype.hasOwnProperty),te=Object.keys||function(e){var t=[];for(var n in e)ee(e,n)&&t.push(n);return t},ne=t(Object.prototype.toString);H="undefined"!=typeof ReturnValue?ReturnValue:function(e){this.value=e};var re="From previous event:";d.resolve=d,d.nextTick=Y,d.longStackSupport=!1;var ie=1;"object"==typeof e&&e&&e.env&&e.env.Q_DEBUG&&(d.longStackSupport=!0),d.defer=l,l.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(X(arguments,1)):e.resolve(n)}},d.Promise=f,d.promise=f,f.race=p,f.all=P,f.reject=O,f.resolve=d,d.passByCopy=function(e){return e},v.prototype.passByCopy=function(){return this},d.join=function(e,t){return d(e).join(t)},v.prototype.join=function(e){return d([this,e]).spread(function(e,t){if(e===t)return e;throw new Error("Q can't join: not the same: "+e+" "+t)})},d.race=p,v.prototype.race=function(){return this.then(d.race)},d.makePromise=v,v.prototype.toString=function(){return"[object Promise]"},v.prototype.then=function(e,t,n){function r(t){try{return"function"==typeof e?e(t):t}catch(e){return O(e)}}function o(e){if("function"==typeof t){i(e,c);try{return t(e)}catch(e){return O(e)}}return O(e)}function s(e){return"function"==typeof n?n(e):e}var c=this,a=l(),u=!1;return d.nextTick(function(){c.promiseDispatch(function(e){u||(u=!0,a.resolve(r(e)))},"when",[function(e){u||(u=!0,a.resolve(o(e)))}])}),c.promiseDispatch(void 0,"when",[void 0,function(e){var t,n=!1;try{t=s(e)}catch(e){if(n=!0,!d.onerror)throw e;d.onerror(e)}n||a.notify(t)}]),a.promise},d.tap=function(e,t){return d(e).tap(t)},v.prototype.tap=function(e){return e=d(e),this.then(function(t){return e.fcall(t).thenResolve(t)})},d.when=g,v.prototype.thenResolve=function(e){return this.then(function(){return e})},d.thenResolve=function(e,t){return d(e).thenResolve(t)},v.prototype.thenReject=function(e){return this.then(function(){throw e})},d.thenReject=function(e,t){return d(e).thenReject(t)},d.nearer=h,d.isPromise=E,d.isPromiseAlike=m,d.isPending=y,v.prototype.isPending=function(){return"pending"===this.inspect().state},d.isFulfilled=R,v.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},d.isRejected=S,v.prototype.isRejected=function(){return"rejected"===this.inspect().state};var oe=[],se=[],ce=[],ae=!0;d.resetUnhandledRejections=I,d.getUnhandledReasons=function(){return oe.slice()},d.stopUnhandledRejectionTracking=function(){I(),ae=!1},I(),d.reject=O,d.fulfill=N,d.master=b,d.spread=j,v.prototype.spread=function(e,t){return this.all().then(function(t){return e.apply(void 0,t)},t)},d.async=D,d.spawn=_,d.return=x,d.promised=w,d.dispatch=M,v.prototype.dispatch=function(e,t){var n=this,r=l();return d.nextTick(function(){n.promiseDispatch(r.resolve,e,t)}),r.promise},d.get=function(e,t){return d(e).dispatch("get",[t])},v.prototype.get=function(e){return this.dispatch("get",[e])},d.set=function(e,t,n){return d(e).dispatch("set",[t,n])},v.prototype.set=function(e,t){return this.dispatch("set",[e,t])},d.del=d.delete=function(e,t){return d(e).dispatch("delete",[t])},v.prototype.del=v.prototype.delete=function(e){return this.dispatch("delete",[e])},d.mapply=d.post=function(e,t,n){return d(e).dispatch("post",[t,n])},v.prototype.mapply=v.prototype.post=function(e,t){return this.dispatch("post",[e,t])},d.send=d.mcall=d.invoke=function(e,t){return d(e).dispatch("post",[t,X(arguments,2)])},v.prototype.send=v.prototype.mcall=v.prototype.invoke=function(e){return this.dispatch("post",[e,X(arguments,1)])},d.fapply=function(e,t){return d(e).dispatch("apply",[void 0,t])},v.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])},d.try=d.fcall=function(e){return d(e).dispatch("apply",[void 0,X(arguments,1)])},v.prototype.fcall=function(){return this.dispatch("apply",[void 0,X(arguments)])},d.fbind=function(e){var t=d(e),n=X(arguments,1);return function(){return t.dispatch("apply",[this,n.concat(X(arguments))])}},v.prototype.fbind=function(){var e=this,t=X(arguments);return function(){return e.dispatch("apply",[this,t.concat(X(arguments))])}},d.keys=function(e){return d(e).dispatch("keys",[])},v.prototype.keys=function(){return this.dispatch("keys",[])},d.all=P,v.prototype.all=function(){return P(this)},d.any=L,v.prototype.any=function(){return L(this)},d.allResolved=function(e,t,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(t+" is deprecated, use "+n+" instead.",new Error("").stack),e.apply(e,arguments)}}(U,"allResolved","allSettled"),v.prototype.allResolved=function(){return U(this)},d.allSettled=V,v.prototype.allSettled=function(){return this.then(function(e){return P(Q(e,function(e){function t(){return e.inspect()}return e=d(e),e.then(t,t)}))})},d.fail=d.catch=function(e,t){return d(e).then(void 0,t)},v.prototype.fail=v.prototype.catch=function(e){return this.then(void 0,e)},d.progress=k,v.prototype.progress=function(e){return this.then(void 0,void 0,e)},d.fin=d.finally=function(e,t){return d(e).finally(t)},v.prototype.fin=v.prototype.finally=function(e){if(!e||"function"!=typeof e.apply)throw new Error("Q can't apply finally callback");return e=d(e),this.then(function(t){return e.fcall().then(function(){return t})},function(t){return e.fcall().then(function(){throw t})})},d.done=function(e,t,n,r){return d(e).done(t,n,r)},v.prototype.done=function(t,n,r){var o=function(e){d.nextTick(function(){if(i(e,s),!d.onerror)throw e;d.onerror(e)})},s=t||n||r?this.then(t,n,r):this;"object"==typeof e&&e&&e.domain&&(o=e.domain.bind(o)),s.then(void 0,o)},d.timeout=function(e,t,n){return d(e).timeout(t,n)},v.prototype.timeout=function(e,t){var n=l(),r=setTimeout(function(){t&&"string"!=typeof t||(t=new Error(t||"Timed out after "+e+" ms"),t.code="ETIMEDOUT"),n.reject(t)},e);return this.then(function(e){clearTimeout(r),n.resolve(e)},function(e){clearTimeout(r),n.reject(e)},n.notify),n.promise},d.delay=function(e,t){return void 0===t&&(t=e,e=void 0),d(e).delay(t)},v.prototype.delay=function(e){return this.then(function(t){var n=l();return setTimeout(function(){n.resolve(t)},e),n.promise})},d.nfapply=function(e,t){return d(e).nfapply(t)},v.prototype.nfapply=function(e){var t=l(),n=X(e);return n.push(t.makeNodeResolver()),this.fapply(n).fail(t.reject),t.promise},d.nfcall=function(e){var t=X(arguments,1);return d(e).nfapply(t)},v.prototype.nfcall=function(){var e=X(arguments),t=l();return e.push(t.makeNodeResolver()),this.fapply(e).fail(t.reject),t.promise},d.nfbind=d.denodeify=function(e){if(void 0===e)throw new Error("Q can't wrap an undefined function");var t=X(arguments,1);return function(){var n=t.concat(X(arguments)),r=l();return n.push(r.makeNodeResolver()),d(e).fapply(n).fail(r.reject),r.promise}},v.prototype.nfbind=v.prototype.denodeify=function(){var e=X(arguments);return e.unshift(this),d.denodeify.apply(void 0,e)},d.nbind=function(e,t){var n=X(arguments,2);return function(){function r(){return e.apply(t,arguments)}var i=n.concat(X(arguments)),o=l();return i.push(o.makeNodeResolver()),d(r).fapply(i).fail(o.reject),o.promise}},v.prototype.nbind=function(){var e=X(arguments,0);return e.unshift(this),d.nbind.apply(void 0,e)},d.nmapply=d.npost=function(e,t,n){return d(e).npost(t,n)},v.prototype.nmapply=v.prototype.npost=function(e,t){var n=X(t||[]),r=l();return n.push(r.makeNodeResolver()),this.dispatch("post",[e,n]).fail(r.reject),r.promise},d.nsend=d.nmcall=d.ninvoke=function(e,t){var n=X(arguments,2),r=l();return n.push(r.makeNodeResolver()),d(e).dispatch("post",[t,n]).fail(r.reject),r.promise},v.prototype.nsend=v.prototype.nmcall=v.prototype.ninvoke=function(e){var t=X(arguments,1),n=l();return t.push(n.makeNodeResolver()),this.dispatch("post",[e,t]).fail(n.reject),n.promise},d.nodeify=G,v.prototype.nodeify=function(e){if(!e)return this;this.then(function(t){d.nextTick(function(){e(null,t)})},function(t){d.nextTick(function(){e(t)})})},d.noConflict=function(){throw new Error("Q.noConflict only works when Q is used as a global")};var ue=u();return d})}).call(this,e("_process"))},{_process:36}],38:[function(e,t,n){t.exports=Object.freeze({STARTED_STATE_CHANGED:"startedStateChanged",DEVICE_AVAILABLE:"deviceAvailable",AVAILABLE_DEVICE_COUNT_CHANGED:"availableDeviceCountChanged",SWITCH_CREDENTIALS:"switchCredentials",MDX_DEVICES_AVAILABLE:"mdxDevicesAvailable",START_CONNECTING:"startConnecting",START_DISCONNECTING:"startDisconnecting"})},{}],39:[function(e,t,n){(function(n){var r=e("../builds/ld.js"),i=e("./enums.js"),o=e("./logging/logger.js"),s=e("./profiling/mdxProfiler.js"),c=e("./schedulerFactory.js"),a=e("./storageFactory.js"),u=e("./session/securityFactory.js"),d=e("./discovery/discoveryUtils.js"),l=e("./mdxError.js"),f=e("./versionInfo.js"),p=function(){},v=null,g=function(e,t,n){o.logLevel=n,t.logLevel=o.logLevel},h=function(e,t,n){if(t.platform.role!==i.roles.TARGET)throw new l(l.ERRORS.INVALID_CONFIG,"Registration mode is not a valid config option for "+t.platform.role);if(!r.findKey(i.registrationModes,function(e){return e===n}))throw new l(l.ERRORS.INVALID_ARG,"Registration mode: "+n);t.registrationMode=n},E=function(e,t,n){s.mode=n,t.profiler.mode=s.mode},m=function(e,t,n){r.isUndefined(v.profileId)?v.storage.getProfileId().then(function(e){e!==n&&(t.profileId=n)}).fail(p).done():t.profileId=n},y=function(e,t,n,r){t[r]=n},R=function(e,t,n,r){t[r]="boolean"==typeof n&&n},S={logLevel:g,registrationMode:h,profilerMode:E,mdxContractVersion:y,volumeControl:y,volumeStep:y,profileId:m,playerStateFn:y,castGuestModeEnabled:R,castSessionRequestTimeout:y,castAutoJoinPolicy:y,castDefaultActionPolicy:y,defaultFriendlyName:y,argoMSLEnabled:R,ignoreDeviceFlapping:R,suspendDiscoveryOnBackground:R},I=function(){var t,n,l,v,g,h,E=this,m=new f("4.6.2-585"),y=null;return Object.defineProperty(this,"versionInfo",{enumerable:!1,get:function(){return m}}),Object.defineProperties(this,{utf8:{enumerable:!1,get:function(){if("undefined"!=typeof _plaform&&t.id===i.platforms.NRDP_TARGET.id&&"undefined"!=typeof nrdp&&void 0!==nrdp.device&&void 0!==nrdp.device.SDKVersion&&void 0!==nrdp.device.SDKVersion.components&&e("nf-bridge-adapter").versionInfo.isLessThan("2014.1"))return e("nf-legacy-utf8");return e("nf-utf8")}},base64:{enumerable:!1,get:function(){if("undefined"!=typeof _plaform&&t.id===i.platforms.NRDP_TARGET.id&&"undefined"!=typeof nrdp&&void 0!==nrdp.device&&void 0!==nrdp.device.SDKVersion&&void 0!==nrdp.device.SDKVersion.components&&e("nf-bridge-adapter").versionInfo.isLessThan("2014.1"))return e("nf-legacy-base64");return e("nf-base64")}},version:{enumerable:!0,get:function(){return m.toString()}},nativeVersion:{enumerable:!0,get:function(){switch(t.id){case 3:return cast&&cast.receiver.VERSION||"";case 2:case 6:case 8:return nrdp&&nrdp.mdx&&nrdp.mdx.nativeVersion||"";default:return""}}},uiVersion:{enumerable:!0,get:function(){switch(t.id){case 3:case 2:case 6:case 8:return nrdp&&nrdp.device&&nrdp.device.UIVersion||"";default:return""}}},platform:{enumerable:!0,get:function(){return t},set:function(e){t=e,n=c.createScheduler(t),l=a.createStorageProvider(t),l&&l.getProfileId().then(function(e){E.profileId=e}).fail(p).done(),l&&l.getMdxId().then(function(e){E.currentMdxId=e}).fail(p).done()}},mdxUuid:{enumerable:!0,get:function(){if(!y)switch(t.id){case 2:case 6:case 8:y=nrdp.device.ESN;break;case 4:case 5:y=u.platformCrypto?u.platformCrypto.getEsn():"";break;default:y=""}return y},set:function(e){y=e}},profileId:{enumerable:!0,get:function(){return h},set:function(t){if(l&&h!==t){var n=!r.isUndefined(h);h=t,l.setProfileId(t),n&&e("./session/pairing.js").clearAllPairings()}}},isStarted:{enumerable:!0,writable:!0,value:!1},logLevel:{enumerable:!0,writable:!0,value:o.logLevel},registrationMode:{enumerable:!0,writable:!0,value:i.registrationModes.DISABLED},pairingPin:{enumerable:!0,writable:!0,value:"00000"},mdxContractVersion:{enumerable:!0,writable:!0,value:1},volumeControl:{enumerable:!0,writable:!0,value:!1},volumeStep:{enumerable:!0,writable:!0,value:""},currentMdxId:{enumerable:!0,get:function(){return g||l.getMdxId().then(function(e){g=e}).fail(p).done(),g},set:function(e){if(!l||g===e)return void o.trace("currentMdxId setter: no storage or mdxid not updated.  New: "+e+", existing: "+g);l.setMdxId(e),g=e}},profiler:{enumerable:!0,writable:!0,value:{mode:s.mode,getData:function(){return s.getData.apply(null,arguments)}}},castGuestModeEnabled:{enumerable:!0,writable:!0,value:!1},castSessionRequestTimeout:{enumerable:!0,writable:!0,value:2e4},castAutoJoinPolicy:{enumerable:!0,writable:!0,value:null},castDefaultActionPolicy:{enumerable:!0,writable:!0,value:null},defaultFriendlyName:{enumerable:!0,writable:!0,value:"Netflix Device"},argoMSLEnabled:{enumerable:!0,writable:!0,value:!1},ignoreDeviceFlapping:{enumerable:!0,writable:!0,value:!1},suspendDiscoveryOnBackground:{enumerable:!0,writable:!0,value:!0},scheduler:{enumerable:!1,get:function(){return n}},dscMgr:{enumerable:!1,get:function(){return v},set:function(e){v=e}
},storage:{enumerable:!1,get:function(){return l}},testConfig:{enumerable:!1,writable:!0,value:null},localMdxPort:{enumerable:!1,writable:!0,value:"9080"},playerStateFn:{enumerable:!1,writable:!0,value:null},responseHeaders:{enumerable:!1,get:function(){var e,n=d.headers,i={};return e=2===t.id?nrdjs&&nrdjs.profiles&&null!==nrdjs.profiles.current()?1:0:nrdp.registration.registered?1:0,i[n.regMode]=E.registrationMode,i[n.msl]=r.isUndefined(nrdp.ntba)?1:0,i[n.caps]="",i[n.id]=E.currentMdxId,i[n.registered]=e,i}}}),this};t.exports={get current(){return v||(v=new I)},reset:function(){v=null},process:function(e,t,n){r.forEach(n,function(n,r){var i=S[r];if(!i)return void o.error("Invalid configuration value specified: "+r);i(e,t,n,r)})}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../builds/ld.js":1,"./discovery/discoveryUtils.js":63,"./enums.js":65,"./logging/logger.js":70,"./mdxError.js":76,"./profiling/mdxProfiler.js":77,"./schedulerFactory.js":80,"./session/pairing.js":94,"./session/securityFactory.js":97,"./storageFactory.js":99,"./versionInfo.js":106,"nf-base64":2,"nf-bridge-adapter":3,"nf-legacy-base64":33,"nf-legacy-utf8":34,"nf-utf8":35}],40:[function(e,t,n){t.exports=Object.freeze({DISCOVERY_STATE_CHANGED:"discoveryStateChanged",LAUNCH_STATE_CHANGED:"launchStateChanged",PROPERTY_CHANGED:"propertyChanged",NEW_APP_MESSAGE:"newAppMessage",APP_CONNECTION_ENDED:"appConnectionEnded"})},{}],41:[function(e,t,n){var r=/[https?|wss?]:\/\/([0-2][0-9]{0,2}\.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}):?([0-9]{0,5})?/;t.exports={ipAddressFromLocation:function(e){var t=r.exec(e);return t?t[1]:""},ipAddressAndPortFromLocation:function(e){var t=r.exec(e);return t?t[1]+":"+t[2]:""}}},{}],42:[function(e,t,n){var r=e("./mdxController.js"),i=function(e,t,n){return r.call(this,e,t,n),Object.defineProperties(this,{wasLaunchingController:{enumerable:!0,value:e&&e.wasLaunchingController||!1}}),this};i.prototype=Object.create(r.prototype),i.prototype.persistentType="CastController",i.prototype.shouldShutDownOnUnavailable=function(){return this.wasExplicitLastDisconnect},t.exports=i},{"./mdxController.js":46}],43:[function(e,t,n){var r=(e("../logging/logger.js"),e("../enums.js")),i=e("../discovery/discoveryEvents.js"),o=e("../profiling/mdxProfiler.js"),s=e("../configuration.js"),c=e("./mdxTarget.js"),a=function(e,t,n){c.call(this,e,t);var o=this,s=t;Object.defineProperties(this,{registrationMode:{enumerable:!0,writable:!0,value:e&&e.registrationMode||r.registrationModes.DISABLED},isGuestMode:{enumerable:!1,writable:!0,value:e&&e.isGuestMode||!1},canJoinInGuestMode:{enumerable:!1,writable:!0,value:!1}});var a=[];if(a.push({name:i.DEVICE_REFOUND,handler:s.addEventListener(i.DEVICE_REFOUND,o.onDeviceRefound.bind(o))}),a.push({name:i.DEVICE_GONE,handler:s.addEventListener(i.DEVICE_GONE,o.onDeviceByeBye.bind(o))}),o.discoveryState=r.discoveryStates.AVAILABLE,!o.session){var u=new n;o.session=u}return this.disposeInternal=function(){for(;a.length;){var e=a.pop();t.removeEventListener(e.name,e.handler)}o.session&&o.session.dispose()},this};a.prototype=Object.create(c.prototype),a.prototype.onDeviceByeBye=function(e){var t=this;e.device===t&&(t.discoveryState=r.discoveryStates.UNAVAILABLE,o.newMarker(o.EVENTS.DEVICE_GONE,this.id))},a.prototype.updateDeviceInfo=function(e){var t=this;t.ipAddress=e.ipAddress,t.friendlyName=e.friendlyName,t.lastSeen=(new Date).valueOf(),t.isGuestMode=s.current.castGuestModeEnabled&&e.isGuestMode||!1},a.prototype.onDeviceRefound=function(e){var t=this;e.device===t&&(t.updateDeviceInfo.call(t,e.deviceInfo),t.discoveryState=r.discoveryStates.AVAILABLE,s.current.scheduler.async(t.refresh.bind(t)))},a.prototype.persistentType="CastTarget",a.prototype.dispose=function(){var e=this;return c.prototype.dispose.call(e).finally(e.disposeInternal)},a.prototype.disconnectFromApp=function(e){var t=this;return c.prototype.disconnectFromApp.call(t,e).finally(function(){t.session&&(t.session.cleanupCastConnection(),t.canJoinInGuestMode=!1)})},t.exports=a},{"../configuration.js":39,"../discovery/discoveryEvents.js":61,"../enums.js":65,"../logging/logger.js":70,"../profiling/mdxProfiler.js":77,"./mdxTarget.js":50}],44:[function(e,t,n){var r=e("../enums.js"),i=e("../session/castTargetSessionChrome.js"),o=e("./mdxTarget.js"),s=function(e,t,n){var s=this;return o.call(s,e,t),s.session=new i(n,t.config.mdxNamespace),s.discoveryState=r.discoveryStates.AVAILABLE,s.launchState=r.launchStates.LAUNCHED,s};s.prototype=Object.create(o.prototype),s.prototype.persistentType="CastTarget",s.prototype.stopApp=function(){return this.session.stop()},t.exports=s},{"../enums.js":65,"../session/castTargetSessionChrome.js":85,"./mdxTarget.js":50}],45:[function(e,t,n){var r=e("q"),i=e("../logging/logger.js"),o=e("../enums.js"),s=e("../configuration.js"),c=e("./mdxCastTargetBase.js"),a=e("../session/castTargetSessionV2.js"),u=e("../mdxError.js"),d=o.discoveryStates,l=o.launchStates,f=function(e,t){this.evtMgr.fireEvent.call(this,e,t)},p=function(e){if(e.code!==e.NoError){var t=this;t.discoveryState===d.AVAILABLE&&(t.discoveryState=d.PENDING);var n=t.session;n?n.cleanupCastConnection.call(t.session).then(n.end.bind(n,!1)).then(f.bind(t,t.CAST_EVENTS.DISCONNECT,{error:e})):f.call(t,t.CAST_EVENTS.DISCONNECT,{error:e})}},v=function(e){var t=this;t.launchState=l.NOT_LAUNCHED,f.call(t,t.CAST_EVENTS.APP_DISCONNECT,{error:e})},g=function(e){var t=this;t.discoveryState=d.PENDING,f.call(t,t.CAST_EVENTS.SUSPEND,{reason:e})},h=function(e){var t=this;e?(t.discoveryState=d.AVAILABLE,t.launchState=l.LAUNCHED):t.refresh(),f.call(t,t.CAST_EVENTS.RESUME,{rejoinedApp:e})},E=function(e){var t=this;void 0!==e.applicationID&&(t.discoveryState=d.AVAILABLE,e.applicationID===t.discoveryComponent.config.appId?t.launchState=l.LAUNCHED:t.launchState=l.NOT_LAUNCHED,f.call(t,t.CAST_EVENTS.APP_METADATA,{appMetadata:e}))},m=function(e,t,n,r){var i=this,u=null,d=n;return c.call(i,e,t,a),Object.defineProperties(i,{castDevice:{enumerable:!1,get:function(){return d},set:function(e){(d=e)&&i.session.mdxSessionId||(i.deviceMgr=null)}},deviceMgr:{enumerable:!1,get:function(){return u},set:function(e){null===e&&u&&(u.setDelegate(null),i.session.cleanupCastConnection()),u=e}}}),i.addEventListener(i.EVENTS.DISCOVERY_STATE_CHANGED,function(e){e.state===o.discoveryStates.UNAVAILABLE&&(i.session.cleanupCastConnection(),i.deviceMgr=null)}),i.initDeviceManager().then(function(){var e=s.current.scheduler;i.refresh.call(i).finally(e.async.bind(e,r.bind(i)))}),i};m.prototype=Object.create(c.prototype),m.prototype.initDeviceManager=function(){var e=this,t=r.defer();if(e.deviceMgr&&(e.deviceMgr=null),!e.castDevice)return r.reject();var n=NFGCKDeviceManager.jsInitWithDevice;return"function"!=typeof n&&(n=NFGCKDeviceManager.initWithDevice),n(e.castDevice,function(n){var r=NFGCKDeviceManagerDelegate.jsInit;"function"!=typeof r&&(r=NFGCKDeviceManagerDelegate.init);var o=r();if(!n||!o)return i.error("Failed to create cast device manager and delegate",e.id,e.friendlyName),void(e.discoveryState=d.ERROR);var s=e.CAST_EVENTS;o.didConnect=function(){f.call(e,s.CONNECT)},o.didFailToConnect=function(t,n){f.call(e,s.CONNECT_FAILED,{error:n})},o.didDisconnect=function(t,n){p.call(e,n)},o.didSuspendConnection=function(t,n){g.call(e,n)},o.didResumeConnection=function(t,n){h.call(e,n)},o.didConnectToCastApplication=function(t,n,r,i){f.call(e,s.APP_CONNECT,{appMetadata:n,sessionId:r,launched:i})},o.didFailToConnectToApplication=function(t,n){f.call(e,s.APP_CONNECT_FAILED,{error:n})},o.didDisconnectFromApplication=function(t,n){v.call(e,n)},o.didStopApplication=function(){f.call(e,s.APP_STOPPED)},o.didFailToStopApplication=function(t,n){f.call(e,s.APP_STOP_FAILED,{error:n})},o.didReceiveApplicationMetadata=function(t,n){E.call(e,n)},o.didReceiveApplicationStatusText=function(t,n){f.call(e,s.APP_STATUS,{statusText:n})},o.volumeDidChange=function(t,n,r){f.call(e,s.VOLUME_CHANGED,{level:n,isMuted:r})},o.didReceiveActiveInputStatus=function(t,n){f.call(e,s.ACTIVE_INPUT_STATUS,{status:n})},o.didReceiveStandbyStatus=function(t,n){f.call(e,s.STANDBY_STATUS,{status:n})},o.requestDidFail=function(t,n,r){f.call(e,s.REQUEST_FAILED,{requestId:n,error:r})},n.setDelegate(o),e.deviceMgr=n,t.resolve()}),t.promise},m.prototype.connectToApp=function(e,t){var n=this;return n.deviceMgr?c.prototype.connectToApp.call(n,e,t):n.initDeviceManager().then(c.prototype.connectToApp.bind(n,e,t),function(){return r.reject(new u(u.ERRORS.CONNECT_FAILED,"Failed to intialize cast device manager"))})},m.prototype.dispose=function(){var e=this;return c.prototype.dispose.call(e).finally(function(){e.deviceMgr&&(e.deviceMgr.disconnectWithLeave(),e.deviceMgr=null),e.castDevice=null})},m.prototype.stopApp=function(){var e=this,t=r.defer();return e.session&&e.deviceMgr?(e.deviceMgr.stopApplicationWithSessionID(e.session.sessionId,function(){t.resolve()}),t.promise):r.reject()},m.prototype.CAST_EVENTS={CONNECT:"connect",CONNECT_FAILED:"connectFailed",DISCONNECT:"disconnect",SUSPEND:"suspend",RESUME:"resume",APP_CONNECT:"appConnect",APP_CONNECT_FAILED:"appConnectFailed",APP_DISCONNECT:"appDisconnect",APP_STOPPED:"appStopped",APP_STOP_FAILED:"appStopFailed",APP_METADATA:"appMetadata",APP_STATUS:"appStatus",VOLUME_CHANGED:"volumeChanged",ACTIVE_INPUT_STATUS:"activeInputStatus",STANDBY_STATUS:"standbyStatus",REQUEST_FAILED:"requestFailed"},m.prototype.getConnectionState=function(){var e=this,t=r.defer(),n=function(){var n=e.deviceMgr;n.isReconnecting(function(e){e?t.resolve({isReconnecting:!0,isConnected:!1,isConnectedToApp:!1}):n.connectionState(function(e){n.applicationConnectionState(function(r){t.resolve({isReconnecting:!1,isConnected:e===n.ConnectionStateConnected,isConnectedToApp:r===n.ConnectionStateConnected})})})})};return e.deviceMgr?n():e.initDeviceManager().then(n),t.promise},m.prototype.refresh=function(e){var t=this,n=t.launchState===o.launchStates.PENDING,c=r.defer();if(!t.castDevice)return i.warn("MdxCastTargetV2.refresh was invoked but we don't have a cast device instance",t.castDevice),r.reject();var a=function r(i){t.deviceMgr.applicationMetadata.call(t.deviceMgr,function(a){if(i&&void 0===a.applicationID)return void s.current.scheduler.delay(r.bind(t,!1),500);a.applicationID===t.discoveryComponent.config.appId?e&&n?t.connectToApp(o.connectIntents.JOIN).then(function(){t.launchState=l.LAUNCHED,t.getPlayerState()},function(){t.launchState=l.NOT_LAUNCHED}).finally(c.resolve):(t.launchState=l.LAUNCHED,c.resolve()):(t.launchState=l.NOT_LAUNCHED,c.resolve())})};return t.getConnectionState.call(t).done(function(n){n.isReconnecting?s.current.scheduler.delay(t.refresh.bind(t,e),500):n.isConnected?(t.discoveryState=d.AVAILABLE,a(!0)):t.isGuestMode?(t.launchState=l.NOT_LAUNCHED,t.discoveryState===d.PENDING&&(t.discoveryState=d.AVAILABLE),c.reject()):t.session?t.session.createDeviceConnection().done(function(){t.discoveryState=d.AVAILABLE,a(!1)},function(){t.discoveryState=d.UNAVAILABLE,c.reject()}):c.reject()},c.reject),c.promise},t.exports=m},{"../configuration.js":39,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../session/castTargetSessionV2.js":86,"./mdxCastTargetBase.js":43,q:37}],46:[function(e,t,n){var r=(e("../logging/logger.js"),e("../enums.js")),i=e("../discovery/discoveryEvents.js"),o=e("./mdxDevice.js"),s=e("./deviceUtils.js"),c=function(e){e.device===this&&(this.discoveryState=r.discoveryStates.AVAILABLE)},a=function(e){e.device===this&&(this.discoveryState=r.discoveryStates.UNAVAILABLE)},u=function(e,t,n){o.call(this,e,t,n),Object.defineProperties(this,{controllerType:{enumerable:!0,value:e&&e.controllerType||r.controllerTypes.MDX},mdxInfo:{enumerable:!0,writable:!0,value:{location:e.location,isAvailable:!0,capabilities:[],ipAddressAndPort:s.ipAddressAndPortFromLocation(e.location)}},ipAddress:{enumerable:!1,writable:!0,value:""}});var u=[];return u.push({name:i.DEVICE_REFOUND,handler:t.addEventListener(i.DEVICE_REFOUND,c.bind(this))}),u.push({name:i.DEVICE_GONE,handler:t.addEventListener(i.DEVICE_GONE,a.bind(this))}),this.discoveryState=r.discoveryStates.AVAILABLE,this.disposeInternal=function(){for(;u.length;){var e=u.pop();t.removeEventListener(e.name,e.handler)}},this};u.prototype=Object.create(o.prototype),u.prototype.CONTROLLER_TYPES=r.controllerTypes,u.prototype.getPersistentData=function(){return this.controllerType!==r.controllerTypes.MDX?null:o.prototype.getPersistentData.call(this)},u.prototype.dispose=function(){return this.disposeInternal(),o.prototype.dispose.call(this)},t.exports=u},{"../discovery/discoveryEvents.js":61,"../enums.js":65,"../logging/logger.js":70,"./deviceUtils.js":41,"./mdxDevice.js":47}],47:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../enums.js"),c=e("./deviceEvents.js"),a=e("../profiling/mdxProfiler.js"),u=e("../eventManager.js"),d=e("../mdxError.js"),l=e("./mdxMsgStreamBinding.js"),f=function(e,t,n){var r=this,a=s.discoveryStates.UNKNOWN,d=new u,l=new u,f=e&&e.mdxUuid,p=e&&e.currentMdxId,v=e&&e.sharedSecret,g=n;return g&&(g.device=this),Object.defineProperties(this,{id:{enumerable:!0,value:e&&e.id||parseInt(i.uniqueId((new Date).valueOf())).toString(16)},lastSeen:{enumerable:!0,writable:!0,value:(new Date).valueOf()},evtMgr:{enumerable:!1,get:function(){return d}},msgMgr:{enumerable:!1,get:function(){return l}},discoveryComponent:{enumerable:!1,value:t},discoveryState:{enumerable:!0,get:function(){return a},set:function(e){if(a!==e){a=e,r.onDiscoveryStateUpdated&&r.onDiscoveryStateUpdated.call(r,a);var t={device:r,state:a};a===s.discoveryStates.UNAVAILABLE&&r.shouldShutDownOnUnavailable()&&(t.shouldShutDown=!0);try{d.fireEvent(c.DISCOVERY_STATE_CHANGED,t)}catch(e){o.warn("Event handler exception",e)}}}},isAvailable:{enumerable:!0,get:function(){var e=s.discoveryStates;return a===e.AVAILABLE||a===e.PENDING}},mdxUuid:{enumerable:!0,get:function(){return f},set:function(e){f=e}},currentMdxId:{enumerable:!0,get:function(){return p},set:function(e){p=e}},sharedSecret:{enumerable:!0,get:function(){return v},set:function(e){v=e}},session:{enumerable:!1,get:function(){return g},set:function(e){(g=e)&&(g.device=this)}}}),this.addEventListener=d.addEventListener.bind(this),this.removeEventListener=d.removeEventListener.bind(this),this.addMessageListener=l.addEventListener.bind(this),this.removeMessageListener=l.removeEventListener.bind(this),this};f.prototype.EVENTS=c,f.prototype.DISCOVERY_STATES=s.discoveryStates,f.prototype.LAUNCH_STATES=s.launchStates,f.prototype.shouldShutDownOnUnavailable=function(){return!1},f.prototype.onAppMessage=function(e){try{var t=this;if(a.currentIntent&&("PLAYER_STATE_CHANGED"===e.type?a.currentIntent.processStateChange(e.payload):"AUDIO_SUBTITLES_CHANGED"===e.type&&a.currentIntent.processAudioSubtitlesChanged(e.payload)),t.launchState===s.launchStates.UNKNOWN||t.launchState===s.launchStates.NOT_LAUNCHED)return void o.warn("Dropping app message because the device is not launched. Launch State: "+t.launchState,e);var n=i.merge({device:t},e);t.msgMgr.fireEvent(e.type,n),n.name=n.type,t.evtMgr.fireEvent(c.NEW_APP_MESSAGE,n)}catch(e){o.warn("Msg handler exception",e)}},f.prototype.sendAppMessage=function(e,t){var n,i=this.session;return i?i.errMsgCount>2?(n="Dropping message to device due to session error message threshold exceeded",r.reject(new d(d.ERRORS.MESSAGING_ERROR),n)):i.sendAppMessage(e,t):(n="Device "+this.id+" has no active session. Dropping message",r.reject(new d(d.ERRORS.NOT_CONNECTED),n))},f.prototype.getPersistentData=function(){var e=this;return{type:e.persistentType,id:e.id,mdxUuid:e.mdxUuid,currentMdxId:e.currentMdxId,sharedSecret:e.sharedSecret,lastSeen:e.lastSeen}},f.prototype.clearPairing=function(){var e=this;e.session&&e.session.end(!!e.session.mdxSessionId,!0),e.sharedSecret=null,e.currentMdxId=null},f.prototype.blacklist=function(e){o.error("Device was blacklisted: "+e),this.discoveryState=s.discoveryStates.ERROR},f.prototype.disconnectFromApp=function(){var e=this,t=e.session;if(t){var n=e.launchState===s.launchStates.LAUNCHED&&null!==t.mdxSessionId;return t.end(n,!0)}return r.resolve()},f.prototype.dispose=function(){var e=this;return e.session&&(e.session.end(!1),e.session=null),r.resolve()},f.prototype.onAppConnectionEnded=function(){try{this.evtMgr.fireEvent(c.APP_CONNECTION_ENDED,{device:this})}catch(e){o.error("UI exception handling APP_CONNECTION_ENDED",e,e.stack)}},f.prototype.bindMsgStream=function(e,t,n,r){return new l(this,e,t,n,r)},t.exports=f},{"../../builds/ld.js":1,"../enums.js":65,"../eventManager.js":66,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./deviceEvents.js":40,"./mdxMsgStreamBinding.js":49,q:37}],48:[function(e,t,n){var r=e("../../builds/ld.js"),i=e("../logging/logger.js"),o=e("./deviceUtils.js"),s=e("../discovery/discoveryEvents.js"),c=e("../enums.js"),a=e("../configuration.js"),u=e("./serviceInfo.js"),d=e("../httpFactory.js"),l=e("../discovery/discoveryUtils.js"),f=e("../session/ping.js"),p=e("./mdxTarget.js"),v=e("../session/dialTargetSession.js"),g=e("../versionInfo.js"),h={},E=function(){r.forEach(h[this.id],function(e){a.current.scheduler.cancelDelay(e)})},m=function(e){var t=this;if(e.isMdx){var n=function(){t.launchState=c.launchStates.NOT_LAUNCHED,t.session&&t.session.end(!1,!0),t.dialInfo.isAvailable||(t.discoveryState=c.discoveryStates.UNAVAILABLE),t.mdxInfo.isAvailable=!1};t.session?f.pingTarget.call(t.session,t).done(function(){y.call(t,a.current.scheduler,e)},n):n()}else if(e.isDial){var r=d.createHttpClient(a.current.platform);r.get(t.dialInfo.dialAppUrl).done(function(){y.call(t,a.current.scheduler,e)},function(e){t.mdxInfo.isAvailable||(t.discoveryState=c.discoveryStates.UNAVAILABLE),t.dialInfo.isAvailable=!1})}},y=function(e,t){var n=this,r=h[n.id];r||(r=h[n.id]={});var i=t.toNonVersionedString();r[i]&&e.cancelDelay(r[i]),r[i]=e.delay(m.bind(n,t),35e3)},R=function(e,t){if(t.device===this){var n=t.serviceType;y.call(this,e,n)}},S=function(e,t){var n=this;if(t.device===n)if(n.targetRestartDeferred){n.discoveryState=c.discoveryStates.PENDING;var r=function e(t){n.removeEventListener(n.EVENTS.LAUNCH_STATE_CHANGED,e),t.launchState===c.launchStates.LAUNCHED?n.targetRestartDeferred.resolve():n.targetRestartDeferred.reject()};n.addEventListener(n.EVENTS.LAUNCH_STATE_CHANGED,r)}else m.call(n,t.deviceInfo.serviceType)},I=function(e,t){t.isStarted||E.call(this)},T=function(e,t){p.call(this,e,t);var n=this,r=t,i=e.dialInfo||new u.DialInfo(e.dialUsn,e.dialAppUrl),d=new u.MdxInfo(e.mdxUsn,e.headers[l.headers.regMode]);Object.defineProperties(this,{dialInfo:{enumerable:!1,get:function(){return i}},mdxInfo:{enumerable:!1,get:function(){return d}},ipAddress:{enumerable:!1,writable:!0,value:""},registrationMode:{enumerable:!0,get:function(){return d.isAvailable&&d.registrationMode}}}),this.isDeviceMatch=function(e){var t=e.usn,r=e.location||"";return t===i.usn||t===d.usn||n.ipAddress===o.ipAddressFromLocation(r)},n.updateDeviceInfo.call(n,e),n.discoveryState=c.discoveryStates.AVAILABLE;var f=[];f.push({name:s.DEVICE_REFOUND,handler:r.addEventListener(s.DEVICE_REFOUND,R.bind(n,a.current.scheduler))}),f.push({name:s.DEVICE_GONE,handler:r.addEventListener(s.DEVICE_GONE,S.bind(n,a.current.scheduler))}),f.push({name:s.STARTED_STATE_CHANGED,handler:r.addEventListener(s.STARTED_STATE_CHANGED,I.bind(n,a.current.scheduler))});var m=new g(e.headers[l.headers.mdxVersion]);return n.session=new v(m),this.disposeInternal=function(){for(;f.length;){var e=f.pop();t.removeEventListener(e.name,e.handler);h[n.id]&&E.call(n)}},this};T.prototype=Object.create(p.prototype),T.prototype.persistentType="DialTarget",T.prototype.updateDeviceInfo=function(e){var t,n=e.serviceType,s=this;if(n.isDial)t=this.dialInfo,s.launchState===c.launchStates.UNKNOWN&&(s.launchState=c.launchStates.NOT_LAUNCHED),!t.dialAppUrl&&e.dialAppUrl&&(t.dialAppUrl=e.dialAppUrl),t.dialAppUrl&&t.updateDialInfo();else if(n.isMdx){if(t=this.mdxInfo,t.isAvailable=!0,s.mdxUuid=e.usn.substr(5),e.headers){var u=e.headers,d=u[l.headers.caps]||u[l.headers.caps.toLowerCase()],f=u[l.headers.regMode]||u[l.headers.regMode.toLowerCase()],p=f?r.find(c.registrationModes,function(e){return e===f}):c.registrationModes.DISABLED;t.capabilities=d?d.split(","):[],t.registrationMode=p,s.isRegistered="1"===(u[l.headers.registered]||u[l.headers.registered.toLowerCase()]),s.isMsl="1"===(u[l.headers.msl]||u[l.headers.msl.toLowerCase()]);var v=u[l.headers.mdxVersion];v&&(s.session.mdxVersion=new g(v))}}else i.warn("MdxDialTarget cannot update device information",e);t.serviceType=e.serviceType,t.location=e.location,t.usn=e.usn,s.discoveryState=c.discoveryStates.AVAILABLE,s.ipAddress=o.ipAddressFromLocation(t.location),n.isMdx&&(s.launchState=c.launchStates.LAUNCHED);var E=h[s.id];if(E){E[n.toNonVersionedString()]||y.call(s,a.current.scheduler,n)}else y.call(s,a.current.scheduler,n)},T.prototype.getPersistentData=function(){var e=p.prototype.getPersistentData.call(this);return e?r.merge(e,{mdxUsn:this.mdxInfo.usn,dialUsn:this.dialInfo.usn,ipAddress:this.ipAddress}):null},T.prototype.dispose=function(){return this.disposeInternal(),p.prototype.dispose.call(this)},T.prototype.refresh=function(e){var t=this,n=t.launchState===c.launchStates.PENDING,r=function(){t.launchState=c.launchStates.LAUNCHED,y.call(t,a.current.scheduler,t.mdxInfo.serviceType),e&&n&&t.getPlayerState()};t.dialInfo&&t.dialInfo.isAvailable&&m.call(t,t.dialInfo.serviceType),t.mdxInfo&&t.mdxInfo.isAvailable&&t.session&&t.session.verifyTargetLaunched(t,!1).timeout(3e3).done(r,m.bind(t,t.mdxInfo.serviceType))},T.prototype.suspendDiscovery=function(e){p.prototype.suspendDiscovery.call(this,e),E.call(this)},t.exports=T},{"../../builds/ld.js":1,"../configuration.js":39,"../discovery/discoveryEvents.js":61,"../discovery/discoveryUtils.js":63,"../enums.js":65,"../httpFactory.js":67,"../logging/logger.js":70,"../session/dialTargetSession.js":87,"../session/ping.js":95,"../versionInfo.js":106,"./deviceUtils.js":41,"./mdxTarget.js":50,"./serviceInfo.js":51}],49:[function(e,t,n){var r=e("../../builds/ld.js"),i=e("../configuration.js"),o=e("../mdxError.js"),s=function(e){var t=this;t.listener&&t.listener.call(t,e.type,e.payload,t)},c=function(e){var t=this;t.delayId&&i.current.scheduler.cancelDelay(t.delayId),r.forEach(t.msgNames,function(e){t.device.removeMessageListener(e,t.onStreamMessage)}),t.onStopped&&t.onStopped(e),t.onStopped=null,t.listener=null,t.msgNames=null},a=function(e,t,n,a,u){var d=this,l="function"==typeof u?u:null;return Object.defineProperties(d,{device:{enumerable:!1,writable:!1,value:e},msgNames:{enumerable:!1,writable:!1,value:t},listener:{enumerable:!0,writable:!0,value:a},onStopped:{enumerable:!0,get:function(){return l},set:function(e){if(null!=e&&"function"!=typeof e)throw new o(o.ERRORS.INVALID_ARG,"MdxMsgStreamBinding.onStopped must be a function");l=e}},onStreamMessage:{enumerable:!1,writable:!1,value:s.bind(d)},delayId:{enumerable:!1,writable:!0,value:null}}),r.forEach(t,function(t){e.addMessageListener(t,d.onStreamMessage)}),parseInt(n)>0&&(d.delayId=i.current.scheduler.delay(c.bind(d,!0),n)),this};a.prototype.stop=function(){c.call(this,!1)},t.exports=a},{"../../builds/ld.js":1,"../configuration.js":39,"../mdxError.js":76}],50:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("./deviceEvents.js"),c=e("../enums.js"),a=e("../configuration.js"),u=e("../profiling/mdxProfiler.js"),d=e("../discovery/discoveryUtils.js"),l=e("./mdxDevice.js"),f=e("../mdxError.js"),p=[f.ERRORS.USER_MISMATCH.code,f.ERRORS.REGISTRATION_NOT_SUPPORTED.code,f.ERRORS.APP_NOT_RUNNING.code,f.ERRORS.CANCELLED.code],v=function(e,t){l.call(this,e,t);var n=this,r=e&&e.friendlyName||"Device "+this.id,i=c.launchStates.UNKNOWN;return Object.defineProperties(this,{friendlyName:{enumerable:!0,get:function(){return r},set:function(e){if(r!==e){var t={device:n,property:"friendlyName",oldValue:r,newValue:e};r=e;try{n.evtMgr.fireEvent(s.PROPERTY_CHANGED,t)}catch(e){o.warn("Event handler exception",e)}}}},launchState:{enumerable:!0,get:function(){return i},set:function(e){i!==e&&(i=e,i===c.launchStates.NOT_LAUNCHED&&n.session&&n.session.end(!1,!0),n.evtMgr.fireEvent(s.LAUNCH_STATE_CHANGED,{device:n,launchState:i}))}},isRegistered:{enumerable:!1,writable:!0,value:!(!e||!e.headers||"1"!==(e.headers[d.headers.registered]||e.headers[d.headers.registered.toLowerCase()]))},isMsl:{enumerable:!1,writable:!0,value:!(!e||!e.headers||"1"!==(e.headers[d.headers.msl]||e.headers[d.headers.msl.toLowerCase()]))},targetType:{enumerable:!1,writable:!1,value:n.persistentType}}),this};v.prototype=Object.create(l.prototype),v.prototype.onDiscoveryStateUpdated=function(e){switch(e){case c.discoveryStates.UNAVAILABLE:case c.discoveryStates.ERROR:this.launchState=c.launchStates.NOT_LAUNCHED;break;case c.discoveryStates.PENDING:this.launchState=c.launchStates.PENDING}},v.prototype.getPersistentData=function(){var e=l.prototype.getPersistentData.call(this);return i.merge(e,{friendlyName:this.friendlyName})},v.prototype.CONNECT_INTENTS=c.connectIntents,v.prototype.connectToApp=function(e,t){var n=this,i=n.id,s=n.session,a=u.newEvent(u.EVENTS.CONNECT,n.id),d=c.connectIntents;if(e!==d.JOIN&&e!==d.LAUNCH&&e!==d.LAUNCH_AND_CONTROL)return r.reject(new f(f.ERRORS.INVALID_ARG,"Invalid connect intent specified"));if(t=t||s.device.discoveryComponent.config.defaultLaunchArgs,o.info("Attempting to connect to target "+i+" with intent "+e+" and payload "+t),!n.isAvailable)return r.reject(new f(f.ERRORS.CONNECT_FAILED,"Cannot connect to a device that isn't available"));var l=r.defer();return s.connectToTarget(e,t,a).timeout(12e4,"Timed out waiting for the target connection to complete").then(function(){o.info("Connection successfully established to "+i),l.resolve()},function(e){e&&-1===p.indexOf(e.code)&&(o.error("Failed to connect to "+i,e),s.end(!1)),n.launchState===c.launchStates.PENDING&&(n.launchState=c.launchStates.NOT_LAUNCHED),l.reject(e||new f(f.ERRORS.CONNECT_FAILED,e&&e.message))}).finally(function(){a.complete()}),l.promise},v.prototype.cancelPendingConnections=function(){this.session&&this.session.cancelPendingConnections()},v.prototype.disconnectFromApp=function(e){var t,n=this,r=n.session;return r&&(r.cancelPendingConnections(),r.disconnectDeferred&&(t=r.disconnectDeferred.promise)),t=t||l.prototype.disconnectFromApp.call(n),e&&"function"==typeof n.stopApp&&(t=t.then(n.stopApp.bind(n)).timeout(2e3,"Timed out trying to stop the target application")),t};var g=function(e){e.failed("Failed ack")},h=function(e,t){return e.ack(),t.toString()};v.prototype.play=function(e,t,n){var r=this,o=u.registerUserIntent("PLAY",r),s={catalogId:e,trackId:t,esn:a.current.mdxUuid},c=i.merge(s,n||{});return r.sendAppMessage("PLAYER_PLAY",c).then(h.bind(r,o),g.bind(r,o))},v.prototype.pause=function(e,t){var n=this,r=u.registerUserIntent("PAUSE",n,e),o=i.merge({xid:e},t||{});return n.sendAppMessage("PLAYER_PAUSE",o).then(h.bind(n,r),g.bind(n,r))},v.prototype.resume=function(e,t){var n=this,r=u.registerUserIntent("RESUME",n,e),o=i.merge({xid:e},t||{});return n.sendAppMessage("PLAYER_RESUME",o).then(h.bind(n,r),g.bind(n,r))},v.prototype.stop=function(e,t){var n=this,r=u.registerUserIntent("STOP",n,e),o=i.merge({xid:e},t||{});return n.sendAppMessage("PLAYER_STOP",o).then(h.bind(n,r),g.bind(n,r))},v.prototype.skip=function(e,t,n){var r=this,o=u.registerUserIntent("SKIP",r,e),s=i.merge({xid:e,seconds:t},n||{});return r.sendAppMessage("PLAYER_SKIP",s).then(h.bind(r,o),g.bind(r,o))},v.prototype.skipIntro=function(e,t,n){var r=this,o=u.registerUserIntent("SKIP_SEGMENT",r,e,{invoc_src:t}),s=i.merge({xid:e},n||{});return r.sendAppMessage("PLAYER_SKIP_INTRO",s).then(h.bind(r,o),g.bind(r,o))},v.prototype.setTime=function(e,t,n){var r=this,o=u.registerUserIntent("SET_TIME",r,e),s=i.merge({xid:e,time:t},n||{});return r.sendAppMessage("PLAYER_SET_CURRENT_TIME",s).then(h.bind(r,o),g.bind(r,o))},v.prototype.autoAdvance=function(e,t,n){var r=this,o=u.registerUserIntent("AUTO_ADVANCE",r,e),s=i.merge({xid:e,autoAdvanceMaxIncrement:t},n||{});return r.sendAppMessage("PLAYER_SET_AUTO_ADVANCE",s).then(h.bind(r,o),g.bind(r,o))},v.prototype.setVolume=function(e,t,n){var r=this,o=u.registerUserIntent("SET_VOLUME",r,e),s=i.merge({xid:e,volume:t},n||{});return r.sendAppMessage("PLAYER_SET_VOLUME",s).then(h.bind(r,o),g.bind(r,o))},v.prototype.getPlayerState=function(e){return this.sendAppMessage("PLAYER_GET_CURRENT_STATE",e||{})},v.prototype.getCapabilities=function(e){return this.sendAppMessage("PLAYER_GET_CAPABILITIES",e||{})},v.prototype.getAudioSubtitles=function(e,t){var n=i.merge({xid:e},t||{});return this.sendAppMessage("GET_AUDIO_SUBTITLES",n)},v.prototype.setAudioSubtitles=function(e,t,n){var r=this,o="SET_AUDIO_SUBTITLES",s=u.registerUserIntent(o,r,n&&n.xid),c=i.merge({audio_track_id:e,timed_text_track_id:t},n||{});return r.sendAppMessage(o,c).then(h.bind(r,s),g.bind(r,s))},v.prototype.dismissPostPlay=function(e,t){var n=this,r=u.registerUserIntent("DISMISS_POSTPLAY",n,e),o=i.merge({xid:e},t||{});return n.sendAppMessage("POSTPLAY_STOP",o).then(h.bind(n,r),g.bind(n,r))},v.prototype.trackRestart=function(e){var t=r.defer();return this.targetRestartDeferred=t,t.promise.timeout(e,"Timed out waiting for a target to successfully restart")},v.prototype.suspendDiscovery=function(e){this.isAvailable&&(this.discoveryState=e?c.discoveryStates.PENDING:c.discoveryStates.UNAVAILABLE)},t.exports=v},{"../../builds/ld.js":1,"../configuration.js":39,"../discovery/discoveryUtils.js":63,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./deviceEvents.js":40,"./mdxDevice.js":47,q:37}],51:[function(e,t,n){var r=e("q"),i=e("../enums.js"),o=e("./deviceUtils.js"),s=e("../configuration.js"),c=e("../httpFactory.js"),a=/<state>(.*)<\/state>/,u=/<port>(.*)<\/port>/,d=/<capabilities>(.*)<\/capabilities>/,l=/<options.*allowStop="(.*)".*\/>/,f=/<service.*dialVer="(.*?)".*>/,p=function(e){var t=e||null;return Object.defineProperties(this,{isAvailable:{enumerable:!0,writable:!0,value:!1},location:{enumerable:!0,writable:!0,value:null},usn:{enumerable:!0,get:function(){return t},set:function(e){t!==e&&(t=e,s.current.storage.storeDeviceMap(s.current.dscMgr.devices))}},serviceType:{enumerable:!0,writable:!0,value:null}}),this},v=function(e,t){p.call(this,e,t);var n;return Object.defineProperties(this,{dialAppUrl:{enumerable:!0,get:function(){return n},set:function(e){e&&(e.lastIndexOf("/Netflix")!==e.length-("Netflix".length+1)&&("/"!==e[e.length-1]&&(e+="/"),e+="Netflix"),n=e)}},state:{enumerable:!0,writable:!0,value:""},port:{enumerable:!0,writable:!0,value:""},caps:{enumerable:!0,writable:!0,value:[]},allowStop:{enumerable:!0,writable:!0,value:!1},dialVer:{enumerable:!0,writable:!0,value:""}}),t&&(this.dialAppUrl=t),this};v.prototype=Object.create(p.prototype),v.prototype.updateDialInfo=function(){var e=r.defer(),t=this;return t.dialAppUrl?(c.createHttpClient(s.current.platform).get(t.dialAppUrl).done(function(n){var r,i,o,s,c;n&&(r=a.exec(n),i=u.exec(n),o=d.exec(n),s=l.exec(n),c=f.exec(n),r&&(t.state=r[1]),i&&(t.port=i[1]),o&&(t.caps=o[1]?o[1].split(/\s/g):[]),s&&(t.allowStop="true"===(s[1]+"").toLowerCase()),c&&(t.dialVer=c[1])),t.isAvailable=!0,e.resolve(t)},e.reject),e.promise.timeout(3e3)):r.reject()};var g=function(e,t){return p.call(this,e),Object.defineProperties(this,{registrationMode:{enumerable:!0,writable:!0,value:t||i.registrationModes.DISABLED},capabilities:{enumerable:!0,writable:!0,value:[]},ipAddressAndPort:{enumerable:!0,get:function(){return o.ipAddressAndPortFromLocation(this.location)}}}),this};g.prototype=Object.create(p.prototype),t.exports={DialInfo:v,MdxInfo:g}},{"../configuration.js":39,"../enums.js":65,"../httpFactory.js":67,"./deviceUtils.js":41,q:37}],52:[function(e,t,n){
var r=e("q"),i=e("../logging/logger.js"),o=e("../configuration.js"),s=e("../../builds/ld.js"),c=e("../mdxError.js"),a=e("./discoveryComponent.js"),u=e("../devices/mdxController.js"),d=e("../devices/deviceUtils.js"),l=e("../session/mdxControllerSession.js"),f=e("../versionInfo.js"),p=e("./discoveryEvents.js"),v=e("../enums.js"),g=e("../session/validation.js"),h=e("../session/msgBusFactory.js"),E=function(e){i.error("MDXLIB encountered an error: ",e)},m={mdxMessageBus:null,sessions:{},pendingConnections:{}},y=function(e,t){var n=m.sessions,r=n[e.session.senderId];if(!r)return void i.error("NrdpTargetDiscoveryComponent.processRefoundController session does not exist");t!==r.senderId&&(n[t]=r,delete n[r.senderId],r.senderId=t),e.lastSeen=(new Date).valueOf(),this.evtMgr.fireEvent(p.DEVICE_REFOUND,{device:e})},R=function(e){if(!e.body)return void i.trace("onMdxLibIncomingMessage empty event body, dropping msg...");var t=g.parseAndValidateMsg(e.body);if(null===t)return void i.error("onMdxLibIncomingMessage.parseAndValidateMsg null message");var n,r=t.fromuuid,c=this,a=t.controlleruuid||r,E=s.find(o.current.dscMgr.devices,function(e){return e instanceof u&&e.mdxUuid===a}),R=t.fromurl||t.controllerurl,S=new f(t.version),I=t.opts||{};E?(R&&(E.mdxInfo={location:R,isAvailable:!0,ipAddressAndPort:d.ipAddressAndPortFromLocation(R)}),y.call(c,E,a,new Date),i.trace("onMdxLibIncomingMessage.controller",E),E.session?(i.trace("onMdxLibIncomingMessage.controller  session found",a),E.session.processMdxMessage(e,new Date)):h.createMsgBus(E).fail(function(e){i.error("onMdxLibIncomingMessage. msgBus creation failed:",e)}).then(function(t){E.session=new l(S,a,t,I),m.sessions[a]=E.session,E.session.processMdxMessage(e,new Date)})):(n={id:a,mdxUuid:a,wasLaunchingController:!1,controllerType:v.controllerTypes.MDX,location:R},i.trace("NrdpTargetDiscoveryComponent.retrieveDeviceMapData"),o.current.storage.retrieveDeviceMapData().fail(function(e){i.error("onMdxLibIncomingMessage. retrieveDeviceMapData failed:",e)}).then(function(t){var r=u.prototype.persistentType,o=s.find(t,function(e){return e.type===r&&e.mdxUuid===a});return o&&(i.trace("NrdpTargetDiscoveryComponent. found persisted device for:",a),n=s.merge(o,n)),i.trace("NrdpTargetDiscoveryComponent.retrieveDeviceMapData - new controller"),E=new u(n,c),h.createMsgBus(E).fail(function(e){i.error("onMdxLibIncomingMessage. MsgBus creation failed:",e)}).then(function(t){i.trace("NrdpTargetDiscoveryComponent.retrieveDeviceMapData - new controller session"),E.session=new l(S,a,t,I),m.sessions[a]=E.session,E.session.processMdxMessage(e,new Date),c.evtMgr.fireEvent.call(c,p.DEVICE_FOUND,{device:E})})}).fail(function(){}).done())},S=[{name:"error",handler:E},{name:"incomingmessage",handler:R}],I=function(){var e=r.defer(),t=function t(n){nrdp.mdx.removeEventListener("statechanged",t),e.resolve()};return nrdp.mdx.addEventListener("statechanged",t),nrdp.mdx.MdxDeinit(),e.promise},T=function(){var e=r.defer(),t=this,n=t.config,s=nrdp.device.ESN,a=nrdp.mdx.localIPAddress,u=n&&n.mdxPort;o.current.localMdxPort=u;var d=!1;i.trace("initializeMdxLib componentConfig:",t.config);var l=function(n){i.trace("handleInitResult: ",n),n.errorcode&&0!==n.errorcode&&(400!==n.errorcode||t.networkId?(i.error("MDXLIB Initialization failure",n),e.reject(n)):(i.warn("MDXLIB returned MdxError_NoConnection but we don't have one so initialization is complete"),e.resolve()))},f=function t(n){if(!d)return i.trace("External service holding Mdx no longer initialized, attempting init now"),d=!0,void nrdp.mdx.MdxInit(a,void 0,"urn:mdx-netflix-com:service:target:3",s,!0,!1,l);nrdp.mdx.removeEventListener("statechanged",t),nrdp.mdx.removeEventListener("error",p),n.state===nrdp.mdx.NOT_INITIALIZED?(i.error("MDXLIB initialization failed unexpectedly",n),e.reject(new c(c.ERRORS.START_ERROR,"MDXLIB_NOT_READY"))):e.resolve()};nrdp.mdx.addEventListener("statechanged",f);var p=function t(){nrdp.mdx.removeEventListener("error",t),nrdp.mdx.removeEventListener("statechanged",f),e.reject(new c(c.ERRORS.START_ERROR,"MDXLIB_ERROR"))};nrdp.mdx.addEventListener("error",p);var v=function(){var e,t=[],n=o.current.responseHeaders;i.trace("applyDeviceReplyHeaders headers=",n);for(e in n)n.hasOwnProperty(e)&&t.push(e+": "+n[e]);nrdp.mdx.SetDeviceReplyHeaders&&nrdp.mdx.SetDeviceReplyHeaders(t)};return i.trace("Initializing MDXLIB host: "+a+", port: "+u+", serviceType: undefined, esn: "+s+", asyncHttpRequests: true, isWebsocketServer: false"),nrdp.mdx.INITIALIZED!==nrdp.mdx.state?(d=!0,nrdp.mdx.MdxInit(a,void 0,"urn:mdx-netflix-com:service:target:3",s,!0,!1,l)):nrdjs&&nrdjs.mdxSelfDiscovery&&nrdjs.mdxSelfDiscovery.state!==nrdjs.mdxSelfDiscovery.STATES.DISABLED?i.trace("MDX is initialized by nrdjs.  Waiting for De-init."):(i.info("MDX is initialized by another service.  De-initializing immediately."),I.call(this).then(function(){})),e.promise.timeout(9e3).finally(function(){var e=!1,t=function(){i.trace("mdx : RevealTargetPresence callback"),e||(e=!0,i.trace("mdx : RevealTargetPresence cb applying"),v())};nrdp.mdx.removeEventListener("statechanged",f),i.trace("mdx : RevealTargetPresence "),nrdp.mdx.RevealTargetPresence(t),setTimeout(t,350)})},A=function(e){if(!e)return this;a.call(this,e,"MDX-NRDP","mdx");var t=this;return this.targetInstanceType=u,this.start=function(){return s.forEach(S,function(e){var n=e.handler.bind(t);e.boundhandler=n,nrdp.mdx.addEventListener(e.name,e.boundhandler)}),T.call(t).then(function(){t.isStarted=!0})},this.stop=function(){return s.forEach(S,function(e){nrdp.mdx.removeEventListener(e.name,e.boundhandler),e.boundhandler=void 0}),m.mdxMessageBus=null,I.call(this).then(function(){t.isStarted=!1})},this};A.prototype=Object.create(a.prototype),t.exports=A},{"../../builds/ld.js":1,"../configuration.js":39,"../devices/deviceUtils.js":41,"../devices/mdxController.js":46,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../session/mdxControllerSession.js":89,"../session/msgBusFactory.js":92,"../session/validation.js":98,"../versionInfo.js":106,"./discoveryComponent.js":59,"./discoveryEvents.js":61,q:37}],53:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../configuration.js"),c=e("./discoveryEvents.js"),a=e("../profiling/mdxProfiler.js"),u=e("./discoveryUtils.js"),d=e("../enums.js"),l=e("./discoveryComponent.js"),f=e("../devices/mdxCastTargetChrome.js"),p=e("../mdxError.js"),v=function(e){this.evtMgr.fireEvent(c.MDX_DEVICES_AVAILABLE,{available:e===chrome.cast.ReceiverAvailability.AVAILABLE})},g={mdxUuid:u.nonEmptyString,friendlyName:u.nonEmptyString,ipAddress:u.nonEmptyString},h=function(e,t){var n=this,r=e.receiver,o=r.label?r.label.substr(5):"",l={mdxUuid:o,friendlyName:r.friendlyName,ipAddress:r.ipAddress||"0.0.0.0"};if(u.isValidDeviceInfo(l,g)){var p=s.current.dscMgr.getDeviceByMdxUuid(o);if(p)return p.discoveryState=d.discoveryStates.AVAILABLE,p.launchState=d.launchStates.LAUNCHED,p.session.castSession=e,n.evtMgr.fireEvent(c.DEVICE_REFOUND,{device:p,deviceInfo:l}),void(t&&t.resolve(p));s.current.storage.retrieveDeviceMapData().then(function(r){var o=f.prototype.persistentType;i.find(r,function(e){return e.type===o&&e.mdxUuid===l.mdxUuid&&(l.id=e.id,!0)}),p=new f(l,n,e),a.addDevice(p.id,{name:p.id}),a.newMarker(a.EVENTS.DEVICE_FOUND,p.id),n.evtMgr.fireEvent(c.DEVICE_FOUND,{device:p}),t&&t.resolve(p)}).fail(function(){}).done()}},E=function(e){h.call(this,e)},m=function(e,t){try{"cast"===t?this.evtMgr.fireEvent(c.START_CONNECTING,{}):"stop"===t&&this.evtMgr.fireEvent(c.START_DISCONNECTING,{})}catch(e){o.warn("castReceiverConnectionListener exception",e)}},y=function(e){var t=this;return l.call(t,e,"CAST-CHROME","cast"),t.targetInstanceType=f,t.start=function(){if(!chrome||!chrome.cast||!chrome.cast.isAvailable)return r.reject(new p(p.ERRORS.START_ERROR,"CAST SDK is not available"));var e=t.config.appId;o.info.always("Initializing Cast SDK - Version: "+chrome.cast.VERSION.join(".")+" - AppId: "+e);var n=r.defer(),i=s.current;chrome.cast.timeout.requestSession=i.castSessionRequestTimeout;var c=new chrome.cast.SessionRequest(e),a=new chrome.cast.ApiConfig(c,E.bind(this),v.bind(this),i.castAutoJoinPolicy||chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,i.castDefaultActionPolicy||chrome.cast.DefaultActionPolicy.CREATE_SESSION);return chrome.cast.initialize(a,function(){t.isStarted=!0,chrome.cast.addReceiverActionListener(m.bind(t)),n.resolve()},function(e){o.error("CAST SDK initialization failure!",e),n.reject(new p(p.ERRORS.START_ERROR,"CAST SDK Initialization failed. Code: "+e&&e.code+" - Description: "+e&&e.description))}),n.promise},t.stop=function(){return r.reject(new p(p.ERRORS.PLATFORM_SUPPORT_ERROR))},t.requestMdxDevice=function(){var e=r.defer(),n=function(t){try{var n=t&&t.friendlyName||"";e.notify({friendlyName:n})}catch(e){}};return chrome.cast.addReceiverActionListener(n),chrome.cast.requestSession(function(r){chrome.cast.removeReceiverActionListener(n),h.call(t,r,e)},function(t){var n;switch(t.code){case chrome.cast.ErrorCode.CANCEL:n=new p(p.ERRORS.CANCELLED);break;default:var r="CAST SDK session request failed. Code: "+t&&t.code+" - Description: "+t&&t.description;o.error(r),n=new p(p.ERRORS.CONNECT_FAILED,r)}e.reject(n)}),e.promise},this};y.prototype=Object.create(l.prototype),t.exports=y},{"../../builds/ld.js":1,"../configuration.js":39,"../devices/mdxCastTargetChrome.js":44,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./discoveryComponent.js":59,"./discoveryEvents.js":61,"./discoveryUtils.js":63,q:37}],54:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../profiling/mdxProfiler.js"),c=e("./discoveryUtils.js"),a=e("./discoveryEvents.js"),u=e("../configuration.js"),d=e("./discoveryComponent.js"),l=e("../devices//mdxCastTargetV2.js"),f=e("../mdxError.js"),p=null,v=null,g={},h={mdxUuid:c.nonEmptyString,friendlyName:c.nonEmptyString,ipAddress:c.nonEmptyString,isGuestMode:function(e){return"boolean"==typeof e}},E=function(e){if(u.current.ignoreDeviceFlapping&&g[e.deviceID])return void delete g[e.deviceID];if(e.isOnLocalNetwork||u.current.castGuestModeEnabled){var t=this,n=e.deviceID,r={mdxUuid:n,friendlyName:e.friendlyName,ipAddress:e.ipAddress,isGuestMode:!e.isOnLocalNetwork};if(c.isValidDeviceInfo(r,h)){var o=u.current.dscMgr.getDeviceByMdxUuid(n);if(o)return o.castDevice=e,void t.evtMgr.fireEvent(a.DEVICE_REFOUND,{device:o,deviceInfo:r});u.current.storage.retrieveDeviceMapData().then(function(n){var c=l.prototype.persistentType;i.find(n,function(e){return e.type===c&&e.mdxUuid===r.mdxUuid&&(r.id=e.id,!0)}),o=new l(r,t,e,function(){s.addDevice(o.id,{name:o.id}),s.newMarker(s.EVENTS.DEVICE_FOUND,o.id),t.evtMgr.fireEvent(a.DEVICE_FOUND,{device:o})})}).fail(function(){}).done()}}},m=function(e){var t=function(){var t=u.current.dscMgr.getDeviceByMdxUuid(e.deviceID);t&&(t.castDevice=e,this.evtMgr.fireEvent(a.DEVICE_GONE,{device:t}))}.bind(this);u.current.ignoreDeviceFlapping?(g[e.deviceID]=e,r.delay(500).then(function(){g[e.deviceID]&&(delete g[e.deviceID],t())})):t()},y=function(e){var t=this,n=e.deviceID,r={mdxUuid:n,friendlyName:e.friendlyName,ipAddress:e.ipAddress,isGuestMode:!e.isOnLocalNetwork};if(c.isValidDeviceInfo(r,h)){var i=u.current.dscMgr.getDeviceByMdxUuid(n);i&&t.evtMgr.fireEvent(a.DEVICE_REFOUND,{device:i,deviceInfo:r})}},R=[{name:"enterBackground",handler:function(){this.suspendDiscovery()}},{name:"enterForeground",handler:function(){this.resumeDiscovery()}}],S=function(){var e=r.defer(),t=this,n=t.config.appId;o.info.always("Initializing Cast SDK - Version: "+NFGCKFrameworkVersion+" - AppId: "+n);var s=c.processIflist(nrdp.device.iflist);t.networkId=c.networkIdFromInterface(s),i.forEach(R,function(e){e.handler=e.handler.bind(t),nrdp.device.addEventListener(e.name,e.handler)});var a=NFGCKFilterCriteria.criteriaForAvailableApplicationWithID(n),u=NFGCKDeviceScanner.jsInitWithFilterCriteria;return"function"!=typeof u&&(u=NFGCKDeviceScanner.initWithFilterCriteria),u(a,function(n){if(!n)return void e.reject(new f(f.ERRORS.START_ERROR,"No cast scanner instance"));p=n;var r=NFGCKDeviceScannerListener.jsInit;"function"!=typeof r&&(r=NFGCKDeviceScannerListener.init),v=r(),v.didComeOnline=E.bind(t),v.didGoOffline=m.bind(t),v.didChange=y.bind(t),p.addListener(v),p.startScan(),e.resolve()}),e.promise},I=function(){return o.info.always("Uninitializing Cast SDK"),i.forEach(R,function(e){nrdp.device.removeEventListener(e.name,e.handler)}),p.stopScan(),p.removeListener(v),delete v.didComeOnline,delete v.didGoOffline,delete v.didChange,v=null,p=null,r.resolve()},T=function(e){d.call(this,e,"CAST-IOS","cast");var t=this;return Object.defineProperties(this,{targetInstanceType:{enumerable:!1,writable:!1,value:l}}),this.start=function(e,n){var i=r.defer(),o=n.newSubEvent(s.EVENTS.START_CAST_DISC);return S.call(t).done(function(){t.isStarted=!0,o.complete(),i.resolve()},function(e){i.reject(e)}),i.promise},this.stop=function(e){var n=r.defer(),i=e.newSubEvent(s.EVENTS.STOP_CAST_DISC);return I.call(t).done(function(){t.isStarted=!1,i.complete(),n.resolve()},function(e){n.reject(e)}),n.promise},this};T.prototype=Object.create(d.prototype),T.prototype.suspendDiscovery=function(){u.current.suspendDiscoveryOnBackground&&d.prototype.suspendDiscovery.call(this,!0)},T.prototype.resumeDiscovery=function(){u.current.suspendDiscoveryOnBackground&&d.prototype.resumeDiscovery.call(this)},t.exports=T},{"../../builds/ld.js":1,"../configuration.js":39,"../devices//mdxCastTargetV2.js":45,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./discoveryComponent.js":59,"./discoveryEvents.js":61,"./discoveryUtils.js":63,q:37}],55:[function(e,t,n){var r,i,o,s=e("q"),c=e("../../builds/ld.js"),a=e("../logging/logger.js"),u=e("../profiling/mdxProfiler.js"),d=e("../enums.js"),l=e("./discoveryEvents.js"),f=e("../configuration.js"),p=e("./discoveryComponent.js"),v=e("../session/castControllerSession.js"),g=e("../devices/mdxCastController.js"),h=e("../versionInfo.js"),E=e("../eventManager.js"),m={mediaManager:null,mdxMessageBus:null,mediaMessageBus:null,sessions:{},pendingConnections:{}},y=function(e,t,n){var r=m.sessions,i=r[e.session.senderId];t!==i.senderId&&(r[t]=i,delete r[i.senderId],i.senderId=t),e.lastSeen=(new Date).valueOf(),this.evtMgr.fireEvent(l.DEVICE_REFOUND,{device:e}),u.newMarker(u.EVENTS.DEVICE_REFOUND,e.id,n)},R=function(e,t,n,o){var s=this,a=t.controlleruuid,p=c.find(f.current.dscMgr.devices,function(e){return e instanceof g&&e.mdxUuid===a}),E=new h(t.controllerMdxVersion);f.current.mdxUuid=t.uuid;var R=t.opts||{};if(p)y.call(s,p,e,n),p.session.processMdxMessage(t,new Date),u.newEvent(u.EVENTS.CAST_HANDSHAKE,p.id,o,new Date);else{var S={mdxUuid:a,wasLaunchingController:e===i,controllerType:d.controllerTypes.MDX},I=new v(E,e,m.mdxMessageBus,R);m.sessions[e]=I,f.current.storage.retrieveDeviceMapData().then(function(e){var i=g.prototype.persistentType,o=c.find(e,function(e){return e.type===i&&e.mdxUuid===a});if(o&&(S=c.merge(o,S)),p=new g(S,s,I),I.sendHandshakeResponse.call(I),r){var d=r,v=t.payload||s.config.defaultLaunchArgs;s.isStarted=!0,d.profilerEvent.complete(),f.current.scheduler.cancelDelay(d.defaultLaunchArgsTimeout),d.resolve(v)}s.evtMgr.fireEvent.call(s,l.DEVICE_FOUND,{device:p});var h=u.EVENTS.DEVICE_FOUND;u.addDevice(p.id,{name:p.id}),u.newMarker(h,p.id,n)}).fail(function(){}).done()}},S=function(e){a.warn("New sender connected but did not receive the cast handshake, so requesting it");try{m.mdxMessageBus.send(e,{type:"castHandShakeRequest"})}catch(e){a.error("Unexpected failure to send cast handshake request to the controller",e)}},I=function(e){var t=new Date,n=e.senderId,r=n.substr(n.indexOf(":")+1);if(r){var i=c.find(f.current.dscMgr.devices,function(e){return e instanceof g&&e.session.senderGuid===r});if(i)return void y.call(this,i,n,t)}var o={delayId:f.current.scheduler.delay(S.bind(this,n),2e3),foundTime:t};m.pendingConnections[e.senderId]=o},T=function(e){var t=c.find(f.current.dscMgr.devices,function(t){return t instanceof g&&t.session.senderId===e.senderId});if(t){var n=c.isString(e.reason)&&"requested_by_sender"===e.reason.toLowerCase()||!1;t.wasExplicitLastDisconnect=n,u.newMarker(u.EVENTS.DEVICE_GONE,t.id),this.evtMgr.fireEvent(l.DEVICE_GONE,{device:t})}},A=function(e){var t=new Date,n=e.senderId,r=m.sessions[n],i=m.pendingConnections[n];if(r)r.processMdxMessage(e.data,t);else if(i){f.current.scheduler.cancelDelay(i.delayId);var o=e.data;if("castHandShake"!==o.type)return void a.error("Initial message for pending connection was not a handshake",e);R.call(this,n,o,i.foundTime,t),delete m.pendingConnections[n]}else a.warn("Received an unexpected message on the cast message bus",e)},O=function(e){var t=e,n=new E,r={READY:"ready",SENDER_CONNECTED:"senderConnected",SENDER_DISCONNECTED:"senderDisconnected",SHUTDOWN:"shutdown",STANDBY_CHANGED:"standbyChanged",VISIBILITY_CHANGED:"visibilityChanged"};Object.defineProperties(this,{systemVolume:{enumerable:!1,writable:!0,value:{level:1,muted:!1}}});var i=function(e,t){try{n.fireEvent(e,t)}catch(e){a.error("Exception when handling CAST receiver event",e,e.stack)}};return t.onReady=i.bind(null,r.READY),t.onSenderConnected=i.bind(null,r.SENDER_CONNECTED),t.onSenderDisconnected=i.bind(null,r.SENDER_DISCONNECTED),t.onShutdown=i.bind(null,r.SHUTDOWN),t.onStandbyChanged=i.bind(null,r.STANDBY_CHANGED),t.onVisibilityChanged=i.bind(null,r.VISIBILITY_CHANGED),this.EVENTS=r,this.addEventListener=n.addEventListener,this.removeEventListener=n.removeEventListener,this.dispose=function(){t.onReady=null,t.onSenderConnected=null,t.onSenderDisconnected=null,t.onShutdown=null,t.onStandbyChanged=null,t.onVisibilityChanged=null,t=null},this},N=function(e){p.call(this,e,"CAST-TARGET","cast");var t=this;return this.targetInstanceType=g,this.start=function(e,n){var c=n.newSubEvent(u.EVENTS.START_CAST_DISC);r=s.defer(),r.profilerEvent=c;var d=cast.receiver.CastReceiverManager.getInstance(),l=new O(d),p=l.EVENTS;l.addEventListener(p.SENDER_CONNECTED,I.bind(t)),l.addEventListener(p.SENDER_DISCONNECTED,T.bind(t)),f.current.castReceiver=l;var v=d.getCastMessageBus(t.config.mdxNamespace,cast.receiver.CastMessageBus.MessageType.JSON);v.onMessage=A.bind(t),m.mdxMessageBus=v;var g=d.getCastMessageBus(cast.receiver.media.MEDIA_NAMESPACE,cast.receiver.CastMessageBus.MessageType.JSON);m.mediaMessageBus=g;var h=function e(t){a.trace("Cast Receiver Manager: onReady",t),l.removeEventListener(l.EVENTS.READY,e),i=t.data.launchingSenderId,o=t.data.sessionId};l.addEventListener(l.EVENTS.READY,h);return r.defaultLaunchArgsTimeout=f.current.scheduler.delay(function(){t.isStarted=!0,r.resolve(t.config.defaultLaunchArgs)},2e3),d.start(void 0),r.promise},this.stop=function(e){var n=e.newSubEvent(u.EVENTS.STOP_CAST_DISC);return f.current.castReceiver.dispose(),f.current.castReceiver=null,m.mdxMessageBus.onMessage=null,m.mdxMessageBus=null,m.mediaMessageBus=null,m.mediaManager=null,t.isStarted=!1,n.complete(),s.resolve()},this};N.prototype=Object.create(p.prototype),N.prototype.dispose=function(){return this.disposeInternal(),p.prototype.dispose.call(this)},t.exports=N},{"../../builds/ld.js":1,"../configuration.js":39,"../devices/mdxCastController.js":42,"../enums.js":65,"../eventManager.js":66,"../logging/logger.js":70,"../profiling/mdxProfiler.js":77,"../session/castControllerSession.js":83,"../versionInfo.js":106,"./discoveryComponent.js":59,"./discoveryEvents.js":61,q:37}],56:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../profiling/mdxProfiler.js"),c=e("../enums.js"),a=e("../configuration.js"),u=e("./discoveryEvents.js"),d=e("./discoveryUtils.js"),l=e("../devices/serviceInfo.js"),f=e("./discoveryComponent.js"),p=e("../devices/mdxDialTarget.js"),v=function(){},g={MDX:{interval:15e3},DIAL:{interval:15e3}},h={MDX:{interval:2e3,autoAdjust:{config:g,count:Math.ceil(2.5)}},DIAL:{interval:2e3,autoAdjust:{config:g,count:Math.ceil(2.5)}}},E={MDX:{interval:2e3,autoAdjust:{config:g,count:Math.ceil(60)}},DIAL:{interval:15e3}},m={serviceType:function(e){return e&&i.isString(e.urn)&&e.urn.length&&i.isString(e.service)&&e.service.length&&e.version>=0},usn:d.nonEmptyString,location:d.nonEmptyString,friendlyName:d.nonEmptyString,headers:function(e){return i.isPlainObject(e)}},y={},R={},S=function(){i.forEach(R,function(e){a.current.scheduler.cancelRepeat(e)})},I=[],T=function(e,t){var n=this;if(!n.isStarted)return void S();if(t.autoAdjust&&--t.autoAdjust.count<=0){var r=t.autoAdjust.config[e];return void A.call(n,e,r)}var i=c.serviceTypes[e];void 0!==n.config.searchVersions[e]&&(i=i+":"+n.config.searchVersions[e]);if(I.length>=10)return void o.error("The SSDP search queue is backed up! Dropping search request",i);I.push(i),1===I.length&&function e(){if(I.length){var t=I[0];t&&n.performSearch(t).timeout(n.config.mx*n.config.searchCount*1e3+500).finally(function(){I.shift(),e()})}}()},A=function(e,t){var n=R[e];n&&a.current.scheduler.cancelRepeat(n);var r=i.clone(t,!0);R[e]=a.current.scheduler.repeat(T.bind(this),r.interval,!0,e,r)},O=function(e,t){if(!t||!e)return this;f.call(this,e,t,"dial");var n=this;return this.targetInstanceType=p,this.start=function(e,t){var i=t.newSubEvent(s.EVENTS.START_DIAL_DISC),o=r.defer();return n.initSearchProvider.call(n,e).finally(function(){i.complete()}).done(function(){n.isStarted=!0,n.enableAggressiveSearch(),o.resolve()},o.reject),o.promise},this.stop=function(e){var t=e.newSubEvent(s.EVENTS.STOP_DIAL_DISC),i=r.defer();return n.isStarted=!1,n.uninitSearchProvider.call(n).finally(function(){S(),t.complete()}).done(i.resolve,i.reject),i.promise},this};O.prototype=Object.create(f.prototype),O.prototype.processFoundDevice=function(e){if(d.isValidDeviceInfo(e,m)){var t=function(t){var n=e.serviceType.isDial?c.serviceTypes.DIAL:c.serviceTypes.MDX,r=e.manufacturer||"Netflix";o.info.always("New device found: "+t.friendlyName,t.mdxUuid,n,t.ipAddress,t.launchState,t.registrationMode,r,e.modelName)},n=this,s=i.find(a.current.dscMgr.availableDevices,function(t){return t instanceof p&&t.isDeviceMatch(e)});if(s)return(e.serviceType.isDial&&!s.dialInfo.isAvailable||e.serviceType.isMdx&&!s.mdxInfo.isAvailable)&&t(s),void s.updateDeviceInfo(e);var f=i.find(a.current.dscMgr.devices,function(t){return t instanceof p&&t.isDeviceMatch(e)});if(f)f.updateDeviceInfo(e),!e.serviceType.isDial||f.dialInfo.isAvailable?n.evtMgr.fireEvent(u.DEVICE_FOUND,{device:f}):f.dialInfo.updateDialInfo().then(function(){n.evtMgr.fireEvent(u.DEVICE_FOUND,{device:f})}).fail(v).done();else{var g,h;e.serviceType.isDial?(h=new l.DialInfo(e.usn,e.dialAppUrl),g=h.updateDialInfo().then(function(){e.dialInfo=h})):g=r.resolve(),g.done(function(){a.current.storage.retrieveDeviceMapData().then(function(r){var o=p.prototype.persistentType,s=i.find(r,function(t){return t.type===o&&(t.dialUsn===e.usn||t.mdxUsn===e.usn)});s&&(e=i.merge(s,e)),f=new p(e,n,void 0),n.evtMgr.fireEvent(u.DEVICE_FOUND,{device:f}),t(f)}).fail(v).done()},function(){})}}},O.prototype.checkIfDeviceTrackedAndProcessRefound=function(e){var t=i.find(a.current.dscMgr.availableDevices,function(t){return t instanceof p&&t.isDeviceMatch(e)});return!!t&&(y[t.id]&&(a.current.scheduler.cancelDelay(y[t.id]),delete y[t.id]),this.evtMgr.fireEvent(u.DEVICE_REFOUND,{device:t,serviceType:e.serviceType}),t.lastSeen=(new Date).valueOf(),!(e.serviceType.isDial&&!t.dialInfo.dialAppUrl)&&(t.updateDeviceInfo(e),!0))},O.prototype.processDeviceByeBye=function(e){var t=this.evtMgr,n=i.find(a.current.dscMgr.availableDevices,function(t){return t instanceof p&&t.isDeviceMatch(e)});n&&(n.launchState===c.launchStates.PENDING?y[n.id]=a.current.scheduler.delay(function(){t.fireEvent(u.DEVICE_GONE,{device:n,deviceInfo:e})},6e3):t.fireEvent(u.DEVICE_GONE,{device:n,deviceInfo:e}))},O.prototype.enablePostLaunchSearch=function(){var e=this;i.forEach(E,function(t,n){A.call(e,n,t)})},O.prototype.enableAggressiveSearch=function(){var e=this;i.forEach(h,function(t,n){A.call(e,n,t)})},O.prototype.refreshDevices=function(){this.enableAggressiveSearch()},O.prototype.suspendDiscovery=function(e){f.prototype.suspendDiscovery.call(this,e),S()},O.prototype.resumeDiscovery=function(){f.prototype.resumeDiscovery.call(this),this.enableAggressiveSearch()},t.exports=O},{"../../builds/ld.js":1,"../configuration.js":39,"../devices/mdxDialTarget.js":48,"../devices/serviceInfo.js":51,"../enums.js":65,"../logging/logger.js":70,"../profiling/mdxProfiler.js":77,"./discoveryComponent.js":59,"./discoveryEvents.js":61,"./discoveryUtils.js":63,q:37}],57:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("./discoveryUtils.js"),c=e("../configuration.js"),a=e("./dialDiscoveryComponent.js"),u=e("./serviceTypeInfo.js"),d=e("../mdxError.js"),l=c.current.utf8,f=c.current.base64,p=function(e){var t=e.desc,n=t?t.root:null;if(n){var r,i,a=e.USN,d=!1;try{var l=n.device;r=l.manufacturer._value,i=l.modelName._value,d=s.isDeviceBlacklisted(r,i)}catch(e){o.warn("Error attempting to process the device blacklisting",e.message,e.stack)}if(d)return void(c.current.dscMgr.blacklistedUsns[a]=!0);var f=n?n.device:null,p=f?f.friendlyName._value:null;if(p){var v={serviceType:new u(e.serviceType),usn:a,location:e.url,friendlyName:p,headers:e.responseHeaders,dialAppUrl:e.responseHeaders&&e.responseHeaders["Application-URL"],manufacturer:r,modelName:i};this.processFoundDevice(v)}}},v=function(e){var t=e.USN,n=c.current.dscMgr.blacklistedUsns;if(!t||!n[t]){var r=new u(e.serviceType),i=e.friendlyName||"";if(i)try{i=l.decode(f.decode(i))}catch(t){o.error("Exception while decoding friendly name",t,e.friendlyName),i=c.current.defaultFriendlyName}var s={serviceType:r,usn:t,location:e.location,friendlyName:i,headers:e.responseHeaders};if(!this.checkIfDeviceTrackedAndProcessRefound(s))switch(r.service){case"dial":nrdp.mdx.DialGetDeviceInfo(e.location,e.USN,r.toNonVersionedString(),5);break;case"target":this.processFoundDevice(s)}}},g=function(e){var t={serviceType:new u(e.serviceType),usn:e.USN};this.processDeviceByeBye(t)},h=function(e){o.error("MDXLIB encountered an error: ",e)},E=function(e){var t=this.config,n=r.defer();return nrdp.mdx.INITIALIZED!==nrdp.mdx.state?r.reject():(nrdp.mdx.SearchForMdxDevices(e,t.headerPatterns,t.mx,t.searchCount,n.resolve),n.promise)},m=function(e){var t=this;e.eventSource===nrdp.mdx.INFO_RESIGNED_ACTIVE?t.suspendDiscovery(!!t.networkId):t.processNetworkStatus({iflist:nrdp.device.iflist})},y=[{name:"error",handler:h},{name:"devicefound",handler:v},{name:"DialDeviceInfoResponse",handler:p},{name:"devicebyebye",handler:g},{name:"interfacechanged",handler:m}],R=function(){var e=r.defer(),t=this,n=t.config,i=nrdp.device.ESN,s=nrdp.mdx.localIPAddress,a=n&&n.mdxPort;c.current.localMdxPort=a;var u=function(t){t.state===nrdp.mdx.NOT_INITIALIZED?(o.error("MDXLIB initialization failed unexpectedly",t),e.reject(new d(d.ERRORS.START_ERROR,"MDXLIB_NOT_READY"))):e.resolve()};nrdp.mdx.addEventListener("statechanged",u);var l=function(n){n.errorcode&&0!==n.errorcode&&(400!==n.errorcode||t.networkId?(o.error("MDXLIB Initialization failure",n),e.reject(n)):(o.warn("MDXLIB returned MdxError_NoConnection but we don't have one so initialization is complete"),e.resolve()))};return nrdp.mdx.MdxInit(s,void 0,i,!0,!1,l),e.promise.timeout(3e3).finally(function(){nrdp.mdx.removeEventListener("statechanged",u)})},S=function(){var e=r.defer(),t=function t(n){nrdp.mdx.removeEventListener("statechanged",t),e.resolve()};return nrdp.mdx.addEventListener("statechanged",t),nrdp.mdx.MdxDeinit(),e.promise},I=function(e){var t=this;return a.call(t,e,"DIAL-NRDP"),t.config&&(t.config.headerPatterns=["X-"]),t.initSearchProvider=function(){var e=s.processIflist(nrdp.device.iflist);return t.networkId=s.networkIdFromInterface(e),i.forEach(y,function(e){var n=e.handler.bind(t);e.boundhandler=n,nrdp.mdx.addEventListener(e.name,n)}),R.call(t).then(function(){t.isStarted=!0})},t.uninitSearchProvider=function(){return i.forEach(y,function(e){nrdp.mdx.removeEventListener(e.name,e.boundhandler)}),S.call(t).then(function(){t.isStarted=!1})},t.performSearch=E,this};I.prototype=Object.create(a.prototype),t.exports=I},{"../../builds/ld.js":1,"../configuration.js":39,"../logging/logger.js":70,"../mdxError.js":76,"./dialDiscoveryComponent.js":56,"./discoveryUtils.js":63,"./serviceTypeInfo.js":64,q:37}],58:[function(e,t,n){var r,i=e("q"),o=e("../../builds/ld.js"),s=e("../logging/logger.js"),c=e("./discoveryUtils.js"),a=e("../configuration.js"),u=e("./dialDiscoveryComponent.js"),d=e("./serviceTypeInfo.js"),l=e("../mdxError.js"),f=a.current.utf8,p=a.current.base64,v=function(e,t){try{var n=e.usn,r=!1,i=t.getElementsByTagName("root")[0],o=i.getElementsByTagName("device")[0];try{var u=o.getElementsByTagName("manufacturer")[0].textContent,d=o.getElementsByTagName("modelName")[0].textContent;r=c.isDeviceBlacklisted(u,d)}catch(e){s.warn("Error attempting to process the device blacklisting",e.message,e.stack)}if(r)return void(a.current.dscMgr.blacklistedUsns[n]=!0);var l=o.getElementsByTagName("friendlyName")[0].textContent;if(!l)return;e.friendlyName=l,this.processFoundDevice(e)}catch(e){}},g=function(e){var t=this,n=e.usn;n&&(n=n.split("::")[0]);var r=a.current.dscMgr.blacklistedUsns;if(!n||!r[n]){var i=new d(e.st),c=e.friendlyName||e["x-friendly-name"]||"";if(c)try{c=f.decode(p.decode(c))}catch(t){s.error("Exception while decoding friendly name",t,e.friendlyName),c=a.current.defaultFriendlyName}var u={serviceType:i,usn:n,location:e.location,friendlyName:c,headers:o.zipObject(o.map(e,function(e,t){return-1!==t.lastIndexOf("x-",0)?[t,e]:null}).filter(function(e){return null!==e}))};if(!this.checkIfDeviceTrackedAndProcessRefound(u))switch(i.service){case"dial":var l={url:u.location,type:"GET"};WinJS.xhr(l).done(function(e){v.call(t,u,e.responseXML)},function(e){});break;case"target":this.processFoundDevice(u)}}},h=function(e){var t=e.usn;t&&(t=t.split("::")[0]);var n={serviceType:new d(e.nt),usn:t};this.processDeviceByeBye(n)},E=function(e){var t=this.config;return r.searchForDevices(t.mx,t.searchCount,[e]),i.delay(t.mx*t.searchCount*1e3+500)},m=[{name:"devicefound",handler:g},{name:"devicelost",handler:h}],y=function(e){var t=this,n=i.defer(),s=e&&e.platformDiscoveryLib;return s?(r=o.isFunction(s)?new s:s,r.start(r.startAsController).done(function(){o.forEach(m,function(e){var n=e.handler.bind(t);e.boundhandler=n,r.addEventListener(e.name,n)}),n.resolve.apply(n,arguments)},n.reject),n.promise):i.reject(new l(l.ERRORS.START_ERROR,"MdxDiscovery.MdxSspDiscoveryManager does not exist"))},R=function(){var e=i.defer();return r.stop().done(function(){o.forEach(m,function(e){r.removeEventListener(e.name,e.boundhandler)}),e.resolve.apply(e,arguments)},e.reject),e.promise},S=function(e){return u.call(this,e,"DIAL-WINJS"),this.initSearchProvider=y,this.uninitSearchProvider=R,this.performSearch=E,this};S.prototype=Object.create(u.prototype),t.exports=S},{"../../builds/ld.js":1,"../configuration.js":39,"../logging/logger.js":70,"../mdxError.js":76,"./dialDiscoveryComponent.js":56,"./discoveryUtils.js":63,"./serviceTypeInfo.js":64,q:37}],59:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("./discoveryConfig.js"),s=e("./discoveryEvents.js"),c=e("./discoveryUtils.js"),a=(e("../logging/logger.js"),e("../configuration.js")),u=e("../enums.js"),d=e("../eventManager.js"),l=function(e,t){var n=o.defaults[t];return i.merge(i.merge({},n[e.role]),n.both)},f=function(e,t,n){var r=this,i=t,o=l(e,n),c=!1,a=new d;return Object.defineProperties(this,{evtMgr:{enumerable:!0,get:function(){return a}},isStarted:{enumerable:!0,get:function(){return c},set:function(e){c!==e&&(c=e,a.fireEvent(s.STARTED_STATE_CHANGED,{component:r,isStarted:c}))}},name:{enumerable:!0,get:function(){return i}},config:{enumerable:!0,get:function(){return o}},isSuspended:{enumerable:!1,writable:!0,value:!1},networkId:{enumerable:!1,writable:!0,value:null}}),
this.addEventListener=a.addEventListener,this.removeEventListener=a.removeEventListener,this};f.prototype.dispose=function(){return r.resolve()},f.prototype.suspendDiscovery=function(e){var t=this;t.isSuspended=!0,i.forEach(a.current.dscMgr.devices,function(n){n instanceof t.targetInstanceType&&(n.suspendDiscovery(e),n.cancelPendingConnections())})},f.prototype.resumeDiscovery=function(){var e=this;e.isSuspended=!1,e.networkId&&a.current.scheduler.delay(function(){i.forEach(a.current.dscMgr.devices,function(t){t instanceof e.targetInstanceType&&t.discoveryState===u.discoveryStates.PENDING&&t.refresh(t.session&&t.session.mdxSessionId)})},500)},f.prototype.processNetworkStatus=function(e){var t=this,n=c.processIflist(e.iflist),r=c.networkIdFromInterface(n);r&&t.networkId&&r!==t.networkId?(t.suspendDiscovery(!1),t.resumeDiscovery()):r?t.resumeDiscovery():t.suspendDiscovery(!1),t.networkId=r},f.EVENTS=s,t.exports=f},{"../../builds/ld.js":1,"../configuration.js":39,"../enums.js":65,"../eventManager.js":66,"../logging/logger.js":70,"./discoveryConfig.js":60,"./discoveryEvents.js":61,"./discoveryUtils.js":63,q:37}],60:[function(e,t,n){var r=e("../enums.js"),i={defaults:{dial:{controller:{searchVersions:{MDX:0,DIAL:1},mx:1,searchCount:1},target:{registrationMode:r.registrationModes.DISABLED,mdxServiceType:"mdx-netflix-com:service:target:2",dialAdditionalDataUrl:""},both:{mdxPort:9080,ssdpPort:1900,defaultLaunchArgs:"intent=sync"}},mdx:{controller:{searchVersions:{MDX:0,DIAL:1},mx:1,searchCount:1},target:{registrationMode:r.registrationModes.DARWIN_XPROFILE_V1,mdxServiceType:"mdx-netflix-com:service:target:2",dialAdditionalDataUrl:""},both:{mdxPort:9080,ssdpPort:1900,defaultLaunchArgs:"intent=sync"}},cast:{controller:{appId:"CA5E8412"},target:{},both:{mdxNamespace:"urn:x-cast:mdx-netflix-com:service:target:2",defaultLaunchArgs:"intent=sync"}}},config:{}};t.exports=i},{"../enums.js":65}],61:[function(e,t,n){t.exports=Object.freeze({STARTED_STATE_CHANGED:"startedStateChanged",DEVICE_FOUND:"deviceFound",DEVICE_REFOUND:"deviceRefound",DEVICE_GONE:"deviceGone",MDX_DEVICES_AVAILABLE:"mdxDevicesAvailable",START_CONNECTING:"startConnecting",START_DISCONNECTING:"startDisconnecting"})},{}],62:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("./discoveryEvents.js"),c=e("./discoveryConfig.js"),a=e("../configuration.js"),u=e("../enums.js"),d=e("../mdxError.js"),l=e("../eventManager.js"),f=e("./discoveryComponent.js"),p=e("./dialDiscoveryComponentNrdp.js"),v=e("./dialDiscoveryComponentWinJS.js"),g=e("./castDiscoveryComponentIOSv2.js"),h=e("./castTargetDiscoveryComponent.js"),E=e("./castDiscoveryComponentChrome.js"),m=e("./NrdpTargetDiscoveryComponent.js"),y={2:[m],3:[h],4:[E],5:[v],6:[p],8:[p,g]},R=function(e,t){var n=i.zipObject(i.map(this.discoveryComponents,function(t){return[t.name,t[e]]})),r={};r[e]=n,this.evtMgr.fireEvent(s[t],r)},S=function(e){R.call(this,"isStarted","STARTED_STATE_CHANGED")},I=function(e){var t=this,n=e.device;t.devices[n.id]=n,t.evtMgr.fireEvent(s.DEVICE_FOUND,{device:n}),a.current.storage.storeDeviceMap(a.current.dscMgr.devices)},T=function(e){this.evtMgr.fireEvent(e.type,e)},A={STARTED_STATE_CHANGED:S,DEVICE_FOUND:I,MDX_DEVICES_AVAILABLE:T,START_CONNECTING:T,START_DISCONNECTING:T},O=function(e){var t=this,n=[],s={},a={},p=new l;Object.defineProperties(this,{config:{enumerable:!0,get:function(){return c.config}},evtMgr:{enumerable:!0,get:function(){return p}},discoveryComponents:{enumerable:!0,get:function(){return n}},devices:{enumerable:!0,get:function(){return s}},availableDevices:{enumerable:!0,get:function(){return i.filter(s,function(e){return e.isAvailable})}},blacklistedUsns:{enumerable:!0,get:function(){return a}}}),this.start=function(e,t){var s=r.defer(),c=[];return i.forEach(n,function(n){o.info("Starting "+n.name+" discovery component"),c.push(n.start.call(n,e,t).then(function(e){return o.info.always("Discovery component "+n.name+" reported a successful start"),e},function(e){o.error.always("Discovery component "+n.name+" failed start",e)}))}),r.allSettled(c).done(function(e){var t=e&&1===e.length?e[0].value:e.map(function(e){return e.value});s.resolve(t)},s.reject),s.promise},this.stop=function(e){var s=[];return n&&n.length?(i.forEach(n,function(t){o.info("Stopping "+t.name+" discovery component"),s.push(t.stop.call(t,e).finally(t.dispose))}),s.push(t.clearDevices()),r.allSettled(s)):r.resolve()},this.clearDevices=function(){var e=[];return i.forEach(s,function(t){t.discoveryState=u.discoveryStates.UNAVAILABLE,e.push(t.dispose())}),s={},r.allSettled(e)},this.refreshDevices=function(){n&&n.length&&(i.forEach(n,function(e){e.refreshDevices&&e.refreshDevices.call(e)}),i.forEach(s,function(e){e.refresh&&e.refresh()}))},this.addEventListener=p.addEventListener,this.removeEventListener=p.removeEventListener,this.requestMdxDevice=function(){if(!n||!n.length)return r.reject();var e=i.find(n,function(e){return"function"==typeof e.requestMdxDevice});return e?e.requestMdxDevice():r.reject(new d(d.ERRORS.NOT_SUPPORTED))};var v=y[e.id];if(i.isUndefined(v))throw new d(d.ERRORS.START_ERROR,"Cannot start discovery manager for platform "+e.name);v.length?(n=[],i.forEach(v,function(r){var o=new r(e);c.config[o.name]=o.config;var s=f.EVENTS;i.forEach(A,function(e,n){e=e.bind(t),A[n]=e,o.addEventListener(s[n],e)}),n.push(o)})):o.warn(e.name+" does not support discovery")};O.prototype.EVENTS=s,O.prototype.getDeviceByMdxUuid=function(e){return i.find(a.current.dscMgr.devices,function(t){return t.mdxUuid===e})},t.exports=O},{"../../builds/ld.js":1,"../configuration.js":39,"../enums.js":65,"../eventManager.js":66,"../logging/logger.js":70,"../mdxError.js":76,"../test/mockDiscoveryComponent.js":101,"./NrdpTargetDiscoveryComponent.js":52,"./castDiscoveryComponentChrome.js":53,"./castDiscoveryComponentIOSv2.js":54,"./castTargetDiscoveryComponent.js":55,"./dialDiscoveryComponentNrdp.js":57,"./dialDiscoveryComponentWinJS.js":58,"./discoveryComponent.js":59,"./discoveryConfig.js":60,"./discoveryEvents.js":61,q:37}],63:[function(e,t,n){var r,i=e("../../builds/ld.js"),o=e("./discoveryConfig.js"),s=e("../logging/logger.js"),c="0.0.0.0";t.exports={isDeviceBlacklisted:function(e,t){return!i.isUndefined(i.find(o.config.blacklist,{manufacturer:e,model:t}))},isValidDeviceInfo:function(e,t){var n=[];return i.forEach(t,function(t,r){var i=e[r];t(i)||n.push([r,i])}),!n.length||(s.warn("Discovered device has invalid properties and will be ignored.","Device Info:",e,"Invalid Properties:",n),!1)},nonEmptyString:function(e){return i.isString(e)&&e.length},headers:{regMode:"X-Accepts-Registration",caps:"X-MDX-Caps",msl:"X-MSL",id:"X-MDX-ID",registered:"X-MDX-Registered",mdxVersion:"X-MDX-Version"},processIflist:function(e){return e?i.find(e,function(e){return"wifi"===e.physicalLayerType&&e.isDefault&&e.ipAddress}):null},get unknownIpAddress(){return c},getLocalIpAddress:function(){switch(r||(r=e("../configuration.js")),r.current.platform.id){case 2:case 6:case 8:return nrdp.mdx.localIPAddress||c;case 5:var t=i.find(Windows.Networking.Connectivity.NetworkInformation.getHostNames(),function(e){return!i.isNull(e.ipInformation)&&!i.isNull(e.ipInformation.networkAdapter)&&e.type===Windows.Networking.HostNameType.ipv4});return t?t.rawName:c;default:return c}},networkIdFromInterface:function(e){return e?(e.ssid||"")+(e.ipAddress||""):""}}},{"../../builds/ld.js":1,"../configuration.js":39,"../logging/logger.js":70,"./discoveryConfig.js":60}],64:[function(e,t,n){var r=e("../../builds/ld.js"),i=/^urn:([\w-]+?):service:([\w-]+):?(?:(\d+))?$/,o=function(e){var t="",n="",o=1;if(r.isString(e)){var s=i.exec(e);s&&(t=s[1]||t,n=s[2]||n,o=s[3]||o)}Object.defineProperties(this,{urn:{enumerable:!0,value:t},service:{enumerable:!0,value:n},version:{enumerable:!0,value:o}})};o.prototype.toString=function(){return"urn:"+this.urn+":service:"+this.service+":"+this.version},o.prototype.toNonVersionedString=function(){return"urn:"+this.urn+":service:"+this.service},Object.defineProperties(o.prototype,{isMdx:{enumerable:!0,get:function(){return"mdx-netflix-com"===this.urn&&"target"===this.service}},isDial:{enumerable:!0,get:function(){return"dial-multiscreen-org"===this.urn&&"dial"===this.service}}}),t.exports=o},{"../../builds/ld.js":1}],65:[function(e,t,n){var r=e("../builds/ld.js"),i=Object.freeze({CONTROLLER:"controller",TARGET:"target"}),o=Object.freeze({NRDP_TARGET:{id:2,name:"NRDP_TARGET",role:i.TARGET},CAST_TARGET:{id:3,name:"CAST_TARGET",role:i.TARGET},CADMIUM_CONTROLLER:{id:4,name:"CADMIUM_CONTROLLER",role:i.CONTROLLER},WINJS_CONTROLLER:{id:5,name:"WINJS_CONTROLLER",role:i.CONTROLLER},NRDP_CONTROLLER:{id:6,name:"NRDP_CONTROLLER",role:i.CONTROLLER},ARGO_CONTROLLER:{id:8,name:"ARGO_CONTROLLER",role:i.CONTROLLER}});t.exports=Object.freeze({logLevels:Object.freeze({NONE:0,ERROR:1,WARN:2,INFO:3,TRACE:4}),roles:i,platforms:o,registrationModes:Object.freeze({DISABLED:"0",ENABLED:"1",DEFAULT_PIN:"2",DARWIN_XPROFILE_V1:"3"}),serviceTypes:Object.freeze({MDX:"urn:mdx-netflix-com:service:target",DIAL:"urn:dial-multiscreen-org:service:dial",CAST:"urn:cast-multiscreen-org:service:cast"}),discoveryStates:Object.freeze({UNKNOWN:0,PENDING:1,AVAILABLE:2,UNAVAILABLE:3,ERROR:4}),launchStates:Object.freeze({UNKNOWN:0,NOT_LAUNCHED:1,PENDING:2,LAUNCHED:3}),controllerTypes:Object.freeze({UNKNOWN:0,MDX:1,REMOTE:2}),profilerModes:Object.freeze({OFF:0,KEY_EVENTS:1,FULL:2}),errors:{PAIRING_UNKNOWN_VERSION:{code:1,desc:"UNSUPPORTED PAIRING VERSION"},PAIRING_INVALID_CONTROLLER_REQUEST:{code:10,desc:"INVALID CONTROLLER REQUEST"},PAIRING_SERVER_ERROR:{code:11,desc:"SERVER ERROR"},PAIRING_TARGET_ERROR:{code:12,desc:"TARGET INTERNAL ERROR"},PAIRING_SERVER_NOT_REACHABLE:{code:13,desc:"SERVER UNAVAILABLE OR TIMEOUT"},PAIRING_CONTROLLER_HMAC_FAILURE:{code:20,desc:"CONTROLLER REQUEST HMAC_FAILURE"},PAIRING_CONTROLLER_CTICKET_EXPIRED:{code:21,desc:"CONTROLLER CTICKET EXPIRED"},PAIRING_CONTROLLER_CTICKET_CORRUPTED:{code:22,desc:"CONTROLLER CTICKET CORRUPTED"},PAIRING_NO_CTICKET:{code:23,desc:"NO CTICKET"},PAIRING_NOT_PAIRING:{code:30,desc:"TARGET NOT IN PAIRING MODE"},PAIRING_ALREADY_PAIRED:{code:31,desc:"TARGET ALREADY PAIRED"},PAIRING_ABORTED:{code:32,desc:"PAIRING ABORTED"},PAIRING_USER_MISMATCH:{code:33,desc:"USER MISMATCH"},REGISTRATION_NOT_REGISTERING:{code:40,desc:"TARGET NOT IN REGISTERING MODE"},REGISTRATION_ALREADY_REGISTERED:{code:41,desc:"TARGET ALREADY REGISTERED"},REGISTRATION_PAIRING_IN_PROGRESS:{code:42,desc:"REG PAIRING IN PROGRESS"},REGISTRATION_PIN_MISMATCH:{code:43,desc:"PIN MISMATCH"},REGISTRATION_PROFILE_MISMATCH:{code:97,desc:"Regpair is only allowed between profiles of the same account"},PAIRING_UNKNOWN_ERROR:{code:98,desc:"UNKNOWN ERROR"},PAIRING_NETWORK_ERROR:{code:99,desc:"NETWORK ERROR"},SESSION_UNKNOWN_VERSION:{code:1,desc:"UNSUPPORTED SESSION VERSION"},SESSION_UNKNOWN_SENDER:{code:2,desc:"UNKNOWN SESSION SENDER"},SESSION_UNKNOWN_RECEIVER:{code:3,desc:"UNKNOWN SESSION RECEIVER"},SESSION_INVALID_NONCE:{code:4,desc:""},SESSION_INVALID_HMAC:{code:5,desc:"MDX SESSION INVALID HMAC"},SESSION_DECRYPTION_FAILED:{code:6,desc:"MDX SESSION DECRYPTION FAILED"},SESSION_MALFORMED_MESSAGE:{code:7,desc:""},SESSION_UNKNOWN_SENDER_USERID:{code:8,desc:"MDX SESSION UNKNOWN SENDER USERID"},SESSION_UNKNOWN_RECEIVER_USERID:{code:9,desc:"MDX SESSION UNKNOWN RECEIVER USERID"},SESSION_NETWORK_ERROR:{code:10,desc:"NETWORK ERROR"},SESSION_INVALID_SID:{code:11,desc:"MDX SESSION INVALID SID"},SESSION_NOT_READY:{code:12,desc:"SESSION NOT READY"},SESSION_START_SESSION_TIMEOUT:{code:13,desc:"START SESSION TIMEOUT"}},connectIntents:Object.freeze({INVALID:0,JOIN:1,LAUNCH:2,LAUNCH_AND_CONTROL:3}),isValidPlatform:function(e){return r.find(o,r.isEqual.bind(void 0,e))}})},{"../builds/ld.js":1}],66:[function(e,t,n){var r=e("../builds/ld.js"),i=e("./logging/logger.js"),o=function(e,t,n){return e&&(r.isFunction(t)||"function"==typeof t)?(n[e]||(n[e]=[]),r.includes(n[e],t)?i.warn("Duplicate event listener registered for event '"+e+"' was ignored"):n[e].push(t),t):null},s=function(e,t,n){if(n[e]){var i=n[e];r.pull(i,t),i.length||delete n[e]}},c=function(e,t,n){t=r.merge(t||{},{type:e});var i=n[e];i&&i.length&&(i=i.slice(),r.forEach(i,function(e){e(t)}))},a=function(){var e={};this.addEventListener=function(t,n){return o(t,n,e)},this.removeEventListener=function(t,n){s(t,n,e)},this.fireEvent=function(t,n){c(t,n,e)}};t.exports=a},{"../builds/ld.js":1,"./logging/logger.js":70}],67:[function(e,t,n){var r,i,o=e("q"),s=e("../builds/ld.js"),c=e("./logging/logger.js"),a=e("./mdxError.js"),u=function(){var e={},t=0,n={POST:0,GET:1},r=function(t){var n=e[t.xid];if(n){var r=parseInt(t.code);if(t.code&&200!==r&&201!==r||!s.isUndefined(t.body)&&-1!==t.body.indexOf("error")){var i=new a(a.ERRORS.MESSAGING_ERROR,"HTTP request failed - code: "+t.code+" - body: "+t.body);i.httpCode=r,n.reject(i)}else n.resolve(t.body)}else c.warn("MDXLIB http response received without a handler",t)},i=function(n,r,i,s){return o.Promise(function(c,a){var u=++t,d=function(){return e[u]=o.defer(),s?nrdp.mdx.SendSessionMessage(n,i,u,5,s.securityContext,"",r,s.canonicalMessage,s.plaintext):nrdp.mdx.SendMdxHttpRequest(n,i,u,5,"",r),e[u].promise};d().done(c,function(e){0===e.httpCode&&o.delay(1500).then(function(){d().done(c,a)})})}).timeout(5200,"Timed out waiting for http response ack from NRDP for "+n)};return this.get=function(e,t){return i(e,t,n.GET)},this.post=function(e,t,r){return i(e,t,n.POST,r)},nrdp.mdx.addEventListener("httpresponse",r),this},d=function(){var e=new Windows.Web.Http.HttpClient;return this.get=function(t){var n=o.defer();try{var r=new Windows.Foundation.Uri(t);e.getAsync(r).done(n.resolve,n.reject)}catch(e){return o.reject(e)}return n.promise},this.post=function(t,n){var r=o.defer();try{var i=new Windows.Foundation.Uri(t),s=new Windows.Web.Http.HttpStringContent(n);e.postAsync(i,s).done(r.resolve,r.reject)}catch(e){return o.reject(e)}return r.promise},this},l=function(){return r||(r=new u)},f=function(){return i||(i=new d)},p={2:l,3:null,4:null,5:f,6:l,8:l};t.exports={createHttpClient:function(e){var t=p[e.id];if(t)return t();throw new a(a.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot create http client for platform: "+e.name)}}},{"../builds/ld.js":1,"./logging/logger.js":70,"./mdxError.js":76,q:37}],68:[function(e,t,n){var r=function(e,t,n,r){var i=e+t;if(n&&1===n.readyState)try{n.send(i)}catch(e){}else r&&r.push(i)},i=function(){var e,t=!0,n=[];Object.defineProperties(this,{shouldBuffer:{enumerable:!0,get:function(){return t},set:function(e){t=e}},ws:{enumerable:!0,get:function(){return e},set:function(t){e=t}}}),this.flush=function(){if(e&&1===e.readyState)for(;n.length;)e.send(n.shift());n=[]},this.trace=function(i){r("TRACE: ",i,e,t?n:void 0)},this.info=function(i){r("INFO: ",i,e,t?n:void 0)},this.warn=function(i){r("WARN: ",i,e,t?n:void 0)},this.error=function(i){r("ERROR: ",i,e,t?n:void 0)},this.mdxIntent=function(i){r("MDX_INTENT: ",i,e,t?n:void 0)}};t.exports=i},{}],69:[function(e,t,n){var r=function(){this.trace=function(e){return console.log("[MDXJS] "+e)},this.info=function(e){return console.info("[MDXJS] "+e)},this.warn=function(e){return console.warn("[MDXJS] "+e)},this.error=function(e){return console.error("[MDXJS] "+e)},this.mdxIntent=function(e){return console.info("[MDXJS] [INTENT] "+e)}};t.exports=r},{}],70:[function(e,t,n){var r=e("../../builds/ld.js"),i=e("../enums.js"),o=e("../mdxError.js"),s=e("./nrdpLogSink.js"),c=e("./nrdpNccpLogSink.js"),a=e("./netflixPlayerLogSink.js"),u=e("./consoleLogSink.js"),d=function(e){return"object"==typeof e&&r.isFunction(e.trace)&&r.isFunction(e.info)&&r.isFunction(e.warn)&&r.isFunction(e.error)},l=function(e,t,n,i,o,s){if(n||t>=e){var c=r.reduce(s,function(e,t){if(r.isString(t)||r.isFunction(t)||r.isError(t))t=t.toString();else try{t=JSON.stringify(t)}catch(e){t=t.toString()}return e=e.length?e+", "+t:t},"");r.forEach(o,function(e){try{e[i](c)}catch(e){}})}},f={2:[s],3:[c,u],4:[a],5:[],6:[s],8:[s,u]},p=function(){var e=this,t=i.logLevels.WARN,n=[];Object.defineProperties(this,{logLevel:{enumerable:!0,get:function(){return t},set:function(e){if(!r.findKey(i.logLevels,function(t){return t===e}))throw new o(o.ERRORS.INVALID_ARG,"log level: "+e);t=e}}}),this.addLogSink=function(e){if(!d(e))throw new o(o.ERRORS.INVALID_ARG,"log sink");r.includes(n,e)||n.push(e)},this.removeLogSink=function(e){r.pull(n,e)},this.removeAllLogSinks=function(){n=[]},this.trace=function(){l(i.logLevels.TRACE,t,!1,"trace",n,arguments)},this.trace.always=function(){l(i.logLevels.TRACE,t,!0,"trace",n,arguments)},this.info=function(){l(i.logLevels.INFO,t,!1,"info",n,arguments)},this.info.always=function(){l(i.logLevels.INFO,t,!0,"info",n,arguments)},this.warn=function(){l(i.logLevels.WARN,t,!1,"warn",n,arguments)},this.warn.always=function(){l(i.logLevels.WARN,t,!0,"warn",n,arguments)},this.error=function(){l(i.logLevels.ERROR,t,!1,"error",n,arguments)},this.error.always=function(){l(i.logLevels.ERROR,t,!0,"error",n,arguments)},this.mdxIntent=function(){l(i.logLevels.INFO,t,!0,"mdxIntent",n,arguments)},this.addDefaultPlatformLogSinks=function(t){var n=f[t.id];if(r.isUndefined(n))throw new o(o.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot add default log sinks for platform "+t.name);r.forEach(n,function(t){e.addLogSink(new t)})}};t.exports=new p},{"../../builds/ld.js":1,"../enums.js":65,"../mdxError.js":76,"./consoleLogSink.js":69,"./netflixPlayerLogSink.js":71,"./nrdpLogSink.js":72,"./nrdpNccpLogSink.js":73}],71:[function(e,t,n){var r=function(){this.trace=function(e){netflix.player.log.trace(e)},this.info=function(e){netflix.player.log.info(e)},this.warn=function(e){netflix.player.log.warn(e)},this.error=function(e){netflix.player.log.error(e)}};t.exports=r},{}],72:[function(e,t,n){var r=function(e,t,n){return e.call(this,t,"MDX",n||"mdx",{xid:-1})},i=function(){this.trace=function(e){return r.call(nrdp.log,nrdp.log.trace,e)},this.info=function(e){return r.call(nrdp.log,nrdp.log.info,e)},this.warn=function(e){return r.call(nrdp.log,nrdp.log.warn,e)},this.error=function(e){return r.call(nrdp.log,nrdp.log.error,e)},this.mdxIntent=function(e){return r.call(nrdp.log,nrdp.log.info,e,"mdxintent")}};t.exports=i},{}],73:[function(e,t,n){var r=function(){this.trace=function(e){return nrdp.log.toNCCP("mdx","trace",{msg:e})},this.info=function(e){return nrdp.log.toNCCP("mdx","info",{msg:e})},this.warn=function(e){return nrdp.log.toNCCP("mdx","warn",{msg:e})},this.error=function(e){return nrdp.log.toNCCP("mdx","error",{msg:e})},this.mdxIntent=function(e){return nrdp.log.toNCCP("mdxintent","info",{msg:e})}};t.exports=r},{}],74:[function(e,n,r){t=e("./mdxApi.js")},{"./mdxApi.js":75}],75:[function(e,t,n){var r=e("q"),i=e("../builds/ld.js"),o=e("./enums.js"),s=e("./configuration.js"),c=e("./logging/logger.js"),a=e("./profiling/mdxProfiler.js"),u=e("./apiEvents.js"),d=e("./session/msgBusFactory.js"),l=e("./session/securityFactory.js"),f=e("./mdxError.js"),p=e("./discovery/discoveryManager.js"),v=e("./eventManager.js"),g=(e("./versionInfo.js"),0),h=function(e,t,n){try{e.fireEvent(t,n)}catch(e){c.warn("Event handler exception for "+t,e)}},E=function(e){if(s.current.isStarted){var t=this.availableDevices.length;t!==g&&(g=t,h(e,u.AVAILABLE_DEVICE_COUNT_CHANGED,{count:t}))}},m=function(e,t,n){c.info.always("Discovery manager started state changed",n)},y=function(e,t){h(e,u.MDX_DEVICES_AVAILABLE,{available:t.available})},R=function(e,t){E.call(this,e),t.state===o.discoveryStates.AVAILABLE&&h(e,u.DEVICE_AVAILABLE,{device:t.device})},S=function(e,t){h(e,u.SWITCH_CREDENTIALS,t)},I={},T=function(e,t){var n=t.device,r=this;s.current.isStarted&&(I[n.id]||(I[n.id]=!0,n.addEventListener(n.EVENTS.DISCOVERY_STATE_CHANGED,R.bind(r,e)),n.addEventListener(u.SWITCH_CREDENTIALS,S.bind(r,e))),E.call(r,e),h(e,u.DEVICE_AVAILABLE,{device:n}))},A=function(e){h(e,u.START_CONNECTING)},O=function(e){h(e,u.START_DISCONNECTING)},N=function(e){if(e){var t=e.platformMdxLib;l.platformCrypto=t}},C=function(e,t){var n=this,l={initStart:new Date};if(!i.find(C.PLATFORMS,function(t){return i.isEqual(t,e)}))throw new f(f.ERRORS.INVALID_ARG,"Invalid platform specified when constructing the MdxApi instance: "+(e?e.name:"undefined"));s.reset(),s.current.platform=e,e.id===o.platforms.ARGO_CONTROLLER.id&&(r.onerror=function(e){e instanceof Error||e instanceof f?c.error("MDX unhandled error caught",e,e.message,e.stack):c.error("MDX unhandled promise rejection caught",e)});var g=new v,E=new p(e);s.current.dscMgr=E,s.current.discovery=E.config;var R=E.EVENTS;E.addEventListener(R.STARTED_STATE_CHANGED,m.bind(n,s.current,g)),E.addEventListener(R.DEVICE_FOUND,T.bind(n,g)),E.addEventListener(R.MDX_DEVICES_AVAILABLE,y.bind(n,g)),E.addEventListener(R.START_CONNECTING,A.bind(n,g)),E.addEventListener(R.START_DISCONNECTING,O.bind(n,g)),d.configureProtocolsForPlatform(e),Object.defineProperties(this,{config:{enumerable:!0,get:function(){return i.clone(s.current,!0)}},availableDevices:{enumerable:!0,get:function(){return E.availableDevices}}}),this.start=function(e){if(s.current.isStarted)return r.reject(new f(f.ERRORS.ALREADY_STARTED));if(l&&l.initStart){var t=l.initStart;a.setBaseTime(t),a.newEvent(a.EVENTS.INIT,void 0,t,l.initComplete),l=null}var d=a.newEvent(a.EVENTS.START),p=r.defer();return E.start.call(E,e,d).timeout(9e3).tap(function(){if(E.discoveryComponents.length){if(!i.find(E.discoveryComponents,function(e){return e.isStarted}))return c.error.always("MDX failed to start as there wasn't a single discovery component that reported a successful start!"),void p.reject(new f(f.ERRORS.START_ERROR,"No discovery components could start"))}N.call(n,e),d.complete(),s.current.isStarted=!0,h(g,u.STARTED_STATE_CHANGED,{isStarted:!0}),c.info("MDX Started. Launch args: ",arguments[0]),s.current.platform.role===o.roles.CONTROLLER?p.resolve():p.resolve.apply(null,arguments),s.current.scheduler.async(function(){i.forEach(E.devices,function(e){I[e.id]||T.call(n,g,{device:e})})})}).done(),p.promise},this.stop=function(){if(!s.current.isStarted)return r.reject(new f(f.ERRORS.ALREADY_STOPPED));c.trace("Stopping MDX");var e=a.newEvent(a.EVENTS.STOP),t=r.defer();return s.current.storage.storeDeviceMap(s.current.dscMgr.devices).finally(function(){E.stop.call(E,e).timeout(1e3).finally(function(){e.complete()}).done(function(){s.current.isStarted=!1,h(g,u.STARTED_STATE_CHANGED,{isStarted:!1}),t.resolve()},function(e){var n=e?e.toString():"";t.reject(new f(f.ERRORS.STOP_ERROR,n))})}),t.promise},this.reset=function(){return c.info.always("Resetting all MDX state"),s.current.storage.reset().then(E.clearDevices)},this.refreshDevices=function(){if(s.current.platform.role!==o.roles.CONTROLLER)throw new f(f.ERRORS.NOT_SUPPORTED,"MdxApi.refreshDevices is only supported on controller platforms");E.refreshDevices.call(E)},this.addEventListener=g.addEventListener,this.removeEventListener=g.removeEventListener,this.requestMdxDevice=E.requestMdxDevice,c.removeAllLogSinks(),c.addDefaultPlatformLogSinks(e);return c.info.always("MDX Initialized - version: "+C.version+", flavor: RELEASE, platform: "+e.name+", role: "+e.role),l.initComplete=new Date,this};Object.defineProperties(C,{version:{get:function(){return s.current.version}},PLATFORMS:{get:function(){return o.platforms}},ROLES:{get:function(){return o.roles}},EVENTS:{get:function(){return u}},LOG_LEVELS:{get:function(){return o.logLevels}},REGISTRATION_MODES:{get:function(){return o.registrationModes}},PROFILER_MODES:{get:function(){return o.profilerModes}},ERRORS:{get:function(){return f.ERRORS}}}),C.prototype.configure=function(e){i.isUndefined(e)||(c.info("MDX configuration options",e),s.process(this,s.current,e))},C.prototype.broadcastAppMessage=function(e,t){if(s.current.platform.role!==o.roles.TARGET)throw new f(f.ERRORS.NOT_SUPPORTED,"MdxApi.broadcastAppMessage is only supported on target platforms");c.trace("MdxApi.broadcastAppMessage",e,t);var n,a=[];return i.forEach(this.availableDevices,function(r){n=r.sendAppMessage(e,t).fail(function(){c.error("broadcastAppMessage promise FAILED")}),a.push(n)}),c.trace("broadcastAppMessage returning promisesArray"),r.all(a)},r.stopUnhandledRejectionTracking(),t.exports=C},{"../builds/ld.js":1,"./apiEvents.js":38,"./configuration.js":39,"./discovery/discoveryManager.js":62,"./enums.js":65,"./eventManager.js":66,"./logging/logger.js":70,"./mdxError.js":76,"./profiling/mdxProfiler.js":77,"./session/msgBusFactory.js":92,"./session/securityFactory.js":97,"./test/mockDeviceHelper.js":100,"./test/testConfiguration.js":104,"./versionInfo.js":106,q:37}],76:[function(e,t,n){var r={code:0,message:"There was an unknown error encountered"},i={},o=function(e,t){e=e||r,t=t?": "+t:"",this.name="MdxError",this.code=e.code,this.message=e.message+t,this.stack=(new Error).stack};o.prototype=Object.create(Error),o.prototype.toString=function(){return this.code+" : "+this.message},Object.defineProperty(o,"ERRORS",{enumerable:!0,value:i}),o.prototype.ERRORS=i,o.prototype.isEqual=function(e){return e instanceof o&&this.code===e.code},i.UNKNOWN=new o(r),i.INVALID_ARG=new o({code:1,message:"Invalid argument value"}),i.PLATFORM_SUPPORT_ERROR=new o({code:2,message:"Platform does not support operation"}),i.NOT_SUPPORTED=new o({code:3,message:"Operation not supported"}),i.CANCELLED=new o({code:4,message:"Operation cancelled"}),i.NOT_IMPLEMENTED=new o({code:9999,message:"NOT IMPLEMENTED"}),i.INVALID_CONFIG=new o({code:100,message:"Invalid configuration value specified"}),i.START_ERROR=new o({code:101,message:"MDX Start failure"}),i.STOP_ERROR=new o({code:102,message:"MDX Stop failure"}),i.ALREADY_STARTED=new o({code:103,message:"MDX already started"}),i.ALREADY_STOPPED=new o({code:104,message:"MDX already stopped"}),i.PROTOCOL_ERROR=new o({code:200,message:"Protocol error"}),i.USER_MISMATCH=new o({code:201,message:"Pairing user mismatch"}),i.REGISTRATION_NOT_SUPPORTED=new o({code:202,message:"Registration not supported"}),i.CONNECT_FAILED=new o({code:203,message:"Failed to connect with the device"}),i.INVALID_CTICKET=new o({code:204,message:"Invalid CTICKET"}),i.NOT_CONNECTED=new o({code:205,message:"Not connected to the Netflix app on the device"}),i.APP_NOT_RUNNING=new o({code:206,message:"Netflix app not running"}),i.CRYPTO_ERROR=new o({code:300,message:"There was a crypto error encountered"}),i.MESSAGING_ERROR=new o({code:301,message:"Message sending failed"}),Object.freeze(i),t.exports=o},{}],77:[function(e,t,n){var r,i=e("../../builds/ld.js"),o=e("../enums.js"),s=e("./profilerEvents.js"),c=e("./profileFormats.js"),a=e("../logging/logger.js"),u=e("../mdxError.js"),d=null,l={name:"local",events:[],markers:[]},f={newSubEvent:function(){return f},complete:function(){}},p=function(e,t,n,r,i){this.id=e,this.deviceId=t||"",this.start=r,this.end=null,this.events=[],this.parent=i||null,this.newSubEvent=n?function(e,t,n){var r=v(e,this.deviceId,!0,t,this);return n&&r.complete(n),r}:function(){return f}};p.prototype.complete=function(e){if(null===this.end&&(this.end=e||new Date,!this.parent)){var t=d.devices[this.deviceId];if(t){var n=t.events,r=[],o=function(e){r.push(e),e.complete(),i.forEach(e.events,o)};o(this),i.forEach(r,function(e){n.push(e.id),n.push(e.start);var t=e.end.valueOf()-d.baseTime.valueOf();n.push(t)})}}};var v=function(e,t,n,r){var i=(r?r.valueOf():(new Date).valueOf())-d.baseTime.valueOf();return new p(e,t,n,i)},g=0,h=function(t,n,i,o,s){var c=this,a=i.session;c.index=g++,c.profiler=t,c.intent=n,c.result=c.RESULTS.FAILED,c.error="",c.preemptedBy="",c.targetVersion=a.mdxVersion.toString(),c.xid=o||null,c.targetUi=a.uiVersion||null,c.targetPlatform=a.platformVersion||null,c.targetFw=a.fwVersion||null,c.targetPlayer=a.playerVersion||null,c.targetShell=a.shellVersion||null,c.extraInfo=s||{},c.startTime=new Date,c.ackTime=c.firstImpTime=c.completedTime=null,r||(r=e("../configuration.js")),c.failTimer=r.current.scheduler.delay(function(){c.failed("Timed out")},45e3)};h.prototype.RESULTS={FAILED:"FAILED",SUCCESS:"SUCCESS",PREEMPTED:"PRE-EMPTED"},h.prototype.send=function(){var e=this;e.failTimer&&r.current.scheduler.cancelDelay(e.failTimer);var t=r.current,n=e.startTime;a.mdxIntent(JSON.stringify({index:e.index,controllerMdx:t.version,targetMdx:e.targetVersion,controllerUi:t.uiVersion,targetUi:e.targetUi,controllerNative:t.platformVersion,targetNative:e.targetPlatform,targetFirmware:e.targetFw,targetPlayer:e.targetPlayer,targetShell:e.targetShell,intent:e.intent,xid:e.xid,result:e.result,ackTime:e.ackTime?e.ackTime-n:null,firstImpressionTime:e.firstImpTime?e.firstImpTime-n:null,completedTime:e.completedTime?e.completedTime-n:null,preemptedBy:e.preemptedBy,errorText:e.error,extraInfo:e.extraInfo})),e.profiler.currentIntent=null},h.prototype.success=function(){var e=this;e.result=e.RESULTS.SUCCESS,e.send.call(this)},h.prototype.failed=function(e){var t=this;t.error=e||"",t.result=t.RESULTS.FAILED,t.send.call(this)},h.prototype.preEmpted=function(e){var t=this;t.preemptedBy=e,t.result=t.RESULTS.PREEMPTED,t.send.call(this)},h.prototype.ack=function(){var e=this;e.ackTime=new Date,"SET_VOLUME"!==e.intent&&"DISMISS_POSTPLAY"!==e.intent||e.success()},h.prototype.processStateChange=function(e){var t=this,n=e.currentState,r=new Date;if(n){var i=function(){t.firstImpTime=t.firstImpTime||r,"PLAYING"===n&&(t.completedTime=r,t.success())};switch(t.intent){case"PLAY":if("END_PLAYBACK"===n)return;i();break;case"SKIP_SEGMENT":case"SKIP":case"SET_TIME":i();break;case"PAUSE":case"RESUME":case"STOP":case"AUTO_ADVANCE":!function(){t.firstImpTime=t.completedTime=new Date,t.success()}()}t.xid=t.xid||e.xid||null}},h.prototype.processAudioSubtitlesChanged=function(){var e=this;if("SET_AUDIO_SUBTITLES"===e.intent){var t=new Date;e.firstImpTime=e.completedTime=t,e.success()}};var E=function(){var e=o.profilerModes.OFF;Object.defineProperties(this,{mode:{enumerable:!0,get:function(){return e},set:function(t){var n=o.profilerModes;if(!i.findKey(n,function(e){return e===t}))throw new u(u.ERRORS.INVALID_CONFIG,"profiler mode:"+t);switch(e=t){case n.OFF:d=null;break;case n.KEY_EVENTS:case n.FULL:d||(d={baseTime:new Date,devices:{"":l}})}}},currentIntent:{enumerable:!0,writable:!0,value:null}}),this.setBaseTime=function(e){d&&(d.baseTime=e)},this.addDevice=function(e,t){if(d){var n=d.devices;if(n[e])throw new u(u.ERRORS.INVALID_ARG,"Device already added to the mdx profile: "+e+" - "+JSON.stringify(t));n[e]=i.merge({events:[],markers:[]},t)}},this.newEvent=function(t,n,r,i){if(!d)return f;var s=v(t,n,e===o.profilerModes.FULL,r);return i&&s.complete(i),s},this.newMarker=function(e,t,n){if(d&&e){var r=(n?n.valueOf():(new Date).valueOf())-d.baseTime.valueOf(),i=t&&d.devices[t]||l,o=i.markers;o.push(e),o.push(r)}},this.getData=function(e){switch(e){case"csv":return c.asCsv(d);default:return i.clone(d,!0)}},this.registerUserIntent=function(e,t,n,r){var i=this,o=i.currentIntent;if(o&&o.intent===e){if(!(new Date-o.startTime>100))return o;i.currentIntent.preEmpted(e)}return i.currentIntent=new h(i,e,t,n,r),i.currentIntent}};E.prototype.EVENTS=s,t.exports=new E},{"../../builds/ld.js":1,"../configuration.js":39,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"./profileFormats.js":78,"./profilerEvents.js":79}],78:[function(e,t,n){var r=e("../../builds/ld.js"),i=function(e){var t=[];return r.forEach(e.devices,function(e,n){for(var r=e.events,i=n||"local";r.length;)t.push([i,r.shift(),r.shift(),r.shift()].join(","));for(r=e.markers;r.length;)t.push([i,r.shift(),r.shift()].join(",")+",");return t}),["device,event,start,end"].concat(t)};t.exports={asCsv:i}},{"../../builds/ld.js":1}],79:[function(e,t,n){t.exports={INVALID:0,INIT:1,START:2,START_CAST_DISC:3,START_DIAL_DISC:4,DEVICE_FOUND:5,DEVICE_GONE:6,DEVICE_REFOUND:7,STOP:8,STOP_CAST_DISC:9,STOP_DIAL_DISC:10,CONNECT:11,DROPPED:100,VALIDATE_MSG:101,DISPATCH_FAILED:102,PAIRIFY:103,DISPATCH_MSG:104,QUEUED:105,CREATE_CTX:106,HMAC:107,DECRYPT:108,ENCRYPT:109,CANONICAL:110,UNKNOWN_MSG:120,PAIRINGREQUEST:121,ERROR:122,PAIRINGREJECTED:123,PAIRINGRESPONSE:124,
START_SESSION:125,END_SESSION:126,SESSION_ERR_MSG:127,REGPAIRREQUEST:128,PINGREQUEST:129,PINGRESPONSE:130,PAIRING_ERROR_RESPONSE:131,REGPAIRRESPONSE:132,REGPAIR_ERROR_RESPONSE:133,HANDSHAKE:150,PLAYER_PLAY:151,PLAYER_PAUSE:152,PLAYER_RESUME:153,PLAYER_STOP:154,PLAYER_SKIP:155,PLAYER_SET_CURRENT_TIME:156,PLAYER_SET_AUTO_ADVANCE:157,PLAYER_SET_VOLUME:158,PLAYER_GET_CURRENT_STATE:159,PLAYER_GET_CAPABILITIES:160,MESSAGE_IGNORED:161,HANDSHAKE_ACCEPTED:162,PLAYER_CURRENT_STATE:163,PLAYER_STATE_CHANGED:164,PLAYER_CAPABILITIES:165,DIALOG_SHOW:166,DIALOG_CANCEL:167,DIALOG_RESPONSE:168,GET_AUDIO_SUBTITLES:169,SET_AUDIO_SUBTITLES:170,AUDIO_SUBTITLES_SETTINGS:171,AUDIO_SUBTITLES_CHANGED:172,PIN_VERIFICATION_SHOW:173,PIN_VERIFICATION_NOT_REQUIRED:174,PIN_VERIFICATION_CANCEL:175,PIN_VERIFICATION_RESPONSE:176,META_DATA_CHANGED:177,SKIP_SEGMENT:178,CAST_HANDSHAKE:200,CAST_RESUME:201,CAST_PAUSE:202,CAST_DEVICE_CONNECT:203,CAST_APP_CONNECT:204,CAST_STOP:205,SERVER_PAIR:300,DIAL_LAUNCH:400}},{}],80:[function(e,t,n){var r,i,o,s=e("q"),c=e("../builds/ld.js"),a=e("./mdxError.js"),u=function(){},d=function(){var e=arguments[0],t=arguments[1];if(t){var n=c.drop(arguments,2);e(function(){t.apply(this,n)},0)}},l=function(){var e=arguments[0],t=arguments[1];if(!t)return s.reject(new a(a.ERRORS.INVALID_ARG,"Invalid fn value for asyncResolve"));var n=s.defer(),r={resolve:n.resolve,reject:n.reject,notify:n.notify},i=[r].concat(c.drop(arguments,2));return e(function(){t.apply(this,i)},0),n.promise},f=function(){var e=arguments[0],t=arguments[1];if(t){var n=arguments[2],r=c.drop(arguments,3);return e(function(){t.apply(this,r)},n)}},p=function(e,t){e.call(this,t)},v=function(){var e=arguments[0],t=arguments[1],n=arguments[2];if(n){var r=arguments[3],i=arguments[4],o=c.drop(arguments,5),s=t(function(){n.apply(this,o)},r);if(i){var a=new u;return a.intervalId=s,a.timeoutId=e(function(){n.apply(this,o)},0),a}return s}},g=function(e,t,n){n instanceof u?(e.call(this,n.timeoutId),t.call(this,n.intervalId)):t.call(this,n)},h=function(e,t,n,r,i){if(!t)return s.reject(new a(a.ERRORS.INVALID_ARG,"Invalid fn value for retry"));r=parseInt(r)||1;var o=s.defer(),c=function(t){t>=r?o.reject(i||"Operation failed after "+r+" attempts"):e(function(){u(++t)},n)},u=function(e){var n=s(t());if(n.isPending())n.done(o.resolve,function(){c(e)});else{var r=n.inspect().value;if(r){if(1===e)return s.resolve(r);o.resolve(r)}else c(e)}return null};return u(1)||o.promise},E=function(){};E.prototype.async=function(){var e=[nrdp.gibbon.setTimeout].concat(Array.prototype.slice.call(arguments));return d.apply(void 0,e)},E.prototype.asyncResolve=function(){var e=[nrdp.gibbon.setTimeout].concat(Array.prototype.slice.call(arguments));return l.apply(void 0,e)},E.prototype.delay=function(){var e=[nrdp.gibbon.setTimeout].concat(Array.prototype.slice.call(arguments));return f.apply(nrdp.gibbon,e)},E.prototype.cancelDelay=function(){var e=[nrdp.gibbon.clearTimeout].concat(Array.prototype.slice.call(arguments));return p.apply(nrdp.gibbon,e)},E.prototype.repeat=function(){var e=[nrdp.gibbon.setTimeout,function(){var e=Array.prototype.slice.call(arguments);return e.splice(2,0,!1),nrdp.gibbon.setTimeout.apply(nrdp.gibbon,e)}].concat(Array.prototype.slice.call(arguments));return v.apply(nrdp.gibbon,e)},E.prototype.cancelRepeat=function(){var e=[nrdp.gibbon.clearTimeout,nrdp.gibbon.clearTimeout].concat(Array.prototype.slice.call(arguments));return g.apply(void 0,e)},E.prototype.retry=function(){var e=[nrdp.gibbon.setTimeout].concat(Array.prototype.slice.call(arguments));return h.apply(void 0,e)};var m=function(){};m.prototype.async=function(){var e=[window.setTimeout].concat(Array.prototype.slice.call(arguments));return d.apply(void 0,e)},m.prototype.asyncResolve=function(){var e=[window.setTimeout].concat(Array.prototype.slice.call(arguments));return l.apply(void 0,e)},m.prototype.delay=function(){var e=[window.setTimeout].concat(Array.prototype.slice.call(arguments));return f.apply(window,e)},m.prototype.cancelDelay=function(){var e=[window.clearTimeout].concat(Array.prototype.slice.call(arguments));return p.apply(window,e)},m.prototype.repeat=function(){var e=[window.setTimeout,window.setInterval].concat(Array.prototype.slice.call(arguments));return v.apply(window,e)},m.prototype.cancelRepeat=function(){var e=[window.clearTimeout,window.clearInterval].concat(Array.prototype.slice.call(arguments));return g.apply(void 0,e)},m.prototype.retry=function(){var e=[window.setTimeout].concat(Array.prototype.slice.call(arguments));return h.apply(void 0,e)};var y=function(){};y.prototype.async=function(){var e=[setTimeout].concat(Array.prototype.slice.call(arguments));return d.apply(null,e)},y.prototype.asyncResolve=function(){var e=[setTimeout].concat(Array.prototype.slice.call(arguments));return l.apply(null,e)},y.prototype.delay=function(){var e=[setTimeout].concat(Array.prototype.slice.call(arguments));return f.apply(null,e)},y.prototype.cancelDelay=function(){var e=[clearTimeout].concat(Array.prototype.slice.call(arguments));return p.apply(null,e)},y.prototype.repeat=function(){var e=[setTimeout,setInterval].concat(Array.prototype.slice.call(arguments));return v.apply(null,e)},y.prototype.cancelRepeat=function(){var e=[clearTimeout,clearInterval].concat(Array.prototype.slice.call(arguments));return g.apply(null,e)},y.prototype.retry=function(){var e=[setTimeout].concat(Array.prototype.slice.call(arguments));return h.apply(null,e)};var R=function(){return i||(i=new m)},S=function(){return r||(r=new E)},I=function(){return o||(o=new y)},T={2:S,3:R,4:R,5:R,6:S,8:I};t.exports={createScheduler:function(e){var t=T[e.id];if(t)return t();throw new a(a.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot create scheduler for platform: "+e.name)}}},{"../builds/ld.js":1,"./mdxError.js":76,q:37}],81:[function(e,t,n){var r=e("q"),i=e("../logging/logger.js"),o=e("./validation.js"),s=e("./msgFactory.js"),c=e("../profiling/mdxProfiler.js"),a=e("../enums.js"),u=e("../configuration.js"),d=e("./error.js"),l=e("../mdxError.js"),f=e("../eventManager.js"),p=0,v={},g=new f,h={endSessionAck:"endSessionAck"},E=function(e,t,n){n.id=c.EVENTS.START_SESSION;var i=++p,o=t.session;return o.sendSessionMessage(s.startSessionResponse(i)).finally(function(){o.mdxSessionId=i}),r.resolve()},m=function(e,t,n){return n.id=c.EVENTS.END_SESSION,this.end(!1,!0,"true"===e.ack)},y=function(e){return g.fireEvent(h.endSessionAck,{session:this,msg:e}),r.resolve()},R=function(e,t,n){n.id=c.EVENTS.START_SESSION,t.session.mdxSessionId=e.sessionId,t.session.supportsEndAck="true"===e.supportsEndAck;var o=v[t.id],s=o&&o.deferred;return s?s.resolve():i.warn("Start session response was unexpected or too late",e),r.resolve()},S=function(e,t,n,i){var o=t.session,u=e.appAction,d=e.appBody,l=c.EVENTS[u];if(l&&n&&(n.id=l),parseInt(e.sessionId)!==parseInt(o.mdxSessionId))return o.sendMdxMessage(s.error(i,t,a.errors.SESSION_INVALID_SID),"session"),r.resolve();if("HANDSHAKE"===u)return o.sendSessionMessage(s.handshakeAccepted(o.mdxSessionId,d.contractVersion)),r.resolve();var f={type:u,payload:d,transactionId:i};return r.resolve(f)},I={createSession:E,endSession:m,endSessionAck:y,startSessionResponse:R,appMessage:S},T=function(e,t,n){return i.warn("Processing session error message from device",t.id,e),n.id=c.EVENTS.SESSION_ERR_MSG,t.session.errMsgCount++,u.current.platform.role,a.roles.CONTROLLER,r.resolve()},A=function(e){return"session"===e.action},O=function(e,t,n){var c=this;if("error"===e.action)return T.call(c,e);c.errMsgCount=0;var d=r.defer();return c.processEncryptedMessage(e,n).done(function(r){var s=o.parsePairedPayload(r),a=s.sessionAction,u=I[a];if(u)u.call(c,s,t,n,e.nonce).done(d.resolve,d.reject);else{var l="Unknown Session Message Action: "+a;i.error(l),d.reject(l)}},function(n){c.mdxSessionId||n.code===l.ERRORS.CRYPTO_ERROR.code?(u.current.scheduler.async(function(){c.sendMdxMessage(s.error(e.nonce,t,a.errors.SESSION_INVALID_HMAC),"session").finally(function(){l.ERRORS.CRYPTO_ERROR.isEqual(n)?t.clearPairing():(c.mdxSessionId=null,t.disconnectFromApp())})}),d.reject(new l(l.ERRORS.MESSAGING_ERROR,"Application session message failed to decrypt: "+JSON.stringify(n)))):d.resolve()}),d.promise},N=function(e){var t=this,n=e.id,i=u.current.scheduler,o=r.defer();v[n]={deferred:o};var c=r.defer();return e.mdxSessionId=0,t.sendSessionMessage(s.startSessionRequest()).then(function(a){var u=function r(o){o&&"ETIMEDOUT"===o.code&&0===e.mdxSessionId&&i.async(function(){t.sendSessionMessage(s.startSessionRequest()).then(function(){var e=v[n];e&&(e.retryTimeout&&i.cancelDelay(e.retryTimeout),i.delay(r,8e3))})}),c.reject(o)};o.promise.timeout(8e3).then(c.resolve,u).finally(function(){var e=function e(){d.clearErrorHandler(a),n.removeEventListener(n.EVENTS.LAUNCH_STATE_CHANGED,e)},n=t.device;n.addEventListener(n.EVENTS.LAUNCH_STATE_CHANGED,e)}),d.registerErrorHandler(a,function(e){return o.reject(e),r.resolve()})}).fail(function(){}).done(),c.promise.timeout(13e3,"Timed out trying to start session with target "+e.id).finally(function(){var e=v[n];e&&e.retryTimeout&&i.cancelDelay(e.retryTimeout),delete v[n]})};t.exports={canHandle:A,handleMsg:O,startSession:N,addMessageListener:g.addEventListener.bind(g),removeMessageListener:g.removeEventListener.bind(g),events:h}},{"../configuration.js":39,"../enums.js":65,"../eventManager.js":66,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./error.js":88,"./msgFactory.js":93,"./validation.js":98,q:37}],82:[function(e,t,n){var r=e("q"),i=(e("../logging/logger.js"),e("../eventManager.js")),o=new i,s=function(e){return"broadcast"===e.action},c=function(e,t){var n={device:t,payload:e.payload};return o.fireEvent(e.messageType,n),r.resolve()};t.exports={canHandle:s,handleMsg:c,addMessageListener:o.addEventListener.bind(o),removeMessageListener:o.removeEventListener.bind(o)}},{"../eventManager.js":66,"../logging/logger.js":70,q:37}],83:[function(e,t,n){var r,i=e("q"),o=e("../../builds/ld.js"),s=e("../logging/logger.js"),c=e("../profiling/mdxProfiler.js"),a=e("../enums.js"),u=e("./regPairFactory.js"),d=e("../configuration.js"),l=e("./mdxSession.js"),f=e("../mdxError.js"),p=e("../versionInfo.js"),v=function(e,t,n,i){l.call(this,e,i);var o=t;return Object.defineProperties(this,{protocol:{enumerable:!1,value:"cast://"},senderId:{enumerable:!0,get:function(){return o},set:function(e){o=e}},senderGuid:{enumerable:!1,get:function(){return o.substr(o.indexOf(":")+1)}},opts:{enumerable:!1,value:i||{}}}),n&&(r=n),this};v.prototype=Object.create(l.prototype),v.prototype.sendHandshakeResponse=function(){var e=this,t=u.createProvider(d.current.platform),n={type:"castHandShakeAck",registered:t.isRegistered,msl:!0};if(e.mdxVersion.matches(0,0,0))o.merge(n,{registrationAcceptance:a.registrationModes.DEFAULT_PIN});else{if(!e.mdxVersion.isGreaterThanOrEqual(4,0,0))return void s.error("Cannot send cast handshake response for unexpected controller version",e.mdxVersion.toString());var i=navigator.appVersion||"",c=/CrKey\/(\d+.\d+.\d+)/.exec(i),l=new p(c?c[1]:""),f=(nrdp.device.softwareVersion||"").split("|"),v=f[0],g=f.length&&f[1],h=e.opts.handshake&&e.opts.handshake.mdxContractVersion||d.current.mdxContractVersion;o.merge(n,{registrationAcceptance:d.current.registrationMode,version:d.current.version,handshake:{accepted:d.current.mdxContractVersion===h,contractVersion:d.current.mdxContractVersion,volumeControl:!0===d.current.volumeControl,volumeStep:d.current.volumeStep},uiVersion:d.current.uiVersion,platformVersion:d.current.nativeVersion,fwVersion:l,playerVersion:g,shellVersion:v})}r.send(e.senderId,n)},v.prototype.processMdxMessage=function(e,t){try{var n=this;e.type&&"castHandShake"===e.type?n.sendHandshakeResponse.call(n):l.prototype.processMdxMessage.call(n,e,t)}catch(e){s.error("CastControllerSession.processMdxMessage - Message  handling failed",e,e.stack)}},v.prototype.processMediaMessage=function(e,t){try{var n=this.device,r="CAST_"+e;c.newMarker(c.EVENTS[r],n.id,t);var i={device:n,payload:{},xid:0,type:"PLAYER_"+e};n.onAppMessage(i)}catch(e){s.error("CastControllerSession.processMediaMessage - Message handling failed",e,e.stack)}},v.prototype.dispatchMessage=function(e){e.url="cast://"+nrdp.device.ESN+e.url;try{return r.send(this.senderId,e),i.resolve()}catch(e){return i.reject(e)}},v.fromExisting=function(e,t){return new v(e.mdxVersion,t,e.mdxUuid,null,e.controllerOps)},v.prototype.sendAppMessage=function(e,t){return this.opts.incomingOnly?i.reject(new f(f.ERRORS.MESSAGING_ERROR),"Dropping message to device - this session only supports incoming messages"):l.prototype.sendAppMessage.call(this,e,t)},t.exports=v},{"../../builds/ld.js":1,"../configuration.js":39,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"../versionInfo.js":106,"./mdxSession.js":90,"./regPairFactory.js":96,q:37}],84:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../profiling/mdxProfiler.js"),c=e("../configuration.js"),a=e("../enums.js"),u=e("./mdxTargetSession.js"),d=e("../versionInfo.js"),l=e("../mdxError.js"),f={},p=function(){u.call(this);var e;return Object.defineProperties(this,{sessionId:{enumerable:!0,get:function(){return e},set:function(t){e=t}},protocol:{enumerable:!1,value:"cast://"}}),this};p.prototype=Object.create(u.prototype),p.prototype.appConnectionTimeout=2e4,p.prototype.deviceConnectionTimeout=1e4,p.prototype.guestModeDeviceConnectionTimeout=9e4,p.prototype.sendCastHandshake=function(e,t){var n=this,i=n.device,o=i.mdxUuid,a=t&&t.newSubEvent(s.EVENTS.CAST_HANDSHAKE),u=r.defer(),d={type:"castHandShake",uuid:o,friendlyName:i.friendlyName,controlleruuid:c.current.mdxUuid,payload:e,controllerMdxVersion:c.current.version,opts:{handshake:{mdxContractVersion:c.current.mdxContractVersion}}};return c.current.scheduler.retry(function(){var e=r.defer();return f[n.sessionId]=u,n.sendCastMessage.call(n,d).done(function(){a&&a.complete(),e.resolve()},function(){return n.cleanupCastConnection(!0).then(n.createDeviceConnection.bind(n)).then(n.createAppConnection.bind(n)).finally(e.reject)}),e.promise},500,2,"Failed to send the cast handshake to the target after max retries").then(function(){return u.promise},function(){return r.reject(new l(l.ERRORS.CONNECT_FAILED,"Failed to send the cast handshake"))}).timeout(3e4,"Timed out waiting for a cast handshake response from the target")},p.prototype.processCastHandshakeAck=function(e){var t=this,n=f[t.sessionId];if(!n)return void o.warn("Received an unexpected cast handshake ack",e);var r=t.device;r.isRegistered=e.registered,r.isMsl=!0;var s=i.find(a.registrationModes,function(t){return t===e.registrationAcceptance})||a.registrationModes.DISABLED;r.registrationMode=s,t.mdxVersion=new d(e.version?e.version:"4.0.0"),t.uiVersion=e.uiVersion||null,t.platformVersion=e.platformVersion,t.fwVersion=e.fwVersion||null,t.playerVersion=e.playerVersion||null,t.shellVersion=e.shellVersion||null,n.resolve()},p.prototype.processMdxMessage=function(e,t){var n=this;try{var r=e.type;r?"castHandShakeAck"===r?n.processCastHandshakeAck.call(n,e):"castHandShakeRequest"===r&&n.sendCastHandshake.call(n,n.device.discoveryComponent.config.defaultLaunchArgs):u.prototype.processMdxMessage.call(n,e,t)}catch(e){o.error("CastTargetSessionBase.processMdxMessage - Message  handling failed",e,e.stack)}},p.prototype.dispatchMessage=function(e){return this.sendCastMessage.call(this,e)},p.prototype.handleTargetConnection=function(e,t,n,i,o){var s=this,u=s.device,d=r.defer(),f=a.connectIntents,p=e===f.LAUNCH||e===f.LAUNCH_AND_CONTROL,v=e===f.LAUNCH_AND_CONTROL;if(u.launchState===a.launchStates.LAUNCHED||o||(u.launchState=a.launchStates.PENDING),u.isGuestMode&&e===f.JOIN&&!u.canJoinInGuestMode)c.current.scheduler.async(d.reject.bind(d,new l(l.ERRORS.CANCELLED,"Cast target is in guest mode - join not permitted")));else{var g;g=s.createDeviceConnection?s.createDeviceConnection.call(s,n).then(s.createAppConnection.bind(s,p,n)):r.resolve({launched:!0}),g.done(function(e){e.launched?s.sendCastHandshake.call(s,t,n).then(s.startSession.bind(s,v,i)).then(function(){u.isGuestMode&&(u.canJoinInGuestMode=!0)}).done(d.resolve,d.reject):(u.launchState=a.launchStates.NOT_LAUNCHED,d.reject(new l(l.ERRORS.APP_NOT_RUNNING)))},function(e){e&&"ETIMEDOUT"===e.code&&(e=new l(l.ERRORS.CONNECT_FAILED,e.message)),d.reject(e)})}return d},p.prototype.dispose=function(){var e=this;return e.sessionId&&(e.sessionId=null),r.resolve()},t.exports=p},{"../../builds/ld.js":1,"../configuration.js":39,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"../versionInfo.js":106,"./mdxTargetSession.js":91,q:37}],85:[function(e,t,n){var r=e("q"),i=(e("../logging/logger.js"),e("../enums.js")),o=e("./castTargetSessionBase.js"),s=e("../mdxError.js"),c=function(e){var t=this,n=t.device,r=i.discoveryStates.UNAVAILABLE,o=i.launchStates.NOT_LAUNCHED;t.castSession.status===chrome.cast.SessionStatus.CONNECTED?(r=i.discoveryStates.AVAILABLE,o=i.launchStates.LAUNCHED):(t.end(!1,!0),t.castSession=null),n.discoveryState=r,n.launchState=o},a=function(e,t){if(e===this.namespace)try{var n=new Date,r=JSON.parse(t);this.processMdxMessage(r,n)}catch(e){}},u=function(e,t){var n=this;o.call(n);var r,i=c.bind(n),s=a.bind(n);return Object.defineProperties(n,{namespace:{enumerable:!1,writable:!1,value:t},castSession:{enumerable:!1,get:function(){return r},set:function(e){e!==r&&(r&&(r.removeUpdateListener(i),r.removeMessageListener(n.namespace,s)),(r=e)&&(r.addUpdateListener(i),r.addMessageListener(n.namespace,s)))}}}),n.castSession=e,n};u.prototype=Object.create(o.prototype),u.prototype.sendCastMessage=function(e){var t=r.defer(),n=this;return n.castSession.sendMessage(n.namespace,e,function(){t.resolve()},function(e){t.reject(new s(s.ERRORS.MESSAGING_ERROR,"Failed to send payload on cast channel. Error: "+e))}),t.promise},u.prototype.stop=function(){var e=r.defer();return this.castSession?(this.castSession.stop(e.resolve,e.reject),e.promise):r.reject()},t.exports=u},{"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"./castTargetSessionBase.js":84,q:37}],86:[function(e,t,n){var r=e("q"),i=e("../logging/logger.js"),o=e("../profiling/mdxProfiler.js"),s=e("../enums.js"),c=e("../configuration.js"),a=e("./castTargetSessionBase.js"),u=e("../mdxError.js"),d=function(){},l=function(e){var t=this;return t.channel&&t.channel.sendTextMessage.call(t.channel,JSON.stringify(e))?r.resolve():r.reject(new u(u.ERRORS.MESSAGING_ERROR,"Failed to send payload on cast channel: "+e))},f=function(){return a.call(this),Object.defineProperties(this,{channel:{enumerable:!1,writable:!0,value:null}}),this};f.prototype=Object.create(a.prototype),f.prototype.createDeviceConnection=function(e,t){var n,a=this,l=a.device,f=l.CAST_EVENTS,p=e&&e.newSubEvent(o.EVENTS.CAST_DEVICE_CONNECT),v=c.current.scheduler,g=s.discoveryStates,h=l.isGuestMode?a.guestModeDeviceConnectionTimeout:a.deviceConnectionTimeout,E=r.defer(),m=function(){l.discoveryState=g.AVAILABLE,E.resolve()},y=function(n){var r=n.error;i.error("CastTargetSessionV2.deviceFailedToConnect",n);var o=r instanceof NFGCKError&&r.code===r.Cancelled&&l.isGuestMode;a.end.call(a,!1,!1).then(a.cleanupCastConnection.bind(a)).finally(function(){o?(a.device.deviceMgr.disconnectWithLeave(),a.device.deviceMgr=null,E.reject(new u(u.ERRORS.CANCELLED,"Cancelled by user from guest mode connection dialog"))):t?E.reject(r):c.current.scheduler.delay(function(){a.createDeviceConnection.call(a,e,!0).done(E.resolve,E.reject)},1e3)})},R=function(e){l.deviceMgr&&(l.addEventListener(f.CONNECT,m),l.addEventListener(f.CONNECT_FAILED,y),e&&l.deviceMgr.connect(),n=v.repeat(function(){l.getConnectionState().then(function(e){!E.promise.isFulfilled()&&e.isConnected&&m()}).fail(d).done()},500,!1))},S=function(){var e=r.defer();return function t(){l.deviceMgr.connectionState(function(n){n===l.deviceMgr.ConnectionStateDisconnecting&&e.promise.isPending()?c.current.scheduler.delay(t,500):e.promise.isPending()?e.resolve():e.reject()})}(),e.promise.timeout(5e3)};return l.deviceMgr.connectionState(function(e){if(!l.deviceMgr)return void E.reject(new u(u.ERRORS.CONNECT_FAILED));switch(e){case l.deviceMgr.ConnectionStateConnected:l.discoveryState=g.AVAILABLE,E.resolve();break;case l.deviceMgr.ConnectionStateDisconnected:R(!0);break;case l.deviceMgr.ConnectionStateConnecting:R(!1);break;case l.deviceMgr.ConnectionStateDisconnecting:S().then(R(!0),function(){i.warn("CastTargetSessionV2.createDeviceConnection - Timed out waiting for a disconnection when state was CONNECTION_STATE_DISCONNECTING"),l.discoveryState=g.UNAVAILABLE,E.reject()})}}),E.promise.timeout(h,"Timed out attempting to create a device connection").finally(function(){n&&v.cancelRepeat(n),l.removeEventListener(f.CONNECT,m),l.removeEventListener(f.CONNECT_FAILED,y),p&&p.complete()})},f.prototype.createAppConnection=function(e,t,n){var a,l=this,f=l.device,p=f.CAST_EVENTS,v=t&&t.newSubEvent(o.EVENTS.CAST_DEVICE_CONNECT),g=s.launchStates,h=c.current.scheduler,E=r.defer(),m=function(e){f.launchState=g.LAUNCHED,l.sessionId=e.sessionId,E.resolve({launched:!0})},y=function r(o){var s=o.error,a=s instanceof NFGCKError;if(!a||s.code!==s.Cancelled)if(!!e&&i.error("CastTargetSessionV2.appSessionFailedToStart",s.code,s.getDescription()),f.launchState=g.NOT_LAUNCHED,a)switch(s.code){case s.ApplicationNotRunning:E.resolve({launched:!1});break;case s.Timeout:!n&&E.promise.isPending()?(f.removeEventListener(p.APP_CONNECT,m),f.removeEventListener(p.APP_CONNECT_FAILED,r),c.current.scheduler.delay(function(){l.createAppConnection.call(l,e,t,!0).done(E.resolve,E.reject)},1e3)):E.reject(new u(u.ERRORS.CONNECT_FAILED,s.toString()))}else E.reject(new u(u.ERRORS.CONNECT_FAILED,s.toString()))},R=function(t){if(f.deviceMgr){var n=function(){if(f.addEventListener(p.APP_CONNECT,m),f.addEventListener(p.APP_CONNECT_FAILED,y),t){var n=f.discoveryComponent.config;f.deviceMgr||E.reject(new u(u.ERRORS.CONNECT_FAILED)),e?f.deviceMgr.launchApplication(n.appId):f.deviceMgr.joinApplication(n.appId)}a=h.repeat(function(){f.getConnectionState().then(function(e){e.isConnectedToApp&&f.deviceMgr.applicationSessionID(function(e){E.promise.isFulfilled()||m({sessionId:e})})}).fail(d).done()},500,!1)};e?n():c.current.scheduler.retry(function(){var e=r.defer();return f.deviceMgr.applicationMetadata(function(t){void 0===t.applicationID?e.reject():e.resolve(t)}),e.promise},500,4).tap(function(e){e&&e.applicationID===f.discoveryComponent.config.appId||!e&&!f.isGuestMode?n():(f.launchState=s.launchStates.NOT_LAUNCHED,E.reject(new u(u.ERRORS.APP_NOT_RUNNING)))}).done()}},S=function(){var e=r.defer();return function t(){f.deviceMgr.applicationConnectionState.call(f.deviceMgr,function(n){n===f.deviceMgr.ConnectionStateDisconnecting&&e.promise.isPending()?c.current.scheduler.delay(t,500):e.promise.isPending()?e.resolve():e.reject()})}(),e.promise.timeout(5e3)};return f.deviceMgr.applicationConnectionState.call(f.deviceMgr,function(e){switch(f.deviceMgr||E.reject(new u(u.ERRORS.CONNECT_FAILED)),e){case f.deviceMgr.ConnectionStateConnected:f.launchState=g.LAUNCHED,f.deviceMgr.applicationSessionID(function(e){l.sessionId=e,E.resolve({launched:!0})});break;case f.deviceMgr.ConnectionStateDisconnected:R(!0);break;case f.deviceMgr.ConnectionStateConnecting:R(!1);break;case f.deviceMgr.ConnectionStateDisconnecting:S().then(R.bind(this,!0),function(){f.launchState=g.NOT_LAUNCHED,i.warn("CastTargetSessionV2.createAppConnection - Timed out waiting for a disconnection when state was CONNECTION_STATE_DISCONNECTING"),E.reject()})}}),E.promise.timeout(l.appConnectionTimeout,"Timed out attempting to create an app connection").finally(function(){a&&h.cancelRepeat(a),f.removeEventListener(p.APP_CONNECT,m),f.removeEventListener(p.APP_CONNECT_FAILED,y),v&&v.complete()})},f.prototype.sendCastMessage=function(e){var t=this,n=t.device;if(!n.deviceMgr)return r.reject(new u(u.ERRORS.NOT_CONNECTED));if(t.channel&&t.channel.isConnected)return l.call(t,e);t.channel&&(t.channel.expectedDisconnect=!0,n.deviceMgr&&n.deviceMgr.removeChannel(t.channel),t.channel=null);var i=r.defer(),o=!1,s=NFGCKCastChannel.jsInitWithNamespace;"function"!=typeof s&&(s=NFGCKCastChannel.initWithNamespace);var a=s(n.discoveryComponent.config.mdxNamespace,function(e){try{var n=new Date,r=JSON.parse(e);t.processMdxMessage.call(t,r,n)}catch(e){}},function(){o=!0,c.current.scheduler.async(function(){l.call(t,e).done(i.resolve,i.reject)})},function(){n.deviceMgr&&n.deviceMgr.removeChannel(a),t.channel&&!t.channel.expectedDisconnect&&(t.clearMsgQueues(),t.channel=null)});return a?(t.channel=a,t.device.deviceMgr.addChannel(t.channel,function(e){e||i.reject()}),i.promise):r.reject(new u(u.ERRORS.MESSAGING_ERROR,"Failed to create cast channel"))},f.prototype.dispose=function(){var e=this;return a.prototype.end.call(e,!1,!0).then(e.cleanupCastConnection.bind(e))},f.prototype.cleanupCastConnection=function(e){var t=this,n=t.device;return e?n.initDeviceManager():(n.deviceMgr&&t.channel&&(t.channel.expectedDisconnect=!0,n.deviceMgr.removeChannel(t.channel),t.channel=null),r.resolve())},t.exports=f},{"../configuration.js":39,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./castTargetSessionBase.js":84,q:37}],87:[function(e,t,n){var r=e("q"),i=e("../logging/logger.js"),o=e("../enums.js"),s=e("../httpFactory.js"),c=e("../configuration.js"),a=e("./msgBusFactory.js"),u=e("../profiling/mdxProfiler.js"),d=e("./ping.js"),l=e("./mdxTargetSession.js"),f=e("../mdxError.js"),p=function(e){var t=this;return t.msgBus?r.resolve():a.createMsgBus(e).then(function(e){t.msgBus=e,e.onMessage=t.processMdxMessage.bind(t)})},v=function(e,t){var n=r.defer(),a=this,d=a.device,l=t.newSubEvent(u.EVENTS.DIAL_CONNECT),f=function(){var t=d.EVENTS.LAUNCH_STATE_CHANGED,r=function(){d.launchState===o.launchStates.LAUNCHED&&(d.removeEventListener(t,r),n.resolve())};d.launchState=o.launchStates.PENDING,d.addEventListener(t,r),i.info("Launching target",d.friendlyName);var a=d.dialInfo.dialAppUrl;s.createHttpClient(c.current.platform).post(a,e),d.discoveryComponent.enablePostLaunchSearch.call(d.discoveryComponent)};if(d.mdxInfo.isAvailable)a.verifyTargetLaunched.call(a,d,d.dialInfo.isAvailable).done(function(){n.resolve()},f);else{if(!d.dialInfo.isAvailable){var p="Cannot launch on target - DIAL service not available";return i.info(p,d.friendlyName),r.reject(p)}f()}return n.promise.finally(function(){l.complete()})},g=function(e){l.call(this,e);var t=null;return Object.defineProperties(this,{msgBus:{enumerable:!1,get:function(){return t},set:function(e){t=e}},protocol:{enumerable:!1,get:function(){return t?t.protocol:"unknown://"}}}),this};g.prototype=Object.create(l.prototype),g.prototype.processMdxMessage=function(e,t){try{l.prototype.processMdxMessage.call(this,e,t)}catch(e){i.error("Message handling failed",e,e.stack)}},g.prototype.dispatchMessage=function(e){var t=this;return t.msgBus?t.msgBus.send(e):r.reject(new f(f.ERRORS.PROTOCOL_ERROR,"Msg bus not initialized"))},g.prototype.sendMdxMessage=function(e,t){var n=this;return n.msgBus?l.prototype.sendMdxMessage.call(n,e,t):r.reject(new f(f.ERRORS.PROTOCOL_ERROR,"Msg bus not initialized"))},g.prototype.sendSessionMessage=function(e){var t=this;return t.msgBus?l.prototype.sendSessionMessage.call(t,e):r.reject(new f(f.ERRORS.PROTOCOL_ERROR,"Msg bus not initialized"))},g.prototype.verifyTargetLaunched=function(e,t){if(t){var n=e.dialInfo.dialAppUrl;s.createHttpClient(c.current.platform).post(n,"")}return p.call(this,e).then(function(){return d.pingTarget.call(e.session,e).fail(function(){throw new f(f.ERRORS.APP_NOT_RUNNING)})})},g.prototype.handleTargetConnection=function(e,t,n,i){var s,c=this,a=c.device,u=o.connectIntents,d=e===u.LAUNCH||e===u.LAUNCH_AND_CONTROL,l=e===u.LAUNCH_AND_CONTROL,g=r.defer();if(d)s=v.call(c,t,n,!0).then(p.bind(c,a));else{if(!a.mdxInfo.isAvailable)return g.reject(new f(f.ERRORS.APP_NOT_RUNNING)),g;s=c.verifyTargetLaunched.call(c,a,!1)}return s.then(c.startSession.bind(c,l,i),function(e){return f.ERRORS.PROTOCOL_ERROR.isEqual(e)?r.reject(new f(f.ERRORS.CONNECT_FAILED,e.message)):r.reject(e)}).done(g.resolve,g.reject),g},t.exports=g},{"../configuration.js":39,"../enums.js":65,"../httpFactory.js":67,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./mdxTargetSession.js":91,"./msgBusFactory.js":92,"./ping.js":95,q:37}],88:[function(e,t,n){var r=e("../../builds/ld.js"),i=e("../logging/logger.js"),o=e("../enums.js"),s=e("../profiling/mdxProfiler.js"),c={},a=function(e){return"error"===e.action},u=function(e,t,n){n&&(n.id=s.EVENTS.ERROR);var a=parseInt(e.errorcode),u=r.find(o.errors,function(e){return a===e.code});return c[e.nonce]?c[e.nonce](u):(i.warn("Remote device reported an error",t.id,e),t.disconnectFromApp())},d=function(e,t){c[e]=t},l=function(e){delete c[e]};t.exports={canHandle:a,handleMsg:u,registerErrorHandler:d,clearErrorHandler:l}},{"../../builds/ld.js":1,"../enums.js":65,"../logging/logger.js":70,"../profiling/mdxProfiler.js":77}],89:[function(e,t,n){var r=e("q"),i=e("../logging/logger.js"),o=e("./mdxSession.js"),s=e("../mdxError.js"),c=function(e,t,n,r){o.call(this,e,r);var i=t;return Object.defineProperties(this,{protocol:{enumerable:!1,value:"http://"},senderId:{enumerable:!0,get:function(){return i},set:function(e){i=e}},senderGuid:{enumerable:!1,get:function(){return i.substr(i.indexOf(":")+1)}},opts:{enumerable:!1,value:r||{}}}),n&&(this.messageBus=n),this};c.prototype=Object.create(o.prototype),c.prototype.processMdxMessage=function(e,t){try{var n=this;o.prototype.processMdxMessage.call(n,e,t)}catch(e){i.error("MdxControllerSession.processMdxMessage - Message  handling failed",e,e.stack)}},c.prototype.dispatchMessage=function(e){i.trace("MdxControllerSession.dispatchMessage",e);try{return this.messageBus.send(e),r.resolve()}catch(e){return r.reject(e)}},c.fromExisting=function(e,t){return new c(e.mdxVersion,t,e.mdxUuid,null,e.controllerOps)},c.prototype.sendAppMessage=function(e,t){return this.opts.incomingOnly?r.reject(new s(s.ERRORS.MESSAGING_ERROR),"Dropping message to device - this session only supports incoming messages"):o.prototype.sendAppMessage.call(this,e,t)},t.exports=c},{"../logging/logger.js":70,"../mdxError.js":76,"./mdxSession.js":90,q:37}],90:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../profiling/mdxProfiler.js"),c=e("./validation.js"),a=e("./pairing.js"),u=e("./appMessage.js"),d=e("./broadcast.js"),l=e("./ping.js"),f=e("./error.js"),p=e("../configuration.js"),v=e("./securityFactory.js"),g=e("./msgFactory.js"),h=e("../enums.js"),E=e("../discovery/discoveryUtils.js"),m=e("../mdxError.js"),y=1,R=[u,a,d,l,f],S=function(e,t,n,r,i){var c=this,a=c.device,u=r.newSubEvent(s.EVENTS.DISPATCH_MSG);c.dispatchMessage.call(c,t).tap(function(){u.complete()}).timeout(6100).tap(function(){r.complete(),p.current.scheduler.async(I.bind(c))}).done(function(){i.resolve(n)},function(e){o.warn("Failed to dispatch message. Error: "+e,n),s.newMarker(s.EVENTS.DROPPED,a.id),i.reject(e)})},I=function e(){var t=this,n=t.device,r=t.sendQueue;if(r.processTimeout&&(p.current.scheduler.cancelDelay(r.processTimeout),r.processTimeout=null),!r.length)return void(r.isProcessing=null);r.processTimeout=p.current.scheduler.delay(function(){o.error("Outgoing message queue stalled",n.id,n.friendlyName),e.call(t)},1e4);var i=r.shift();n&&n.session||e.call(t);var a=i.msgData,u=a.body,d=l.canHandle(u)?u.id:u.nonce,f=d||t.createMsgNonce(),E=i.profilerEvent,y=function(e,n){var o,a={url:"/"+e};n&&n.legacyMessageEncryption&&(a.legacyMessageEncryption=n.legacyMessageEncryption,delete n.legacyMessageEncryption),o=E.newSubEvent(s.EVENTS.PAIRIFY),a.body=c.processOutgoingMessage(n),o.complete(),S.call(t,r,a,f,E,i.deferred)};if(i.isSessionMsg){var R=c.processOutgoingMessage(a.body);a.body=g.sessionMsgEnv(f,n,"1.0",R);var I=function(){
t.context.processOutgoingSessionMsg(a.body,E).done(function(e){y.call(t,a.cmd,e)},function(e){m.ERRORS.CRYPTO_ERROR.isEqual(e)&&t.device.clearPairing(),i.deferred.reject()})};if(t.context)I();else if(n.sharedSecret){var T=E.newSubEvent(s.EVENTS.CREATE_CTX),A=v.createSecurityProvider(p.current.platform),O="Failed to create session context when processing outgoing message. Message will be dropped";A.beginContext(n.sharedSecret).finally(function(){T.complete()}).done(function(e){e||o.warn(O,a),t.context=e,I()},function(e){o.warn(O,e,a)})}else t.sendMdxMessage(g.error(f,n,h.errors.SESSION_INVALID_HMAC),"session"),p.current.scheduler.async(e.bind(t))}else y.call(t,a.cmd,a.body)},T=function(e,t,n,r,i,c){if(e.length>50)return o.error(c+"queue overflow. Dropping msg"),s.newMarker(s.EVENTS.DROPPED,r.id),void i.complete();e.push(t);var a=new Date-e.isProcessing;if(e.isProcessing){if(e.length>1||a<1e4)return;1===e.length&&a>1e4&&o.error("Stale queue.isProcessing flag detected",t)}e.isProcessing=new Date,n.call(r.session)},A=function(e,t){var n=this,i=n.device,o=r.defer(),c=e.cmd.toUpperCase(),a=s.EVENTS[c]||s.EVENTS.UNKNOWN,u=s.newEvent(a),d={msgData:e,profilerEvent:u,deferred:o,isSessionMsg:t};return T(n.sendQueue,d,I,i,u,"receive"),o.promise},O=function e(){var t=this,n=t.device,r=t.receiveQueue;if(r.processTimeout&&(p.current.scheduler.cancelDelay(r.processTimeout),r.processTimeout=null),!r.length)return void(r.isProcessing=null);r.processTimeout=p.current.scheduler.delay(function(){o.error("Receive message queue stalled",n.id,n.friendlyName),e.call(t)},1e4),r.processTimeout;var c=r.shift(),a=c.msg,u=(l.canHandle(a)?a.id:a.nonce,c.profilerEvent),d=c.queueStart;if(u.newSubEvent(s.EVENTS.QUEUED,d).complete(),(new Date).valueOf()-d>3e4)return o.error("Dropping msg. Queue timeout",a),s.newMarker(s.EVENTS.DROPPED,n.id),void p.current.scheduler.async(e.bind(t));var f=function(n){o.error("Exception when handling incoming message",a,n,n.stack),p.current.scheduler.async(e.bind(t))};try{if(!i.any(R,function(r){if(r.canHandle(a)){try{r.handleMsg.call(t,a,n,u).then(function(e){e&&(o.trace("Message handling complete. Forwarding on payload",e),n.onAppMessage(e))},function(e){o.warn("MdxSession.processReceivedQueue - Message handling failed",a,e,e.stack)}).finally(function(){u.complete(),p.current.scheduler.async(e.bind(t))})}catch(e){f(e)}return!0}return!1}))return s.newMarker(s.EVENTS.DROPPED,n.id),void p.current.scheduler.async(e.bind(t))}catch(e){f(e)}},N=function(e){var t=this;if(e.device===t.device){var n=Number(e.payload.duration);if(n<1)return void o.error("Invalid duration received for target restart. Will not track it",e.payload.duration);var r=t.deviceRestartTracker||(t.deviceRestartTracker={});r.promise=t.device.trackRestart(n),r.cb&&r.cb(r)}},C=function(e,t){var n=this,r=null,i=null;return Object.defineProperties(n,{receiveQueue:{enumerable:!1,writable:!1,value:[]},sendQueue:{enumerable:!1,writable:!1,value:[]},mdxVersion:{enumerable:!0,writable:!0,value:e},mdxSessionId:{enumerable:!0,writable:!0,value:null},device:{enumerable:!1,get:function(){return r},set:function(e){r=e}},extendedOpts:{enumerable:!0,value:t},errMsgCount:{enumerable:!1,writable:!0,value:0},fromUrl:{enumerable:!1,get:function(){return i||(i=n.protocol+E.getLocalIpAddress()+":"+p.current.localMdxPort),i},set:function(e){i=e}}}),n};C.prototype.createMsgNonce=function(){var e;return e="undefined"!=typeof nrdp&&i.isFunction(nrdp.now)?nrdp.now():(new Date).valueOf(),e<=y&&(e=y+1),y=e,e},C.prototype.processMdxMessage=function(e,t){try{var n=this,r=n.device;r.lastSeen=(new Date).valueOf();var i=s.newEvent(s.EVENTS.UNKNOWN_MSG,r.id,t),a=i.newSubEvent(s.EVENTS.VALIDATE_MSG),u=c.parseAndValidateMsg(e.body),d=l.canHandle(u)?u.id:u.nonce;if(!u){s.newMarker(s.EVENTS.DROPPED,r.id,t);var f=u?h.errors.SESSION_INVALID_NONCE:h.errors.SESSION_MALFORMED_MESSAGE;return void n.sendMdxMessage(g.error(d,r,f),"session")}a.complete();var p={msg:u,device:r,profilerEvent:i,queueStart:new Date};T(n.receiveQueue,p,O,r,i,"send")}catch(e){o.error("MdxSession.processMdxMessage - Message handling failed",e,e.stack)}},C.prototype.sendMdxMessage=function(e,t){var n=this,r=(n.device,t||e.action);return A.call(n,{cmd:r,body:e},!1)},C.prototype.sendSessionMessage=function(e){return A.call(this,{cmd:"session",body:e},!0)},C.prototype.sendAppMessage=function(e,t){var n=this,i=n.device;if("targetrestarting"===e){var s={action:"broadcast",nonce:n.createMsgNonce(),fromuuid:p.current.mdxUuid,fromurl:n.fromUrl,messageType:"targetrestarting",payload:t};return o.trace("MdxSession.sendMdxMessage",e,t,i.id,i.friendlyName),n.sendMdxMessage(s,"broadcast")}if(!n.mdxSessionId||n.disconnectDeferred){return r.reject(new m(m.ERRORS.NOT_CONNECTED,"Dropping message for this session as we don't have a valid session id or are in the process of disconnecting"))}return n.sendSessionMessage(g.customAppMsg(n.mdxSessionId,e,t))},C.prototype.processEncryptedMessage=function(e,t){var n=r.defer(),i=this,c=i.device,a=i.context;if(a)return a.processEncryptedMessage(e,t);if(!c.sharedSecret){if(p.current.platform.role===h.roles.TARGET){o.warn("We don't have a pairing context to support message decryption");var u=l.canHandle(e)?e.id:e.nonce;i.sendMdxMessage(g.error(u,c,h.errors.SESSION_INVALID_HMAC),"session")}else s.newMarker(s.EVENTS.DROPPED);return r.reject(new m(m.ERRORS.MESSAGING_ERROR,"No shared secret"))}var d=t.newSubEvent(s.EVENTS.CREATE_CTX);return v.createSecurityProvider(p.current.platform).beginContext(c.sharedSecret).finally(function(){d.complete()}).done(function(r){r||n.reject(new m(m.ERRORS.MESSAGING_ERROR,"beginContext failed")),i.context=r,i.processEncryptedMessage(e,t).done(n.resolve,n.reject)},n.reject),n.promise},C.prototype.clearMsgQueues=function(){i.forEach([this.sendQueue,this.receiveQueue],function(e){for(e.processTimeout&&(p.current.scheduler.cancelDelay(e.processTimeout),e.processTimeout=null);e.length;)e.pop();e.isProcessing=null})},C.prototype.end=function(e,t,n){var i=this,o=r.defer(),s=t&&null!==i.mdxSessionId&&void 0!==i.mdxSessionId,c=function(){return i.clearMsgQueues(),n?i.sendSessionMessage(g.endSessionAck(i.mdxSessionId)):r.resolve()},a=function(){i.mdxSessionId=null,i.context&&(i.context.end(),delete i.context,i.errMsgCount=0),i.fromUrl=null,s&&i.device.onAppConnectionEnded(),i.disconnectDeferred&&(i.disconnectDeferred=null),o.resolve()},d=function(){var e=r.defer(),t=function(t){t.session===i&&t.msg.sessionId===i.mdxSessionId&&e.resolve()};return i.supportsEndAck?(u.addMessageListener(u.events.endSessionAck,t),e.promise.timeout(5e3).tap(u.removeMessageListener.bind(u,u.events.endSessionAck,t))):r.resolve()};return e?(i.disconnectDeferred=o,i.sendSessionMessage(g.endSession(i.mdxSessionId)).then(d).tap(c).finally(a)):c().finally(a),o.promise},C.prototype.startSession=function(e,t){var n=this,i=n.device,o=r.defer(),s=function(i){return i.code===h.errors.SESSION_INVALID_HMAC.code||i.code===h.errors.SESSION_UNKNOWN_SENDER.code?(n.device.clearPairing(),n.startSession(e,t)):r.reject(i)},c=N.bind(n);return e&&i.registrationMode===h.registrationModes.DARWIN_XPROFILE_V1&&d.addMessageListener("targetrestarting",c),i.sharedSecret&&p.current.currentMdxId?u.startSession.call(n,i).fail(s).done(o.resolve,o.reject):a.pairWithTarget.call(n,i,e,t).then(n.handleCrossProfileRegpairSupport.bind(n)).then(u.startSession.bind(n,i)).fail(s).done(o.resolve,o.reject),o.promise.finally(function(){e&&i.registrationMode===h.registrationModes.DARWIN_XPROFILE_V1&&(d.removeMessageListener("targetrestarting",c),delete n.targetRestartTracker)})},C.prototype.handleCrossProfileRegpairSupport=function(e){var t=this,n=t.device;if(!e.wasRegPair||n.registrationMode!==h.registrationModes.DARWIN_XPROFILE_V1)return r.resolve();var i=r.defer(),o=new m(m.ERRORS.CANNOT_PAIR,"Did not detect a successful target restart so the pairing is aborted");if(t.deviceRestartTracker)t.deviceRestartTracker.promise.done(i.resolve,i.reject.bind(i,o));else{var s=r.defer();t.deviceRestartTracker={cb:s.resolve},s.promise.timeout(5e3).then(function(e){e.promise.done(i.resolve,i.reject.bind(i,o))}).fail(i.reject.bind(i,new m(m.ERRORS.CANNOT_PAIR,"The target device did not notify the controller that is was restarting within the timeout period so the pair request is aborted")))}return i.promise.finally(function(){t.deviceRestartTracker=null})},t.exports=C},{"../../builds/ld.js":1,"../configuration.js":39,"../discovery/discoveryUtils.js":63,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./appMessage.js":81,"./broadcast.js":82,"./error.js":88,"./msgFactory.js":93,"./pairing.js":94,"./ping.js":95,"./securityFactory.js":97,"./validation.js":98,q:37}],91:[function(e,t,n){var r=e("q"),i=(e("../../builds/ld.js"),e("../logging/logger.js"),e("../enums.js")),o=e("./mdxSession.js"),s=e("../versionInfo.js"),c=e("../mdxError.js"),a={},u=function(){return o.call(this,new s),this};u.prototype=Object.create(o.prototype),u.prototype.connectToTarget=function(e,t,n,o){var s=this,u=s.device;if(s.mdxSessionId&&!s.disconnectDeferred)return r.resolve();var d=a[u.id];if(d){var l=r.defer();return d.deferred.promise.done(function(){s.mdxSessionId?l.resolve():s.connectToTarget.call(s,e,t,n,o).done(l.resolve,l.reject)},function(r){if(r)if(c.ERRORS.CANCELLED.isEqual(r))l.reject(new c(c.ERRORS.CANCELLED,"Pending connection cancelled"));else if("ETIMEDOUT"===r.code)return void s.connectToTarget.call(s,e,t,n,o).done(l.resolve,l.reject);d.intent>=e?l.reject(r):d.intent===i.connectIntents.JOIN?s.connectToTarget.call(s,e,t,n,o).done(l.resolve,l.reject):d.intent===i.connectIntents.LAUNCH&&c.ERRORS.USER_MISMATCH.isEqual(r)?s.connectToTarget.call(s,e,t,n,!0).done(l.resolve,l.reject):s.connectToTarget.call(s,e,t,n,o).done(l.resolve,l.reject)}),l.promise}var f;return s.disconnectDeferred?(f=r.defer(),s.disconnectDeferred.promise.then(function(){if(f.promise.isPending()){var r=s.handleTargetConnection(e,t,n,o);a[u.id].deferred=r,r.promise.done(f.resolve,f.reject)}})):f=s.handleTargetConnection.apply(s,arguments),f.promise.finally(function(){delete a[u.id]}),a[u.id]={deferred:f,intent:e},f.promise},u.prototype.cancelPendingConnections=function(){var e=this,t=a[e.device.id];t&&(t.deferred.reject(new c(c.ERRORS.CANCELLED,"Pending connection cancelled by MDX")),e.dispose&&e.dispose())},t.exports=u},{"../../builds/ld.js":1,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../versionInfo.js":106,"./mdxSession.js":90,q:37}],92:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../configuration.js"),c=e("../webSocketFactory.js"),a=e("../httpFactory.js"),u=e("../enums.js"),d=e("../mdxError.js"),l=e("../devices/mdxTarget.js"),f=/v=(.*)\r\npath=(.*)\r\nxid=(.*)\r\n/,p=1,v=function(){return p++},g=function(){Object.defineProperties(this,{protocol:{enumerable:!1,writable:!0,value:"unknown://"}})},h=function(e){g.call(this);var t=this,n=e,i={};t.protocol="ws://",n.onmessage=function(e){var n,r=f.exec(e);if(r&&(n={version:r[1],path:r[2],xid:r[3],body:e.substr(e.indexOf("body=")+5)}),"response"===n.path){var o=i[n.xid];if(o){-1!==n.body.indexOf("error")?o.reject(n):o.resolve()}}else if(n){var c="status=ok";s.current.platform.role===u.roles.controller&&(c="body="+c),t.send({url:"response",body:c,reqId:n.xid}),t.onMessage&&t.onMessage(n)}},this.send=function(e){try{var t=e.url;t&&-1!==t.lastIndexOf("/",0)&&(t=t.substr(1));var o=e.reqId||v(),s=["v=1","path="+t,"xid="+o,"body="+e.body].join("\r\n"),c=r.defer();return i[o]=c,r(n.send(s)).fail(c.reject),c.promise.timeout(6e3)}catch(e){return r.reject(e)}}},E={enabled:!0,isCompatible:function(e){var t=e.mdxInfo.capabilities;return-1!==t.indexOf("websocket")&&-1!==t.indexOf("websocketclient")},createMsgBus:function(e){var t=r.defer(),n="ws://"+e.mdxInfo.ipAddressAndPort,i=c.createWebSocket(s.current.platform,n,!0),o=function(){i.onopen=null,t.resolve(new h(i))},a=function(e){i.onerror=null,t.reject(e)};return i.onopen=o,i.onError=a,t.promise}},m=function(e){g.call(this);var t=this,n=a.createHttpClient(s.current.platform),i="http://"+e.mdxInfo.ipAddressAndPort;if(t.protocol="http://",e instanceof l){o.info("HttpMsgBus target is instance of target");var c=function(e){!!e&&t.onMessage&&t.onMessage(e)};nrdp.mdx.addEventListener("incomingmessage",c)}this.send=function(e){try{return n.post(i+e.url,e.body,e.legacyMessageEncryption).timeout(6e3)}catch(e){return r.reject(e)}}},y={enabled:!0,isCompatible:function(e){return-1!==e.mdxInfo.capabilities.indexOf("http")},createMsgBus:function(e){var t=new m(e);return r.resolve(t)}};t.exports={protocols:{ws:E,http:y},configureProtocolsForPlatform:function(e){var t=this.protocols;switch(e.id){case 2:case 6:t.ws.enabled=!i.isUndefined(nrdp.mdx&&nrdp.mdx.SendWebSocketMessage)&&!i.isUndefined(nrdp.websocket);break;case 3:case 8:t.ws.enabled=!1;break;case 4:case 5:t.http.enabled=!1;break;default:throw new d(d.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot configure msg bus protocols for platform: "+e)}},createMsgBus:function(e){var t=this.protocols,n=i.find(t,function(t){return t.enabled&&t.isCompatible(e)?t:null});if(!n){if(e.mdxInfo.isAvailable){var s=i.reduce(t,function(e,t,n){return t.enabled?e+n+"|":e},"");s="^("+s.substr(0,s.length-1)+")";var c=new RegExp(s),a=c.exec(e.mdxInfo.location);a&&t[a[1]]&&(n=t[a[1]])}if(!n){var u="No compatible protocol found";return o.error(u,t,e,e.mdxInfo),r.reject(new d(d.ERRORS.PROTOCOL_ERROR,u))}}return n.createMsgBus(e).timeout(3e3)}}},{"../../builds/ld.js":1,"../configuration.js":39,"../devices/mdxTarget.js":50,"../enums.js":65,"../httpFactory.js":67,"../logging/logger.js":70,"../mdxError.js":76,"../webSocketFactory.js":107,q:37}],93:[function(e,t,n){var r=e("../configuration.js"),i=r.current.utf8,o=r.current.base64,s=function(e,t,n){return{action:"error",nonce:e,fromuuid:r.current.mdxUuid,touuid:t.mdxUuid,errorcode:n.code,errorstring:n.desc}},c=function(e,t,n,i,o){return{action:"pairingrequest",version:e,controllerurl:t,nonce:n,controlleruuid:r.current.mdxUuid,pairdatahmac:i,cticket:o}},a=function(e,t,n,i,o){var s=r.current.mdxUuid;return{action:"pairingresponse",version:i,nonce:e,targetuuid:s,errorcode:n.code,errorstring:n.desc,targetuserid:o?t.mdxIdPairs[o]:s}},u=function(e,t,n,i,o,s,c){var a=r.current.mdxUuid;return{action:"pairingresponse",version:n,controllersharedsecret:i,nonce:e,controlleruuid:t.mdxUuid,targetuuid:a,controlleruserid:o,targetuserid:s||a,grantdatahmac:c}},d=function(e,t,n,i,o,s,c){var a={action:"regpairrequest",version:e,controllerurl:t,nonce:n,controlleruuid:r.current.mdxUuid,hmac:i,cticket:o,pin:s};return c&&(a.pairdatahmac=c),a},l=function(e,t,n,i){return{action:"regpairerror",version:i,nonce:e,targetuuid:r.current.mdxUuid,errorcode:n.code,errorstring:n.desc}},f=function(e,t,n,i,o){return{action:"regpairreply",version:t,controllersharedsecret:n,nonce:e,targetuuid:r.current.mdxUuid,userid:i,grantdatahmac:o}},p=function(e,t,n,i){var o=r.current.mdxUuid;return{action:"session",version:n,fromurl:t.session.fromUrl,fromuuid:o,fromuserid:r.current.currentMdxId,touuid:t.mdxUuid,touserid:t.currentMdxId||"",nonce:e,plaintext:i}},v=function(){return{sessionAction:"createSession"}},g=function(e){return{sessionAction:"startSessionResponse",sessionId:e,supportsEndAck:!0}},h=function(e){return{sessionAction:"endSession",sessionId:e,ack:!0}},E=function(e){return{sessionAction:"endSessionAck",sessionId:e}},m=function(e,t){return{sessionAction:"appMessage",sessionId:e,appAction:"HANDSHAKE_ACCEPTED",appBody:{accepted:r.current.mdxContractVersion==t,contractVersion:r.current.mdxContractVersion,volumeControl:!0===r.current.volumeControl,volumeStep:r.current.volumeStep}}},y=function(e,t,n){return{sessionAction:"appMessage",sessionId:e,appAction:t,appBody:n}},R=function(e,t,n){return{action:"pingsearch",fromuuid:r.current.mdxUuid,fromurl:t,servicetype:n,id:e}},S=function(e,t,n,s){return{action:"pingresponse",touuid:t.mdxUuid,fromuuid:r.current.mdxUuid,fromurl:n,responseheaders:r.current.responseHeaders,friendlyname:o.encode(i.encode(t.friendlyName||"")),servicetype:s,id:e}};t.exports={error:s,pairingRequest:c,pairingError:a,pairingSuccess:u,regPairRequest:d,regPairingError:l,regPairingSuccess:f,sessionMsgEnv:p,startSessionRequest:v,startSessionResponse:g,endSession:h,endSessionAck:E,handshakeAccepted:m,customAppMsg:y,pingRequest:R,pingResponse:S}},{"../configuration.js":39}],94:[function(e,t,n){var r=e("q"),i=e("../../builds/ld.js"),o=e("../logging/logger.js"),s=e("../profiling/mdxProfiler.js"),c=e("./msgFactory.js"),a=e("../enums.js"),u=e("../configuration.js"),d=e("./regPairFactory.js"),l=e("../apiEvents.js"),f=e("./securityFactory.js"),p=e("../mdxError.js"),v=null,g={},h={},E=function(){var e=r.defer();return i.forEach(u.current.dscMgr.devices,function(e){e.clearPairing()}),u.current.storage.clearPairings().finally(e.resolve),e.promise},m=function(e,t,n){n&&(n.id=s.EVENTS.PAIRINGREQUEST);var i=this;i&&i.end(!!i.mdxSessionId);var l=e.version,f=e.nonce,p=a.errors;if("1.0"!==l)return o.error("Incorrect pairing request version. Expected 1.0 but got "+l),i.sendMdxMessage(c.error(f,t,p.PAIRING_UNKNOWN_VERSION)),s.newMarker(s.EVENTS.MDX_PAIRINGREJECTED),r.resolve();var h,E=d.createProvider(u.current.platform);E.isRegistered?v&&(o.warn("Cannot Pair - There is currently a regpair request inflight for another device."),h=p.REGISTRATION_PAIRING_IN_PROGRESS):(o.warn("Cannot Pair - Device is not registered"),h=p.PAIRING_NOT_PAIRING);var m=function(e){i.sendMdxMessage(c.pairingError(f,t,e,"1.0")),s.newMarker(s.EVENTS.MDX_PAIRINGREJECTED)};if(h)return m(h),r.resolve();var y=g[t.id];y&&y.deferred.reject(p.PAIRING_ABORTED);var R=r.defer();g[t.id]={device:t,deferred:R};var S=n.newSubEvent(s.EVENTS.SERVER_PAIR);return E.mdxPair.pair(e.cticket,e.controlleruuid,e.pairdatahmac,f,u.current.mdxUuid).timeout(15e3).finally(function(){S.complete()}).then(function(e){var n=e.controllerMdxId,r=e.targetMdxId;if(u.current.currentMdxId=r,n===r){var o=e.hmac;t.currentMdxId=n,t.sharedSecret=e.targetSharedSecret,i.sendMdxMessage(c.pairingSuccess(f,t,"1.0",e.controllerSharedSecret,n,r,o))}else m({code:"USER_MISMATCH",desc:"MDX UI: Target / controller user mismatch"})},function(e){if(e&&"ETIMEDOUT"===e.code)return o.error("The server pair request timed out",e),void m(p.PAIRING_NETWORK_ERROR);m(e)}).finally(function(){R.resolve()}).catch(function(){}),R.promise},y=function(e,t,n,i){var s=r.defer(),c=n.deferred;return n.context.hmac(i).then(function(r){if(e.grantdatahmac!==r){var i="Invalid hmac string in pairing response calculated: "+r+" received: "+e.grantdatahmac;return o.error(i),t.clearPairing(),c.resolve({isPaired:!1,retry:!0,error:new p(p.ERRORS.CRYPTO_ERROR)}),void s.resolve()}n.context.decrypt(e.controllersharedsecret).done(function(n){t.sharedSecret=n,t.isRegistered=!0,t.currentMdxId=e.targetuserid||e.userid,u.current.currentMdxId=e.controlleruserid||e.userid,c.resolve({isPaired:!0,wasRegPair:"regpairreply"===e.action}),s.resolve()},function(){c.reject(),s.resolve()})},function(e){c.reject(e),s.resolve()}),s.promise},R=function(e,t,n){n&&(n.id=s.EVENTS.PAIRINGRESPONSE);var i=h[e.nonce];if(!i)return o.error("Unexpected pairing response",e),r.resolve();var c=i.deferred,a=e.version;if("1.0"!==a){var u="Incorrect pairing response version. Expected 1.0 but got "+a;return o.error(u),c.reject(new p(p.ERRORS.CANNOT_PAIR,u)),r.resolve()}var d="controllersharedsecret="+encodeURIComponent(e.controllersharedsecret)+"&controlleruserid="+encodeURIComponent(e.controlleruserid)+"&controlleruuid="+encodeURIComponent(e.controlleruuid)+"&nonce="+encodeURIComponent(e.nonce)+"&targetuserid="+encodeURIComponent(e.targetuserid)+"&targetuuid="+encodeURIComponent(e.targetuuid);return y(e,t,i,d)},S=function(e,t){var n=this,i=r.defer(),s=n.createMsgNonce();return e.encrypt("00000").done(function(r){var a="action=regpairrequest&nonce="+encodeURIComponent(s)+"&pin="+encodeURIComponent(r);e.hmac(a).then(function(o){var a=function(a){return h[s]={deferred:i,context:e},n.sendMdxMessage(c.regPairRequest("2.0",n.fromUrl,s,o,t,r,a))};if(n.device.isMsl){var d="controlleruuid="+encodeURIComponent(u.current.mdxUuid)+"&nonce="+encodeURIComponent(s);return e.hmac(d).then(function(e){return a(e)})}return a()}).done(function(){},function(){o.error("Failed to hmac sign the regpair payload"),n.device.clearPairing(),i.reject(new p(p.ERRORS.CRYPTO_ERROR))})},function(){o.error("Failed to encrypt the regpair pin"),n.device.clearPairing(),i.reject(new p(p.ERRORS.CRYPTO_ERROR))}),i.promise.timeout(15e3).finally(function(){delete h[s]})},I=function(e,t,n,i){var o=this,s=a.errors;"USER_MISMATCH"===e.errorcode?e.errorcode=s.PAIRING_USER_MISMATCH.code:"PROFILE_MISMATCH"===e.errorcode?e.errorcode=s.REGISTRATION_PROFILE_MISMATCH.code:e.errorcode=parseInt(e.errorcode);var c,d=n.deferred;switch(e.errorcode){case s.PAIRING_UNKNOWN_VERSION.code:c="Pair failed with PAIRING_UNKNOWN_VERSION",t.blacklist(c),d.reject(new p(p.ERRORS.CANNOT_PAIR,c));break;case s.PAIRING_INVALID_CONTROLLER_REQUEST.code:case s.PAIRING_SERVER_ERROR.code:case s.PAIRING_TARGET_ERROR.code:case s.PAIRING_SERVER_NOT_REACHABLE.code:case s.PAIRING_ABORTED.code:case s.PAIRING_CONTROLLER_HMAC_FAILURE.code:d.resolve({isPaired:!1,retry:!0});break;case s.PAIRING_CONTROLLER_CTICKET_EXPIRED.code:case s.PAIRING_CONTROLLER_CTICKET_CORRUPTED.code:case s.PAIRING_NO_CTICKET.code:c="CTICKET issue with pairing: "+e.errorstring,d.reject(new p(p.ERRORS.INVALID_CTICKET));break;case s.PAIRING_NOT_PAIRING.code:case s.PAIRING_USER_MISMATCH.code:i?d.reject(new p(p.ERRORS.CANNOT_PAIR,e.errorcode+" - "+e.errorstring)):n.activate&&t.registrationMode!==a.registrationModes.DISABLED?f.createSecurityProvider(u.current.platform).getCTicket().then(function(e){if(!e)return void d.reject(new p(p.ERRORS.INVALID_CTICKET));S.call(o,n.context,e).done(d.resolve,d.reject)}):d.resolve({isPaired:!1,retry:!1,canActivate:t.registrationMode!==a.registrationModes.DISABLED});break;case s.REGISTRATION_PROFILE_MISMATCH.code:d.resolve({isPaired:!1,retry:!1,canActivate:!1});break;default:d.reject(new p(p.ERRORS.CANNOT_PAIR,e.errorcode+" - "+e.errorstring))}return r.resolve()},T=function(e,t,n){n&&(n.id=s.EVENTS.PAIRING_ERROR_RESPONSE);var i=h[e.nonce];return i?I.call(this,e,t,i,!1):(o.error("Unexpected pairing response",e),r.resolve())},A=function(e,t,n){n&&(n.id=s.EVENTS.REGPAIRREQUEST);var i=this;i&&i.end(!!i.mdxSessionId);var f=e.version,p=e.nonce,g=a.errors;if("2.0"!==f)return o.error("Incorrect reg pairing request version. Expected 2.0 but got "+f),i.sendMdxMessage(c.error(p,t,g.PAIRING_UNKNOWN_VERSION)),s.newMarker(s.EVENTS.MDX_PAIRINGREJECTED),r.resolve();var h,m=d.createProvider(u.current.platform),y=a.registrationModes,R=u.current.registrationMode;R!==y.ENABLED&&R!==y.DEFAULT_PIN&&R!==y.DARWIN_XPROFILE_V1?(o.warn("Regpair request rejected as registration mode is "+R),h=g.REGISTRATION_NOT_REGISTERING):v&&v.device.id!==t.id&&(o.warn("Cannot Pair - There is currently a regpair request inflight for another device."),h=g.REGISTRATION_PAIRING_IN_PROGRESS);var S=function(e){i.sendMdxMessage(c.regPairingError(p,t,e||g.PAIRING_NETWORK_ERROR,"2.0")),s.newMarker(s.EVENTS.MDX_PAIRINGREJECTED)};if(h)return S(h),r.resolve();v&&v.deferred.reject(g.PAIRING_ABORTED);var I=r.defer();v={device:t,deferred:I};var T=n.newSubEvent(s.EVENTS.SERVER_NFLXID);return m.mdxActivate(u.current.mdxUuid,e.cticket,p,e.pin,u.current.pairingPin,e.controlleruuid,e.hmac,e.pairdatahmac).timeout(15e3).finally(function(){T.complete()}).then(function(e){var n=r.defer(),s={device:t,cookies:e.cookies,guid:e.guid,resolve:n.resolve,reject:n.reject};t.evtMgr.fireEvent(l.SWITCH_CREDENTIALS,s),n.promise.finally(function(){return E.call(i)}).done(function(n){n&&(u.current.profileId=n.profileId||null);var r=e.hmac,s=e.controllerMdxId;t.currentMdxId=s,t.sharedSecret=e.targetSharedSecret,u.current.currentMdxId=e.targetMdxId,o.info("Sending regpair response to controller",t.id,t.friendlyName);var a=function(){},d=n&&n.cb||a;i.sendMdxMessage(c.regPairingSuccess(p,"2.0",e.controllerSharedSecret,s,r)).then(d())},function(e){o.warn("UI rejected credential switch or failed to handle it",e),S(g.PAIRING_ABORTED)})},function(e){if(e&&"ETIMEDOUT"===e.code)return o.error("The server reg pair request timed out",e),void S(g.PAIRING_NETWORK_ERROR);S(e)}).finally(function(){v=null,I.resolve()}).catch(function(){}),I.promise},O=function(e,t,n){n&&(n.id=s.EVENTS.REGPAIRRESPONSE);var i=h[e.nonce];if(!i)return o.error("Unexpected pairing response",e),r.resolve();var c=e.version;if("2.0"!==c){var a="Incorrect regppair response version. Expected 2.0 but got "+c;return o.error(a),i.deferred.reject(new p(p.ERRORS.CANNOT_PAIR,a)),r.resolve()}var d;return d=t.isMsl?"controllersharedsecret="+encodeURIComponent(e.controllersharedsecret)+"&controlleruserid="+encodeURIComponent(e.userid)+"&controlleruuid="+encodeURIComponent(u.current.mdxUuid)+"&nonce="+encodeURIComponent(e.nonce)+"&targetuserid="+encodeURIComponent(e.userid)+"&targetuuid="+encodeURIComponent(e.targetuuid):"action=regpairreply&controllersharedsecret="+encodeURIComponent(e.controllersharedsecret)+"&nonce="+encodeURIComponent(e.nonce)+"&userid="+encodeURIComponent(e.userid),y(e,t,i,d)},N=function(e,t,n){n&&(n.id=s.EVENTS.REGPAIR_ERROR_RESPONSE);var i=h[e.nonce];return i?I.call(this,e,t,i,!0):(o.error("Unexpected pairing response",e),r.resolve())},C={pairingrequest:m,pairingresponse:R,pairingresponseError:T,regpairrequest:A,regpairreply:O,regpairerror:N},b=function(e){return C.hasOwnProperty(e.action)},j=function(e,t,n){return C[e.action].call(this,e,t,n).finally(function(){u.current.storage.storeDeviceMap(u.current.dscMgr.devices)})},D=function e(t,n,i){t.sharedSecret&&t.clearPairing();var o=function(e){if(h[e]){var t=h[e].context;t&&t.end()}delete h[e]},s=r.defer(),a=this,d=a.createMsgNonce(),l=f.createSecurityProvider(u.current.platform);return l.getCTicket().then(function(f){if(!f)return void s.reject(new p(p.ERRORS.INVALID_CTICKET));l.beginContext().done(function(l){if(i)S.call(a,l,f).done(s.resolve,s.reject);else{var v="controlleruuid="+encodeURIComponent(u.current.mdxUuid)+"&nonce="+encodeURIComponent(d);l.hmac(v).then(function(i){var u=r.defer();return h[d]={deferred:u,activate:n,context:l,cticket:f},u.promise.fail(function(e){s.reject(e)}),u.promise.done(function(r){r.isPaired&&!r.isError?s.resolve({wasRegPair:r.wasRegPair}):r.error?s.reject(r.error):r.retry?(o(d),e.call(a,t,n).done(s.resolve,s.reject)):r.canActivate?s.reject(new p(p.ERRORS.USER_MISMATCH)):s.reject(new p(p.ERRORS.REGISTRATION_NOT_SUPPORTED))}),a.sendMdxMessage(c.pairingRequest("1.0",a.fromUrl,d,i,f))})}}).fail(function(){s.reject(new p(p.ERRORS.CONNECT_FAILED,"Failed to create the encryption context"))})},function(){s.reject(new p(p.ERRORS.INVALID_CTICKET))}),s.promise.timeout(3e4,"Timed out waiting for pairing response").fail(function(e){return"ETIMEDOUT"===e.code?r.reject(new p(p.ERRORS.CONNECT_FAILED,"Pair response timeout")):r.reject(e)}).finally(o.bind(null,d))};t.exports={canHandle:b,handleMsg:j,clearAllPairings:E,pairWithTarget:D}},{"../../builds/ld.js":1,"../apiEvents.js":38,"../configuration.js":39,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./msgFactory.js":93,"./regPairFactory.js":96,"./securityFactory.js":97,q:37}],95:[function(e,t,n){var r=e("q"),i=(e("../logging/logger.js"),e("./msgFactory.js")),o=e("../profiling/mdxProfiler.js"),s={},c=function(e,t,n){n&&(n.id=o.EVENTS.PINGREQUEST);var r=this;return r.sendMdxMessage(i.pingResponse(e.id,t,r.fromUrl,"urn:mdx-netflix-com:service:target:2"),"mdxping")},a=function(e,t,n){n&&(n.id=o.EVENTS.PINGRESPONSE);var i=s[e.id];return i&&i.resolve(),r.resolve()},u=function(e){return e&&e.action&&("pingsearch"===e.action||"pingresponse"===e.action)},d=function(e,t,n){return"pingsearch"===e.action?c.call(this,e,t,n):a.call(this,e,t,n)},l=function(e){var t=r.defer(),n=this,o=n.createMsgNonce();return n.sendMdxMessage(i.pingRequest(o,n.fromUrl,"urn:mdx-netflix-com:service:target"),"mdxping"),s[o]=t,t.promise.timeout(3e3).finally(function(){delete s[o]})};t.exports={canHandle:u,handleMsg:d,pingTarget:l}},{"../logging/logger.js":70,"../profiling/mdxProfiler.js":77,"./msgFactory.js":93,q:37}],96:[function(e,t,n){var r,i,o=e("q"),s=e("../../builds/ld.js"),c=(e("../logging/logger.js"),e("../enums.js")),a=e("../mdxError.js"),u=function(e,t,n,r){for(var i,o=s.isUndefined(nrdp)?"NETWORK_ERROR":nrdp.NETWORK_ERROR;r.length;){var a=r.pop();if(a.data&&a.data.controlleruuid){i=a.data,i.guid=a.guid;break}(s.isUndefined(i)||i.result!==o)&&a.actionID||a.errorcode?i=a:a.result===o&&(i=a)}if(n&&n(t),!i||i.result===o)return void e.reject(c.errors.PAIRING_SERVER_NOT_REACHABLE);if(i.actionID||i.errorcode){var u=s.find(c.errors,function(e){return e.code===i.errorcode})||c.errors.PAIRING_UNKNOWN_ERROR;return void e.reject(u)}var d={pairingContext:i.grantdatahmac||"",hmac:i.grantdatahmac,controllerMdxId:i.controlleruserid,controllerSharedSecret:i.controllersharedsecret,targetSharedSecret:i.targetsharedsecret,targetMdxId:i.targetuserid,guid:i.guid,cookies:i.cookies};e.resolve(d)},d=function(){var e=this;this.pair=function(t,n,r,i,s){var c=o.defer();return nrdp.mdxnccp.pair(t,n,r,i,s,u.bind(e,c,n,e.finish)),c.promise},this.abort=nrdp.mdxnccp.abort.bind(this),this.finish=nrdp.mdxnccp.finish.bind(this)},l=function(e){this.mdxPair=new e};Object.defineProperties(l.prototype,{isRegistered:{enumerable:!0,get:function(){return nrdp.registration.registered}},currentDeviceAccount:{enumerable:!0,get:function(){return nrdp.registration.currentDeviceAccount}}}),l.prototype.mdxActivateFinish=function(e){return nrdp.registration.mdxActivateFinish(e)};var f=function(){l.apply(this,arguments)};f.prototype=Object.create(l.prototype),f.prototype.mdxActivate=function(e,t,n,r,i,s,c,a){var d=this,l=o.defer();return nrdp.registration.mdxMslActivate(e,t,n,r,i,s,c,a,u.bind(d,l,s,d.mdxActivateFinish)),l.promise};var p=function(){l.apply(this,arguments)};p.prototype=Object.create(l.prototype),p.prototype.mdxActivate=function(e,t,n,r,i,s,c){var a=this,d=o.defer();return nrdp.registration.mdxActivate(e,t,n,r,i,s,c,u.bind(a,d,s,a.mdxActivateFinish)),d.promise};var v=function(){return new f(d)},g=function(){if(void 0!==r.current.platform&&r.current.platform.id===c.platforms.NRDP_TARGET.id&&"undefined"!=typeof nrdp&&void 0!==nrdp.device&&void 0!==nrdp.device.SDKVersion&&void 0!==nrdp.device.SDKVersion.components&&e("nf-bridge-adapter").versionInfo.isLessThan("2014.1"))return i||(i=new p(d));return v()},h={2:g,3:v};t.exports={createProvider:function(t){var n=h[t.id];if(r=r||e("../configuration.js"),n)return n();throw new a(a.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot create registration provider for platform: "+t.name)}}},{"../../builds/ld.js":1,"../configuration.js":39,"../enums.js":65,"../logging/logger.js":70,"../mdxError.js":76,"nf-bridge-adapter":3,q:37}],97:[function(e,t,n){var r,i,o,s=e("q"),c=e("../../builds/ld.js"),a=e("../enums.js"),u=e("../profiling/mdxProfiler.js"),d=e("./validation.js"),l=e("../mdxError.js"),f=null,p=function(e){for(var t="",n=e instanceof ArrayBuffer?new Uint8Array(e):e,r=n.length,i=0;i<r;){var o=n[i++],s=o>>4;if(s<8)t+=String.fromCharCode(o);else if(s>=12&&s<=13){var c=n[i++];t+=String.fromCharCode((31&o)<<6|63&c)}else if(14===s){var a=n[i++],u=n[i++];t+=String.fromCharCode((15&o)<<12|(63&a)<<6|(63&u)<<0)}}return t},v=function(e){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return e;for(var t=new ArrayBuffer(3*e.length),n=new Uint8Array(t),r=0,i=e.length,o=0;o<i;o++){var s=e.charCodeAt(o);s>=1&&s<=127?n[r++]=s:s>2047?(n[r++]=224|s>>12&15,n[r++]=128|s>>6&63,n[r++]=128|s>>0&63):(n[r++]=192|s>>6&31,n[r++]=128|s>>0&63)}return n.subarray(0,r)},g=function(){
if(void 0!==o.current.platform&&o.current.platform.id===a.platforms.NRDP_TARGET.id&&"undefined"!=typeof nrdp&&void 0!==nrdp.device&&void 0!==nrdp.device.SDKVersion&&void 0!==nrdp.device.SDKVersion.components)return e("nf-bridge-adapter").versionInfo.isLessThan("2014.1")&&void 0!==nrdp.ntba.encrypt&&void 0!==nrdp.ntba.decrypt&&void 0!==nrdp.ntba.hmac;return!1},h=function(){var e=1;Object.defineProperties(this,{contexts:{enumerable:!0,writable:!1,value:{}},nextContextId:{enumerable:!0,get:function(){return e++}}})};h.prototype.processEncryptedMessage=function(e,t,n){var r,i,o=this,c=t.hmac,a=function(e){return s.Promise(function(t,n){if(e!==c)return n(new l(l.ERRORS.CRYPTO_ERROR,"HMAC validation failed"));t(e)})},f=function(e){return s.Promise(function(t,n){if(!e)return n(new l(l.ERRORS.CRYPTO_ERROR,"Decryption failed"));t(e)})};return delete t.hmac,r=n.newSubEvent(u.EVENTS.CANONICAL),i=d.canonicalForm(t),r.complete(),g()?s.Promise(function(n,r){var s=o.contexts[e];if(!s)return r(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));nrdp.mdx.ProcessSessionMessage(s.context,t.nonce,i,c,t.ciphertext,n)}).then(function(e){return a(e.hmac).then(function(){return f(e.plaintext)})}):s.Promise(function(s,c){r=n.newSubEvent(u.EVENTS.HMAC),o.hmac(e,i).finally(r.complete.bind(r)).then(a).then(function(){var r=n.newSubEvent(u.EVENTS.DECRYPT);return o.decrypt(e,t.ciphertext).finally(r.complete.bind(r)).then(f)}).done(s,c)})},h.prototype.processOutgoingSessionMsg=function(e,t,n){if(!t.plaintext)return s.reject(new l(l.ERRORS.CRYPTO_ERROR,"plaintext missing or empty"));var r,i,o=this,c=t.plaintext;return delete t.plaintext,g()?s.Promise(function(s,a){var f=o.contexts[e];if(!f)return a(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));t.ciphertext="ciphertext",r=n.newSubEvent(u.EVENTS.CANONICAL),i=d.canonicalForm(t),r.complete(),t.legacyMessageEncryption={securityContext:f.context,plaintext:c,canonicalMessage:i},s(t)}):s.Promise(function(s,a){r=n.newSubEvent(u.EVENTS.ENCRYPT),o.encrypt(e,c).finally(r.complete.bind(r)).then(function(s){if(!s)throw new l(l.ERRORS.CRYPTO_ERROR,"Encryption failed");return t.ciphertext=s,r=n.newSubEvent(u.EVENTS.CANONICAL),i=d.canonicalForm(t),r.complete(),r=n.newSubEvent(u.EVENTS.HMAC),o.hmac(e,i).finally(r.complete.bind(r))}).then(function(e){if(!e)throw new l(l.ERRORS.CRYPTO_ERROR,"HMAC signing failed");return t.hmac=e,t}).done(s,a)})};var E=function(){h.call(this);var e,t=this,n={},o=function(t){var r=nrdjs.mslClient,o=r.getMslStore(),c=o.getMasterToken(),a=o.getUserIdToken(nrdp.registration.currentDeviceAccount),u=i.encode,d="";if(e=o.getCryptoContext(c),!c||!a)return void t({success:!1,cTicket:d});try{d=["1",u(v(JSON.stringify(c.toJSON()))),u(v(JSON.stringify(a.toJSON())))].join(",")}catch(e){throw new l(l.ERRORS.CRYPTO_ERROR,JSON.stringify(e))}n.hmac=function(t){return s.Promise(function(n,r){e.sign(v(t),{result:function(e){if(e)return n(i.encode(e));r(new l(l.ERRORS.CRYPTO_ERROR,"msl hmac error"))},error:function(e){r(new l(l.ERRORS.CRYPTO_ERROR,JSON.stringify(e)))}})})},n.end=function(){},n.decrypt=function(t){return s.Promise(function(n,r){try{e.decrypt(v(i.decode(t)),{result:function(e){var t=p(e);n(t)},error:function(e){r(new l(l.ERRORS.CRYPTO_ERROR,e||"msl decrypt error"))}})}catch(e){r(new l(l.ERRORS.CRYPTO_ERROR,e||"msl decrypt exception"))}})},t({success:!0,cTicket:d,mslCryptoContext:n})};return this.getCTicket=function(){return s.Promise(function(e,t){o(function(n){if(n.success)return e(n.cTicket);t(new l(l.ERRORS.INVALID_CTICKET))})})},this.beginContext=function(e){return e?s.Promise(function(n,i){var o=t.nextContextId++,s={encrypt:t.encrypt.bind(t,o),decrypt:t.decrypt.bind(t,o),hmac:t.hmac.bind(t,o),end:t.endContext.bind(t,o),processEncryptedMessage:t.processEncryptedMessage.bind(t,o),processOutgoingSessionMsg:t.processOutgoingSessionMsg.bind(t,o)},c="string"==typeof e?e:r.decode(e);nrdp.mdx.beginContext(c,null,function(e){if(e&&e.context)return s.context=e.context,t.contexts[o]=s,n(s);i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"))})}):s.Promise(function(e,t){o(function(n){if(n.success)return e(n.mslCryptoContext);t(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"))})})},this.encrypt=function(e,n){return s.Promise(function(r,i){if(!n||n.length>32766)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid data to encrypt"));var o=t.contexts[e];if(!o||!o.context)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{nrdp.mdx.encrypt(o.context,n,function(e){return c.isString(e)?e?r(e):i(new l(l.ERRORS.CRYPTO_ERROR)):e&&e.encrypted?void r(e.data):i(new l(l.ERRORS.CRYPTO_ERROR))})}catch(e){return i(e)}})},this.decrypt=function(e,n){return s.Promise(function(r,i){var o=t.contexts[e];if(!o||!o.context)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));var s=o.context;try{nrdp.mdx.decrypt(s,n,r)}catch(e){return i(e)}})},this.hmac=function(e,n){return s.Promise(function(i,o){var s=t.contexts[e];if(!s||!s.context)return o(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));var c=s.context,a="string"==typeof n?r.encode(n):n;try{nrdp.mdx.hmac(c,a,function(e){if(e)return i(e);o(new l(l.ERRORS.CRYPTO_ERROR,"msl hmac error"))})}catch(e){o(e)}})},this.endContext=function(e){return delete t.contexts[e],s.resolve()},this};E.prototype=Object.create(h.prototype);var m=function(){h.call(this);var e=this;if(window.nfNewCrypto)f=window.nfNewCrypto;else{if(!window.crypto)throw new l(l.ERRORS.PLATFORM_SUPPORT_ERROR,"Failed to create Cast Target security provider. No crypto provider");f=window.crypto}return this.getCTicket=function(){throw new l(l.ERRORS.NOT_SUPPORTED)},this.beginContext=function(t){var n=i.decode(t);if(48!==n.length)return s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid shared secret"));var r,o;return s.Promise(function(t,i){f.subtle.importKey("raw",n.subarray(32),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(e){if(!e)throw new Error("Import crypto keys failed");return r=e,f.subtle.importKey("raw",n.subarray(0,32),{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"])}).then(function(t){if(!t)throw new Error("Import hmac keys failed");o=t;var n=e.nextContextId;return e.contexts[n]={hmacKey:o,encryptionKey:r},{encrypt:e.encrypt.bind(e,n),decrypt:e.decrypt.bind(e,n),hmac:e.hmac.bind(e,n),end:e.endContext.bind(e,n),processEncryptedMessage:e.processEncryptedMessage.bind(e,n),processOutgoingSessionMsg:e.processOutgoingSessionMsg.bind(e,n)}}).catch(function(e){throw e=e||new Error("Unknown failure")}).then(t,i)})},this.encrypt=function(t,n){if(!n||n.length>32766)return s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid data to encrypt"));var r=e.contexts[t];return r&&r.encryptionKey?s.Promise(function(e,t){var o=f.getRandomValues(new Uint8Array(16));f.subtle.encrypt({name:"AES-CBC",iv:o},r.encryptionKey,v(n)).then(function(e){if(!e||e.byteLength>32767)throw new Error("Encryption failure"+JSON.stringify(e));var t=new Uint8Array(e),n=new Uint8Array(18+function(e){return e<=127?1:e<=32767?2:-1}(t.length)+t.length);n[0]=2;var r=1,s=function(e){var t=e.length;if(t<=127)n[r++]=t;else{if(!(t<=32767))return!1;n[r++]=128|t>>8,n[r++]=255&t}return n.set(e,r),r+=t,!0};if(!s(o)||!s(t))throw new Error("Octet write failure");return i.encode(n)}).catch(function(e){throw e=e||new Error("Unknown failure")}).then(e,t)}):s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"))},this.decrypt=function(t,n){var r=e.contexts[t];if(!r||!r.encryptionKey)return s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));if(!c.isString(n)||n.length>43717)return s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid decryption data"));if(n=i.decode(n),n.size<35||2!==n[0]||16!==n[1])return s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid decryption data"));var o,a=18;if(n[a]<=127)o=n[a],++a;else{if(n.size<a+1)return s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid decryption data"));o=(127&n[a])<<8|255&n[a+1],a+=2}return o%16?s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid ciphertext length "+o+" not multiple of 16")):o+a!==n.length?s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Unexpected Ciphertext Length "+o+" "+n.length+", Not Aligned With the End Of Envelope")):s.Promise(function(e,t){f.subtle.decrypt({name:"AES-CBC",iv:n.subarray(2,18)},r.encryptionKey,n.subarray(a)).then(function(e){if(!e||e.byteLength>32767)throw new Error("Decryption error - payload too large");return p(e)}).catch(function(e){throw e=e||new Error("Unknown failure")}).then(e,t)})},this.hmac=function(t,n){var o=e.contexts[t];return o&&o.encryptionKey?s.Promise(function(e,t){return f.subtle.sign({name:"HMAC",hash:{name:"SHA-256"}},o.hmacKey,r.encode(n)).then(function(e){if(!e||e.byteLength>32767)throw new Error("Invalid result",e?e.byteLength:-1);return i.encode(new Uint8Array(e))}).catch(function(e){throw e=e||new Error("Unknown failure")}).then(e,t)}):s.reject(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"))},this.endContext=function(t){return delete e.contexts[t],s.resolve()},this};m.prototype=Object.create(h.prototype);var y=function(){if(!f)throw new l(l.ERRORS.PLATFORM_SUPPORT_ERROR,"No crypto provider provided during start");h.call(this);var e=this;return this.getCTicket=function(){return s.Promise(function(e,t){try{f.createCryptoContext(function(t){if(t.success&&t.cryptoContext)return e(t.cryptoContext.cTicket);throw new l(l.ERRORS.INVALID_CTICKET)})}catch(e){return t(e)}})},this.beginContext=function(t){return s.Promise(function(n,r){(t?f.createCryptoContextFromSharedSecret.bind(null,t):f.createCryptoContext)(function(t){if(t.success&&t.cryptoContext){var i=e.nextContextId++,o={encrypt:e.encrypt.bind(e,i),decrypt:e.decrypt.bind(e,i),hmac:e.hmac.bind(e,i),end:e.endContext.bind(e,i),processEncryptedMessage:e.processEncryptedMessage.bind(e,i),processOutgoingSessionMsg:e.processOutgoingSessionMsg.bind(e,i)};e.contexts[i]=t.cryptoContext,n(o)}r(new l(l.ERROR.CRYPTO_ERROR,"Invalid security context"))})})},this.encrypt=function(t,n){return s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.encrypt(n,function(e){if(e.success)return r(e.encryptedDataAsn1Base64||e.mslEncryptionEnvelopeBase64);i(new l(l.ERRORS.CRYPTO_ERROR,"Encryption failed"))})}catch(e){i(e)}})},this.decrypt=function(t,n){return s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.decrypt(n,function(e){if(e.success)return r(e.text);i(new l(l.ERRORS.CRYPTO_ERROR,"Decryption failed"))})}catch(e){i(e)}})},this.hmac=function(t,n){return s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.hmac(n,function(e){if(e.success)return r(e.hmacBase64);i(new l(l.ERRORS.CRYPTO_ERROR,"HMAC failed"))})}catch(e){i(e)}})},this.endContext=function(t){return delete e.contexts[t],s.resolve()},this};y.prototype=Object.create(h.prototype);var R=function(){h.call(this);var e=this;return this.getCTicket=function(){return s.Promise(function(e,t){try{nrdp.ntba.getCticket(function(t){e(t.cticket)})}catch(e){return t(e)}})},this.beginContext=function(t){return s.Promise(function(n,r){var i,o=e.nextContextId++,s={encrypt:e.encrypt.bind(e,o),decrypt:e.decrypt.bind(e,o),hmac:e.hmac.bind(e,o),end:e.endContext.bind(e,o),processEncryptedMessage:e.processEncryptedMessage.bind(e,o),processOutgoingSessionMsg:e.processOutgoingSessionMsg.bind(e,o)};try{if(t){var a=c.isString(t)?t:p(t);nrdp.mdx.beginContext(a,null,function(t){i={context:t.context,scope:nrdp.mdx,encryptImpl:nrdp.mdx.encrypt,decryptImpl:nrdp.mdx.decrypt,hmacImpl:nrdp.mdx.hmac,endImpl:nrdp.mdx.endContext},e.contexts[o]=i,n(s)})}else nrdp.ntba.beginTransaction(nrdp.registration.currentDeviceAccount,"read",function(t){i={context:t,scope:nrdp.ntba,encryptImpl:nrdp.ntba.encrypt,decryptImpl:nrdp.ntba.decrypt,hmacImpl:nrdp.ntba.hmac,endImpl:nrdp.ntba.endTransaction},e.contexts[o]=i,n(s)})}catch(e){r(e)}})},this.encrypt=function(t,n){return g()?s.resolve():s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.encryptImpl.call(o.scope,o.context,n,function(e){if(c.isString(e)){if(!e)return i(new l(l.ERRORS.CRYPTO_ERROR));r(e)}else{if(!e.encrypted)return i(new l(l.ERRORS.CRYPTO_ERROR));r(e.data)}})}catch(e){i(e)}})},this.decrypt=function(t,n){return g()?s.resolve():s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.decryptImpl.call(o.scope,o.context,n,r)}catch(e){i(e)}})},this.hmac=function(t,n){return g()?s.resolve():s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.hmacImpl.call(o.scope,o.context,n,r)}catch(e){i(e)}})},this.endContext=function(t){return s.Promise(function(n,r){var i=e.contexts[t];if(!i)return n();try{i.endImpl.call(i.scope,i.context,n)}catch(e){r(e)}}).then(function(){delete e.contexts[t]})},this};R.prototype=Object.create(h.prototype);var S=function(){h.call(this);var e=this,t=function(e){var t=i.encode,n="";nrdp.crypto.createCryptoContext(function(r){if(!r||!r.success)return void e({success:!1,cTicket:n});var i=r.cryptoContext;n=["1",t(v(i.masterToken)),t(v(i.userIdToken))].join(","),e({success:!0,cTicket:n,context:i})})};return this.getCTicket=function(){return s.Promise(function(e,n){t(function(t){if(t.success)return e(t.cTicket);n(new l(l.ERRORS.INVALID_CTICKET))})})},this.beginContext=function(t){return s.Promise(function(n,r){var i=e.nextContextId++,o={encrypt:e.encrypt.bind(e,i),decrypt:e.decrypt.bind(e,i),hmac:e.hmac.bind(e,i),end:e.endContext.bind(e,i),processEncryptedMessage:e.processEncryptedMessage.bind(e,i),processOutgoingSessionMsg:e.processOutgoingSessionMsg.bind(e,i)},s=function(t){if(!t||!t.success)return void n(null);var r=t.cryptoContext,s={encrypt:r.encrypt,decrypt:r.decrypt,hmac:r.hmac,end:r.end,context:r};e.contexts[i]=s,n(o)};try{if(t){var a=c.isString(t)?t:p(t);nrdp.crypto.createCryptoContextFromSharedSecret(a,s)}else nrdp.crypto.createCryptoContext(s)}catch(e){r(e)}})},this.encrypt=function(t,n){return s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.encrypt.call(o.context,n,function(e){if(e&&e.success)return r(e.encryptedDataAsn1Base64||e.mslEncryptionEnvelopeBase64);i(new l(l.ERRORS.CRYPTO_ERROR,"Encryption failed"))})}catch(e){i(e)}})},this.decrypt=function(t,n){return s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.decrypt.call(o.context,n,function(e){if(e&&e.success)return r(e.text);i(new l(l.ERRORS.CRYPTO_ERROR,"Decryption failed"))})}catch(e){return i(e)}})},this.hmac=function(t,n){return s.Promise(function(r,i){var o=e.contexts[t];if(!o)return i(new l(l.ERRORS.CRYPTO_ERROR,"Invalid security context"));try{o.hmac.call(o.context,n,function(e){if(e&&e.success)return r(e.hmacBase64);i(new l(l.ERRORS.CRYPTO_ERROR,"HMAC failed"))})}catch(e){return i(e)}})},this.endContext=function(t){return delete e.contexts[t],s.resolve()},this};S.prototype=Object.create(h.prototype);var I,T,A,O,N,C=function(){return g()?A||(A=new R):O||(O=new E)},b=function(){return I||(I=new m)},j=function(){return T||(T=new y)},D=function(){return o.current.argoMSLEnabled?N||(N=new S):A||(A=new R)},_={2:C,3:b,4:j,5:j,6:C,8:D};t.exports={get platformCrypto(){return f},set platformCrypto(e){f=e},createSecurityProvider:function(t){o=o||e("../configuration.js"),i=i||o.current.base64,r=r||o.current.utf8;var n=_[t.id];if(n)return n();throw new l(l.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot create security provider for platform: "+t.name)}}},{"../../builds/ld.js":1,"../configuration.js":39,"../enums.js":65,"../mdxError.js":76,"../profiling/mdxProfiler.js":77,"./validation.js":98,"nf-bridge-adapter":3,q:37}],98:[function(e,t,n){var r=e("../../builds/ld.js"),i=e("../logging/logger.js"),o=function(e){return null!==/^(?:[0-9])+.(?:[0-9])+$/.exec(e)},s=function(e){return null!==/^-?\d{1,}$/.exec(e)},c=function(e){var t=/^(https?|wss?|cast?):\/\/(.*\@.*)?([a-z0-9]+[a-z0-9\.]*|\[[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\])(\:([^$\/]+))?(\/[a-z0-9\/\.\_\-\~\%]*)?(\#.*)?(\?.*)?/i,n=/\.\.+/,r=t.exec(e)||[],i=r[1],o=r[2],s=r[3],c=r[4],a=r[5],u=r[6],d=r[7],l=r[8],f=!c||isFinite(a);return i&&!o&&s&&f&&!d&&!l&&!n.test(u)},a=function(e){return!/[^\ -~]/.test(e)},u=function(e){return!/[^A-Za-z0-9\+\/\=]/.test(e)},d=function(e){return!/[^A-Za-z0-9\+\/\=,]/.test(e)},l={pairingrequest:{fields:{action:a,version:o,nonce:s,controllerurl:c,controlleruuid:a,pairdatahmac:u,cticket:d},isResponse:!1},pairingresponse:{fields:{action:a,version:o,nonce:s,controllersharedsecret:a,targetuuid:a,targetuserid:a,controlleruuid:a,controlleruserid:a,grantdatahmac:u},isResponse:!0},regpairrequest:{fields:{action:a,nonce:s,pin:u,cticket:d,hmac:u,version:o,controlleruuid:a,controllerurl:c,pairdatahmac:{optional:!0,validator:u}},isResponse:!1},regpairreply:{fields:{action:a,nonce:s,userid:a,controllersharedsecret:a,grantdatahmac:u,version:o,targetuuid:a},isResponse:!0},regpairerror:{fields:{action:a,nonce:s,version:o,targetuuid:a,errorcode:a,errorstring:a},isResponse:!0},pairingresponseError:{fields:{action:a,version:o,nonce:s,targetuuid:a,targetuserid:a,errorcode:a,errorstring:a},isResponse:!0},session:{fields:{action:a,version:o,nonce:s,fromurl:c,fromuuid:a,fromuserid:a,touuid:a,touserid:a,hmac:u,plaintext:{optional:!0,validator:a},ciphertext:{optional:!0,validator:u}},isResponse:!1},pingsearch:{fields:{action:a,fromuuid:a,fromurl:c,servicetype:a,id:a},isResponse:!1},pingresponse:{fields:{action:a,friendlyname:u,fromurl:c,fromuuid:a,responseheaders:a,servicetype:a,touuid:a,id:a},isResponse:!0},error:{fields:{action:a,nonce:s,fromuuid:a,touuid:a,errorcode:a,errorstring:a},isResponse:!0},broadcast:{fields:{action:a,nonce:s,fromuuid:a,fromurl:c,messageType:a,payload:{optional:!0,validator:a}},isResponse:!1}},f=function e(t,n,i){var o,s;r.isString(n)?(o=n.indexOf("."),s=n.indexOf("[")):(o=-1,s=-1);var c;if(o>=0&&(s<0||o<s))return o>0?(c=n.substring(0,o),t.hasOwnProperty(c)||(t[c]={}),t[c]=e(t[c],n.slice(o+1),i),t):(t||(t={}),t=e(t,n.slice(o+1),i));if(!(s>0))return n&&(t[n]=i),t;var a=n.indexOf("]");if(a>0){c=n.substring(0,s);var u=parseInt(n.substr(s+1,a-1),10);if(t.hasOwnProperty(c)||(t[c]=[]),!isNaN(u)){var d=n.slice(a+1);""!==d?t[c][u]=e(t[c][u],d,i):t[c]=e(t[c],u.toString(),i)}return t}return null},p=function(e){return r.reduce(r.map(e.split("\r\n"),function(e){var t=e.indexOf("=");return-1===t?null:[e.substr(0,t),e.substr(t+1)]}),function(e,t){return t?f(e,t[0],t[1]):e},{})},v=function(e){if(!e)return i.warn("No message payload to parse and validate"),null;var t=p(e),n=r.zipObject(r.map(t,function(e,t){return[t,!0]})),o=t.action;if("pairingresponse"===o&&(t.hasOwnProperty("errorstring")||t.hasOwnProperty("errorcode"))&&(t.action=o="pairingresponseError"),!l[o])return i.warn("Unknown command received. Messge dropped",e),null;var s=r.findKey(l[o].fields,function(i,o){if(!t.hasOwnProperty(o)&&!i.optional)return!0;var s=t[o];delete n[o];var c;if(r.isFunction(i))c=i(s);else{c=e.hasOwnProperty(o)?i.validator(s):i.optional}return!c});return s?(i.warn("Message failed validation due to invalid field or missing field: "+s,e),null):r.isEqual(n,{})?t:(i.warn("Message failed validation due to unexpected fields",r.keys(n)),null)},g=function e(t,n,i){var o,s,c,a=!1;return r.isArray(t)?(i<5&&(r.forEach(t,function(t,r){o=n?[n,"[",r,"]"].join(""):r,s=e(t,o,i+1),c=[c,s].join(""),a=!0}),a||(c=n?[n,"[]=","\r\n"].join(""):null)),c):r.isNull(t)||"object"!=typeof t?[n,"=",t,"\r\n"].join(""):(i<5&&(r.forEach(t,function(t,r){o=n?[n,r].join("."):r,s=e(t,o,i+1),c=[c,s].join(""),a=!0}),a||(c=n?[n,".=","\r\n"].join(""):null)),c)},h=function(e){return g(e,null,0)},E=function(e){var t=r.map(e,function(e,t){return t+"="+encodeURIComponent(e)});return r.sortBy(t,function(e){return e}).join("&")};t.exports={parsePairedPayload:p,parseAndValidateMsg:v,processOutgoingMessage:h,canonicalForm:E},t.exports.versionValidator=o,t.exports.numberValidator=s,t.exports.urlValidator=c,t.exports.asciiValidator=a,t.exports.base64Validator=u,t.exports.cticketValidator=d},{"../../builds/ld.js":1,"../logging/logger.js":70}],99:[function(e,t,n){var r,i=e("q"),o=e("../builds/ld.js"),s=(e("./logging/logger.js"),e("./mdxError.js")),c=function(){};c.prototype.setMdxId=function(e){return this.setItem("MDX_USERID",e||"")},c.prototype.getMdxId=function(){return this.getItem("MDX_USERID")},c.prototype.setProfileId=function(e){return this.setItem("MDX_PROFILEID",e||"")},c.prototype.getProfileId=function(){return this.getItem("MDX_PROFILEID")},c.prototype.storeDeviceMap=function(e){var t=i.defer(),n=this;return n.retrieveDeviceMapData().done(function(r){try{o.isPlainObject(r)||(r={});var i=o.map(e,function(e){return e.getPersistentData()});o.forEach(i,function(e){e&&e.id&&(r[e.id]?o.forEach(e,function(t,n){o.isUndefined(t)||(r[e.id][n]=t)}):r[e.id]=e)}),r=o.reduce(o.take(o.sortBy(r,function(e){return-e.lastSeen}),32),function(e,t){return e[t.id]=t,e},{}),n.setItem("MDX_REMOTE_DEVICE_MAP",JSON.stringify(r)).done(t.resolve,t.reject)}catch(e){t.resolve()}},t.reject),t.promise},c.prototype.clearPairings=function(){var e=i.defer(),t=this;return t.retrieveDeviceMapData().done(function(n){try{o.isPlainObject(n)||(n={}),o.forEach(n,function(e){e.sharedSecret=null,e.currentMdxId=null}),t.setItem("MDX_REMOTE_DEVICE_MAP",JSON.stringify(n)).done(e.resolve,e.reject)}catch(t){e.reject()}},e.reject),e.promise},c.prototype.retrieveDeviceMapData=function(){var e=i.defer();try{this.getItem("MDX_REMOTE_DEVICE_MAP").done(function(t){var n=t?JSON.parse(t):{};e.resolve(n)},function(){e.resolve({})})}catch(e){return i.resolve({})}return e.promise},c.prototype.reset=function(){var e=this;return e.setItem("MDX_REMOTE_DEVICE_MAP",JSON.stringify({})).then(e.setMdxId).then(e.setProfileId)};var a=function(){c.call(this);var t=o.isUndefined(localStorage)?null:localStorage;r||(r=e("./configuration.js")),this.setItem=function(e,n){if(e){var o={id:r.current.profileId,data:n},s=o?JSON.stringify(o):"";t[e]=s}return i.resolve()},this.getItem=function(e){try{if(e){var n=t[e];if(n){var o=JSON.parse(n);return i.resolve(o.id===r.current.profileId?o.data:null)}}return i.resolve(null)}catch(e){return i.resolve(null)}}};a.prototype=Object.create(c.prototype);var u=function(){this.setItem=function(e,t){try{var n=nrdp.registration.currentDeviceAccount;if(n){var r=nrdp.storage.setItem(n,e,t);return i.resolve(r)}return i.resolve()}catch(e){return i.resolve()}},this.getItem=function(e){try{var t=nrdp.registration.currentDeviceAccount;if(t){var n=nrdp.storage.getItem(t,e);return i.resolve(n)}return i.resolve(null)}catch(e){return i.resolve(null)}}};u.prototype=Object.create(c.prototype);var d=function(){var e=function(){var e=i.defer();return WinJS.Application.local.readText("mdxdata.txt").done(function(t){var n=JSON.parse(t);n.id!==nrdp.registration.currentDeviceAccount&&(n={id:nrdp.registration.currentDeviceAccount,data:null}),e.resolve(n.data)},e.resolve(null)),e.promise};this.setItem=function(t,n){var r=i.defer();try{e.done(function(e){e.data[t]=n,WinJS.Application.local.writeText("mdxdata.txt",JSON.stringify(e)).done(r.resolve,r.reject)},r.reject)}catch(e){return i.reject(e)}return r.promise},this.getItem=function(t){var n=i.defer();try{e.done(function(e){n.resolve(e.data[t])},n.reject)}catch(e){return i.resolve(null)}return n.promise}};d.prototype=Object.create(c.prototype);var l,f,p,v=function(){return l||(l=new a)},g=function(){return f||(f=new u)},h=function(){return p||(p=new d)},E={2:g,3:g,4:v,5:h,6:g,8:g};t.exports={createStorageProvider:function(e){var t=E[e.id];if(t)return t();throw new s(s.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot create storage provider for platform: "+e.name)}}},{"../builds/ld.js":1,"./configuration.js":39,"./logging/logger.js":70,"./mdxError.js":76,q:37}],100:[function(e,t,n){var r=function(e){};t.exports=r},{}],101:[function(e,t,n){t.exports={}},{"../discovery/discoveryComponent.js":59,"../test/mockMdxTarget.js":102,q:37}],102:[function(e,t,n){var r=e("../test/mockMdxTarget.js"),i=e("./mockTargetSession.js"),o=function(e,t){var n=this;return r.call(n,e,t,i),n};o.prototype=Object.create(r.prototype),t.exports=o},{"../test/mockMdxTarget.js":102,"./mockTargetSession.js":103}],103:[function(e,t,n){var r=e("../session/mdxTargetSession.js"),i=e("../versionInfo.js"),o=function(){return r.call(this,new i),this};o.prototype=Object.create(r.prototype),t.exports=o},{"../session/mdxTargetSession.js":91,"../versionInfo.js":106}],104:[function(e,t,n){},{"../../builds/ld.js":1,"../configuration.js":39,"../discovery/discoveryConfig.js":60,"../enums.js":65,"../logging/consoleLogSink.js":69,"../logging/logger.js":70,"../mdxError.js":76,"./webSocketTestChannel.js":105}],105:[function(e,t,n){},{"../../builds/ld.js":1,"../enums.js":65,"../logging/bufferedWebSocketLogSink.js":68,"../logging/logger.js":70,"../mdxError.js":76,"../schedulerFactory.js":80,"../webSocketFactory.js":107}],106:[function(e,t,n){var r=e("../builds/ld.js"),i=/^([0-9]+)(?:\.([0-9]+))?(?:\.([0-9]+))?(?:-([\w\.]+))*$/,o=function(e){var t=0,n=0,o=0,s="";if(r.isString(e)){var c=i.exec(e);c&&(t=parseInt(c[1])||t,n=parseInt(c[2])||n,o=parseInt(c[3])||o,s=c[4]||s)}else r.isPlainObject(e)&&(t=e.major||0,n=e.minor||0,o=e.revision||0,s=e.build||"");return Object.defineProperties(this,{major:{enumerable:!0,value:t},minor:{enumerable:!0,value:n},revision:{enumerable:!0,value:o},build:{enumerable:!0,value:s}}),this};o.prototype.toString=function(){var e=this.major+"."+this.minor+"."+this.revision;return this.build&&(e=e+"-"+this.build),e},o.prototype.matches=function(e,t,n,i){var o=this;return o.major===e&&o.minor===t&&o.revision===n&&r.isUndefined(i)||o.build===i},o.prototype.isGreaterThan=function(e,t,n){var r=this;return r.major>e||r.major===e&&r.minor>t||r.major===e&&r.minor===t&&r.revision>n},o.prototype.isGreaterThanOrEqual=function(e,t,n){var r=this;return r.matches(e,t,n)||r.isGreaterThan(e,t,n)},t.exports=o},{"../builds/ld.js":1}],107:[function(e,t,n){var r=e("./mdxError.js"),i=function(e,t){try{return t?new window.WebSocket(e,"mdx"):new window.WebSocket(e)}catch(e){return}},o=function(e,t){try{return t?new nrdp.WebSocket(e,"mdx"):new nrdp.WebSocket(e)}catch(e){return}},s=function(e,t){var n,i=this,o=new Windows.Networking.Sockets.MessageWebSocket;o.control.messageType=Windows.Networking.Sockets.SocketMessageType.utf8,t&&o.control.supportedProtocols.append("mdx"),o.onmessagereceived=function(e){if(i.onmessage){var t=e.getDataReader();i.onmessage(t.readString(t.unconsumedBufferLength))}},o.onclosed=function(){i.onclosed&&i.onclosed.apply(null,arguments)},this.close=o.close,this.send=function(e){if(!n)throw new r(r.ERRORS.PLATFORM_SUPPORT_ERROR,"WinJS websocket write failure");return n.writeString(e),n.storeAsync()};var s=new Windows.Foundation.Uri(e);o.connectAsync(s).done(function(){n=new Windows.Storage.Streams.DataWriter(o.outputStream),i.onopen&&i.onopen()},function(e){i.onerror&&i.onerror(e)})},c=function(e,t){try{return new s(e,t)}catch(e){return}},a={2:o,3:i,4:i,5:c,6:o};t.exports={createWebSocket:function(e,t,n){if(!t)throw new r(r.ERRORS.INVALID_ARG,"Invalid url for createWebSocket");var i=a[e.id];if(i)return i(t,n);throw new r(r.ERRORS.PLATFORM_SUPPORT_ERROR,"Cannot create a websocket connection for platform: "+e.name)}}},{"./mdxError.js":76}]},{},[74]),t}()});C.r("b1",function(e,t,n){"use strict";var i=e("bo"),o=i(e("ts")),s=i(e("tc")),a=e("iS"),r=e("b2"),c=e("b8"),E=e("b0"),u=e("iz"),d=e("Dg").RxObservable,l=e("Dg").RxSubject,T=e("CH"),g=e("aS"),h=e("a-"),A=e("wr"),v=function(e){var t=e.playerApp,n=e.logger,i=e.videoSessionInstance,o=e.profileGuid,r=e.initParams,u=e.onConnectionStart,l=void 0===u?function(){}:u,T=e.onConnectionEnd,A=void 0===T?function(){}:T,v=e.startedCallback,p=s.default.get("wwwplayer.config.ui.mdx.log.level");this.mdxApi=new a(a.PLATFORMS.CADMIUM_CONTROLLER),this.initParams=r,this.logger=n,this.playerApp=t,this.profileGuid=o,this.heartbeatSubscription=void 0,this.mdxApi.addEventListener(a.EVENTS.MDX_DEVICES_AVAILABLE,this.onMdxDevicesAvailable.bind(this)),this.mdxApi.addEventListener(a.EVENTS.DEVICE_AVAILABLE,this.onDeviceAvailable.bind(this)),this.mdxApi.addEventListener(a.EVENTS.START_CONNECTING,this.onStartConnectingToDevice.bind(this)),this.mdxApi.addEventListener(a.EVENTS.START_DISCONNECTING,this.onStartDisconnectingDevice.bind(this)),this.onConnectionStart=l,this.onConnectionEnd=A,this.mdxApi.configure({logLevel:p&&a.LOG_LEVELS[p]||a.LOG_LEVELS.TRACE,profileId:o}),this.mdxConnectionLogging=new E(this.playerApp,this,r,this.mdxApi.config.version,d),this.mdxControlsComponent=h(g);var C=this;this.mdxApi.start({platformMdxLib:i.mdx}).done(function(){C.mdxInitTime=Date.now(),c("MDX initialization complete. Ready for communication."),v({success:!0})},function(e){c("MDX failed to start"),c(e),v({success:!1,error:e})})},p=function(e,t){e&&e.logEvent&&e.logEvent(o.default.DebugEvent,{mdx2Event:!0,data:t})};v.prototype={state:{deviceLaunchInFlight:!1,mdxDevicesFound:!1,currentTarget:null},targetDisposedObs:new l,getCurrentTarget:function(){return this.state.currentTarget},setCurrentTarget:function(e){var t=this,n=this.state.currentTarget;if(n&&(n.destroy(),this.targetDisposedObs.next()),this.heartbeatSubscription&&this.heartbeatSubscription.unsubscribe(),e){n=new r({device:e,initParams:this.initParams,playerApp:this.playerApp,profileGuid:this.profileGuid}),this.state.currentTarget=n,this.heartbeatSubscription=A(function(){return n&&!n.getPaused()},function(){t.playerApp.getActionCreators().receivePinTimestamp({ts:Date.now()})}).subscribe();var i=e.CONNECT_INTENTS.JOIN;this.state.deviceLaunchInFlight&&(this.state.deviceLaunchInFlight=!1,i=e.CONNECT_INTENTS.LAUNCH_AND_CONTROL),c("Attempting to connectToApp() to create an MDX session");var o=this;e.connectToApp(i).done(function(){c("MdxTarget.connectToApp success. Target is now usable!"),p(o.logger,{reason:"deviceConnectSuccess"}),o.emit(o.EVENTS.TARGET_CONNECTION_CHANGED,n,{usermismatch:!1}),o.onConnectionStart(),e.getPlayerState().done(function(){c("got player state")}),e.getAudioSubtitles().done(function(){c("getting audio subtitles")})},function(e){e.code===u.get(e,"ERRORS.USER_MISMATCH.code")?(c("MdxTarget.connectToApp success. Target is now usable!"),p(o.logger,{reason:"deviceConnectUserMismatch"}),n.state.connected=!0,o.emit(o.EVENTS.TARGET_CONNECTION_CHANGED,n,{usermismatch:!0}),o.onConnectionStart()):(c("MdxTarget.connectToApp failed."+e.message),p(o.logger,{reason:"deviceConnectError"}),o.emit(o.EVENTS.TARGET_CONNECTION_FAILED,e))}),d.fromEvent(e,e.EVENTS.NEW_APP_MESSAGE).takeUntil(this.targetDisposedObs).do(function(e){c("got new_app_message");var t=e.name,i=e.payload&&e.payload.currentState;t!==n.DEVICE_EVENTS.PLAYER_STATE_CHANGED&&t!==n.DEVICE_EVENTS.PLAYER_CURRENT_STATE||(u.includes(n.DEVICE_PLAY_STATES,i)?o.emit(o.EVENTS.TARGET_PLAYING,n):o.emit(o.EVENTS.TARGET_STOPPED,n))}).subscribe(u.noop),d.merge(d.fromEvent(e,e.EVENTS.APP_CONNECTION_ENDED),d.fromEvent(e,e.EVENTS.DISCOVERY_STATE_CHANGED)).takeUntil(this.targetDisposedObs).take(1).do(function(e){c("target connection ended message"),t.emit(o.EVENTS.TARGET_CONNECTION_CHANGED,null,{device:e.device}),t.setCurrentTarget(null),t.onConnectionEnd()}).subscribe(u.noop)}else this.state.currentTarget=null},onMdxDevicesAvailable:function(e){c("MDX Reported device availabitity as: "+(e.available?"AVAILABLE":"NOT_AVAILABLE")),this.state.mdxDevicesFound=e.available,this.emit(this.EVENTS.MDX_DEVICES_AVAILABLE,e.available)},onDeviceAvailable:function(e){if(c("MDX device available for communication."),!this.isSameDevice(e.device)){var t=this.launchSource();this.emit(this.EVENTS.NEW_DEVICE_AVAILABLE,e.device),this.setCurrentTarget(e.device),p(this.logger,{reason:"deviceAvailable",launchSource:t})}},onStartConnectingToDevice:function(){this.mdxConnectionLogging.logConnectEvent()},onStartDisconnectingDevice:function(){this.mdxConnectionLogging.logDisconnectEvent()},canAttemptToCast:function(){return this.state&&this.state.currentTarget},cast:function(e,t,n,i){var o=this.state.currentTarget;o&&o.cast(e,t,n,i)},requestMdxDevice:function(){var e=this;this.mdxApi.requestMdxDevice().done(function(t){e.state.deviceLaunchInFlight=!0,c("Device request success - "+t.id+" : "+t.friendlyName),p(e.logger,{reason:"deviceRequestSuccess",launchSource:"manual-launch"})},function(t){c("Device request error "+t.message),p(e.logger,{reason:"deviceRequestError",launchSource:"manual-launch"})})},isSameDevice:function(e){return u.get(this,"state.currentTarget.state.target.id",null)===e.id},configure:function(e){this.mdxApi.configure(e)},launchSource:function(){return this.state.deviceLaunchInFlight?"manual-launch":"auto-launch"},EVENTS:{MDX_DEVICES_AVAILABLE:"mdx-devices-available",TARGET_CONNECTION_CHANGED:"target-connection_changed",TARGET_CONNECTION_FAILED:"target-connection_failed",TARGET_PLAYING:"target-playing",TARGET_STOPPED:"target-stopped",NEW_DEVICE_AVAILABLE:"new-device-available",SHOW_EPISODES:"show-title-episodes"},getControlsComponentClass:function(){return this.mdxControlsComponent}},u.assign(v.prototype,T),t.exports=v});